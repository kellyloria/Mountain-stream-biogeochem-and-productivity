---
title: 'Figures and analysis for: Spatiotemporal variation in mountain stream metabolism and nitrogen cycling across contrasting flow regimes '
author: "Kelly Loria"
date: "`r Sys.Date()`"
output:
   html_document:
    theme: simplex
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style type="text/css">
body, td {font-size: 13px;}
code.r{font-size: 9px;}
pre {font-size: 11px}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = F, message = F)
knitr::opts_knit$set(root.dir = '/Users/kellyloria/Documents/Publications/')
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

```

```{r, echo = F, message = F, include=FALSE}
### Packages
#setwd("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/BWL_k600/")
lapply(c("plyr","dplyr","ggplot2","cowplot",
         "lubridate","tidyverse", "reshape2", "ggpubr", "ggpattern", "broom.mixed",
         "glmmTMB",
         "lme4", "lmerTest", "MuMIn", "PerformanceAnalytics", "car"), require, character.only=T)
```

## 

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
daoc_date<- Sys.Date()

lapply(c("plyr","dplyr","ggplot2","cowplot",
         "lubridate","tidyverse", "reshape2", "ggpubr", "ggpattern",
         "lme4", "lmerTest", "MuMIn", "PerformanceAnalytics", "car"), require, character.only=T)
site_colors <- c(
  "BWL" = "#054fb9",
  "BWU" = "#97b5c2",
  "GBL" = "#DD6E42",
  "GBU" = "#d9cb7c"
)

siteC_colors <- c(
  "BWL" = "#054fb9",
  "BWU" = "#054fb9",
  "GBL" = "#DD6E42",
  "GBU" = "#DD6E42"
)



catch_colors <- c(
  "BW" = "#054fb9",
  "GB" = "#DD6E42"
)


## Fxn for water year:
water_year <- function(data) {
  # Ensure the `date` column exists
  if (!"date" %in% names(data)) {
    stop("The dataframe must contain a column named 'date'.")
  }
  
  # Convert the `date` column to Date format (if not already)
  data$date <- as.Date(data$date)
  
  # Add the water_year column
  data$water_year <- with(data, {
    year <- as.numeric(format(date, "%Y"))
    month <- as.numeric(format(date, "%m"))
    ifelse(month >= 10, year + 1, year)
  })
  
  return(data)
}

# Define fill patterns for water years
water_year_patterns <- c("wave","weave","stripe","circle", "stripe", "circle")


# Create a sequence of dates
date_seq <- seq(from = as.Date("2021-03-20"), to = as.Date("2024-10-10"), by = "day")
```

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}

# Convert the sequence to a dataframe
date_df <- data.frame(date = date_seq)
date_df$site <- "BWL"
date_df$catch <- "BW"
date_df1 <- data.frame(date = date_seq)
date_df1$site <- "GBL"
date_df1$catch <- "GB"
date_df2 <- data.frame(date = date_seq)
date_df2$site <- "GBU"
date_df2$catch <- "GB"
date_df3 <- data.frame(date = date_seq)
date_df3$site <- "BWU"
date_df3$catch <- "BW"

date_datf <- rbind(date_df,date_df1,date_df2, date_df3)

# ## Fxn for water year:
# water_year <- function(data) {
#   # Ensure the `date` column exists
#   if (!"date" %in% names(data)) {
#     stop("The dataframe must contain a column named 'date'.")
#   }
#   
#   # Convert the `date` column to Date format (if not already)
#   data$date <- as.Date(data$date)
#   
#   # Add the water_year column
#   data$water_year <- with(data, {
#     year <- as.numeric(format(date, "%Y"))
#     month <- as.numeric(format(date, "%m"))
#     ifelse(month >= 10, year + 1, year)
#   })
#   
#   return(data)
# }
# ## Function to perform ANOVA and post-hoc test within each site
# comparisons <- list(
#   c("2021", "2022"),
#   c("2021", "2023"),
#   c("2022", "2023"),
#   c("2023", "2024")
# )
# ```
# 
# ```{r, warning=F, size = 'small', echo=FALSE, include=F}
# ##==========================
# library(dataRetrieval)
# ## Bring in Streamflow
# siteNo_BW <- "10336660"
# 
# # Define the parameter codes for flow and stage
# pCode_flow <- "00060"
# pCode_stage <- "00065"
# pCode_temp <- "00010"
# 
# # Set the start date to "1980-01-01" and end date to today (current date)
# start.date <- "2021-04-20"
# end.date <- "2024-08-10"
# 
# HRflow_data_BW <- readNWISuv(
#   siteNumbers = siteNo_BW,
#   parameterCd = c(pCode_temp, pCode_flow, pCode_stage),
#   startDate = start.date,
#   endDate = end.date
# ) %>%
#   select(
#     datetime = "dateTime",
#     dischargeCFS = "X_00060_00000",
#     wtr_USGS = "X_.AquaTroll._00010_00000",
#     stageF = "X_00065_00000"
#   ) %>%
#   mutate(datetime = as.POSIXct(datetime, tz = "UTC") %>% 
#            with_tz("America/Los_Angeles")) # Convert to Pacific Time
# 
# ### mutate for SI units: 
# HRflow_BWL <- HRflow_data_BW %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/29.00787),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 0.647),
#     adjusted_depth =  c(stage_m * 0.233),
#     site="BWL"
#   ) 
# 
# HRflow_BWU <- HRflow_data_BW %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/29.00787),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 0.444),
#     adjusted_depth =  c(stage_m * 0.503),
#     site="BWU") 
# 
# 
# # depth slope 0.233
# 
# 
# ##==========================
# ## Bring in Streamflow
# siteNo_GB <- "10336730" #siteNo_BW <- "10336660"
# 
# # Define the parameter codes for flow and stage
# pCode_flow <- "00060"
# pCode_stage <- "00065"
# pCode_temp <-"00010"
# 
# 
# # Set the start date to "1980-01-01" and end date to today (current date)
# start.date <- "2021-03-11"
# end.date <- "2024-10-16"
# 
# HRflow_data_GB <- readNWISuv(
#   siteNumbers = siteNo_GB,
#   parameterCd = c(pCode_temp, pCode_flow, pCode_stage),
#   startDate = start.date,
#   endDate = end.date
# ) %>%
#   select(
#     datetime = "dateTime",
#     dischargeCFS = "X_00060_00000",
#     wtr_USGS = "X_00010_00000",
#     stageF = "X_00065_00000"
#   ) %>%
#   mutate(datetime = as.POSIXct(datetime, tz = "UTC") %>% 
#            with_tz("America/Los_Angeles")) # Convert to Pacific Time
# 
# ### mutate for SI units: 
# HRflow_GBL <- HRflow_data_GB %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/10.64485),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 0.812),
#     adjusted_depth =  c(stage_m * 0.979),
#      site="GBL") 
# 
# 
# ### mutate for SI units: 
# HRflow_GBU <- HRflow_data_GB %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/10.64485),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 1.104),
#     adjusted_depth =  c(stage_m * 0.357),
#      site="GBU") 
# 
# Flow_df <- rbind(HRflow_BWL, HRflow_BWU, HRflow_GBL, HRflow_GBU)
# 
# flow_df<- Flow_df %>%
#   mutate(date= as.Date(datetime))%>%
#   group_by(site, date) %>%
#   dplyr::select(!datetime)%>%
#   summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop") %>%
#   mutate(Q_m = adjusted_dischargeCMS,
#          depth_m = adjusted_depth)%>%
#   dplyr::select(site, date, Q_m, depth_m)
# 
# summary(flow_df)


# saveRDS(flow_df, file = "/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_flow_df.rds")

```

```{r, warning=F, size = 'small', echo=FALSE, include=F}
### Read in all data
####
date_datf <- water_year(date_datf)

covariat_dat <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_covariate_dat_AFDM.rds") %>%
  dplyr::select("date", "Site","bulk.density","AFDM_mgg","AFDM_mgcm2", "Chla_ugL_Q", "Pheo_ugL_Q")
summary(covariat_dat)

covariat_dat <- date_datf %>%
  left_join(covariat_dat, by=c("date", "site"="Site"))

flow_df <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_flow_df.rds")

covariat_dat <- covariat_dat %>%
    left_join(flow_df, by=c("date", "site"))


bg_nuts <- readRDS("/Users/kellyloria/Documents/LittoralMetabModeling/RawData/WaterChem/NS_chem_dat_nh4_24.rds") %>%
  filter(location=="stream") %>%
    mutate(NO3_mgL_dl = if_else(NO3_mgL_dl < 0.0015, 0.0015, NO3_mgL_dl))%>%
    mutate(NH4_mgL_dl=if_else(NH4_mgL_dl < 0.001, 0.001, NH4_mgL_dl))%>%
    mutate(PO4_ugL_dl=if_else(PO4_ugL_dl < 0.201, 0.201, PO4_ugL_dl)) %>%
  mutate(PO4_ugL_dl=if_else(DOC_mgL_dl < 0.25, 0.125, DOC_mgL_dl)) %>%
  group_by(site, shore, date, depth, location, substrate) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")


##### pivot wider 
bg_nuts_wide <- bg_nuts %>%
  dplyr::select(site, date, substrate, NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill) %>%
  group_by(site, date,substrate) %>% 
  summarise(across(c(NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill), mean, na.rm = TRUE), .groups = "drop") %>% 
  pivot_wider(names_from = substrate, values_from = c(NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill), names_sep = "_")

######


WQ_dat <- read.csv("/Users/kellyloria/Documents/LittoralMetabModeling/RawData/WaterChem/Stream_Lake_YSI_WaterQuality.csv")%>%
  mutate(date = as.Date(date, format="%m/%d/%y")) %>%
  dplyr::select("site", "date","pH") %>%
  dplyr:: group_by(site, date) %>%
  dplyr::summarise(pH=mean(pH, na.rm=T))

covariat_datq <- covariat_dat%>%
  left_join(bg_nuts_wide[ , c("site", "date", "NO3_mgL_dl_sw", "NO3_mgL_dl_pw", "NH4_mgL_dl_sw", 
                              "NH4_mgL_dl_pw", "PO4_ugL_dl_sw","PO4_ugL_dl_pw", "DOC_mgL_dl_sw",
                              "DOC_mgL_dl_pw", "pH_infill_sw",  "pH_infill_pw")], by=c("date", "site"))

covariat_datq <- covariat_datq%>%
  left_join(WQ_dat,  by=c("date", "site"))


## bring in SPC data 
### missing 2024 BW SPC
SPC_BWL <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_BWL_SPCv2.rds") %>%
  filter(datetime>as.POSIXct("2021-04-29 24:00:00"))
SPC_BWL$site <- "BWL"
SPC_BWU <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_BWU_SPCv2.rds")
SPC_BWU$site <- "BWU"
SPC_GBL <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_GBL_SPCv2.rds")
SPC_GBL$site <- "GBL"
SPC_GBU <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_GBU_SPCv2.rds")
SPC_GBU$site <- "GBU"

SPC_dat <- rbind(SPC_BWL, SPC_BWU, SPC_GBL, SPC_GBU)
SPC_dat <- SPC_dat %>%
  mutate(date =as.Date(datetime)) 

SPC_dat_day <- SPC_dat %>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    wt= mean(wtr, na.rm=T),
    wt_sd= sd(wtr, na.rm=T),
    SPC_m=mean(SPC, na.rm=T),
    SPC_sd=sd(SPC, na.rm=T))

#hist(SPC_dat_day$wt_sd)
#hist(SPC_dat_day$SPC_sd)

SPC_datD <- SPC_dat_day %>%
  filter(wt_sd<4.1 & SPC_sd <35)
  
#hist(SPC_datD$wt_sd)
#hist(SPC_datD$SPC_sd)
  
covariat_datq <- covariat_datq%>%
  left_join(SPC_datD, by=c("date", "site"))

### 
## Bring in morph data : 
morph_df <- read.csv("/Users/kellyloria/Documents/UNR/MSMmetab/stream_morphology_core.csv")%>%
  filter(quality =="trust") %>%
    mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%dT%H:%M:%SZ"),
           date=as.Date(datetime)) %>%
  rename(site="Site")


Morph_dat_day <- morph_df%>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    v_m=mean(v_estimation, na.rm=T),
    w_m=mean(w, na.rm=T),
    depth_measure=mean(z, na.rm=T))


covariat_datq <- covariat_datq%>%
  left_join(Morph_dat_day, by=c("date", "site"))

#### DO ###
## BWL  
BWL_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_BWL_mod_dat.rds") %>%
  mutate(site="BWL")
summary(BWL_dat) 

## BWU 
BWU_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/BWU_k600/25_BWU_mod_dat.rds") %>%
  mutate(site="BWU")
summary(BWU_dat)

## GBL 
GBL_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_GBL_mod_dat.rds") %>%
  mutate(site="GBL")
summary(GBL_dat)

## GBU 
GBU_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_GBU_mod_dat.rds") %>%
  mutate(site="GBU")
summary(GBU_dat)


miniDOT_dat <- rbind(BWL_dat, BWU_dat, GBL_dat, GBU_dat)
miniDOT_dat_day <- miniDOT_dat%>%
  mutate(date =as.Date(solar.time))%>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    do.obs_m=mean(DO.obs, na.rm=T),
    do.obs_sd=sd(DO.obs, na.rm=T),
    wtr_m=mean(temp.water, na.rm=T),
    wtr_sd=sd(temp.water, na.rm=T))

covariat_datq <- covariat_datq%>%
  left_join(miniDOT_dat_day, by=c("date", "site"))

### N-uptake metrics
n_up <- read.csv("/Users/kellyloria/Documents/UNR/Ncycle/BTC_N_Table_2025_figure.csv")%>%
  mutate(date = as.Date(date, format="%m/%d/%y")) 

covariat_datq <- covariat_datq%>%
  left_join(n_up, by=c("date", "site"))

##================================
## Load metabolism model data
##================================
BWL_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/BWL_Full_2025-02-06_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>% 
  mutate(site="BWL",
         catch="BW")

summary(BWL_met_binned)

GBL_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/GBL_Full_30_2025-03-27_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="GBL",
         catch="GB")


BWU_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/BWU_Full_2025-02-04_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="BWU",
         catch="BW")

GBU_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/GBU_Full_2025-03-20_daily.csv") %>% #     GBU_Full_2025-02-03_daily.csv
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date,GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="GBU",
         catch="GB")

metab_dat <- rbind(BWL_met_binned, BWU_met_binned, GBL_met_binned, GBU_met_binned)

covariat_datq <- covariat_datq%>%
  left_join(metab_dat, by=c("date", "site", "catch"))
```




```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

covariat_datq$AFDM_ugcm2 <- (covariat_datq$AFDM_mgcm2 *1000)
#hist(covariat_datq$AFDM_ugcm2 )

covariat_datq$Biom_Chla <- (covariat_datq$AFDM_ugcm2)/(covariat_datq$Chla_ugL_Q)
#hist(covariat_datq$Biom_Chla)

summary(covariat_datq)

```

#### Possible nutrient data infill from EGRET package

<https://github.com/DOI-USGS/EGRET/blob/main/R/readUserDaily.r>

<https://cran.r-project.org/web/packages/EGRET/vignettes/EGRET.html>

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
library(EGRET)

egret_BWL_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NO31.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="BWL") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NO31.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt <- ggplot(egret_BWL_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWL NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt

egret_BWL_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="BWL") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt1 <- ggplot(egret_BWL_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWL NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt1

###

egret_BWU_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NO3.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="BWU") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NO3.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt2 <- ggplot(egret_BWU_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWU NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt2

egret_BWU_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="BWU") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt3 <- ggplot(egret_BWU_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWU NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt3

###

egret_GBL_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NO3.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="GBL") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NO3.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt4 <- ggplot(egret_GBL_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBL NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt4

egret_GBL_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="GBL") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt5 <- ggplot(egret_GBL_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBL NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt5

###

egret_GBU_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NO3.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="GBU") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NO3.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt6 <- ggplot(egret_GBU_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBU NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt6

egret_GBU_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="GBU") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt7 <- ggplot(egret_GBU_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBL NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt7

```



```{r, warning=F, size = 'small', echo=F, fig.width=9, fig.height=7}
# Arrange plots with shared legend at the bottom
KD_coeff_grid <- ggarrange(
  logQ_plt,
  logQ_plt1,
  logQ_plt2,
  logQ_plt3,
  logQ_plt4,
  logQ_plt5,
  logQ_plt6,
  logQ_plt7,
  ncol = 2, nrow = 4,
  common.legend = TRUE, 
  legend = "bottom"
)

KD_coeff_grid
```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Sup_figure_EGRET.png", plot = KD_coeff_grid, width = 12, height = 10, units = "in")

```


```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}

nitrogen_dat <- rbind(egret_BWL_N,
                      egret_BWU_N, 
                      egret_GBL_N, 
                      egret_GBU_N)


nitrogen_datA <- rbind(egret_BWL_A, 
                      egret_BWU_A,
                      egret_GBL_A, 
                      egret_GBU_A)

nitrogen_data <- nitrogen_dat %>% full_join(nitrogen_datA, by=c("date", "site"))

```

#### Calculate nitrogen demand:

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
# Constants
ra <- 0.5  # Autotrophic respiration coefficient (Hall & Tank 2003)
C_Nauto <- 16  # Autotrophic C:N ratio (Stelzer & Lamberti 2001)
C_Nhetero <- 20  # Heterotrophic C:N ratio (Hall & Tank 2003)
HGE <- 0.05  # Heterotrophic Growth Efficiency (Hall & Tank 2003)

# Calculate components of nitrogen demand
covariat_ndemand <- covariat_datq %>%
  group_by(site) %>% 
  mutate(
    # Autotrophic respiration (raGPP)
    raGPP = GPP_mean * ra,
    # Autotrophic assimilation of N
    Auto_N_assim = GPP_mean / C_Nauto,
    # Heterotrophic respiration (Rh)
    Rh = ER_mean - raGPP,
    # Heterotrophic assimilation of N
    Hetero_N_assim = (Rh * HGE) / C_Nhetero,
    # Total nitrogen demand
    Ndemand = Auto_N_assim + Hetero_N_assim, # unit should be g N m-2 d-1
    Ndemand = if_else(Ndemand < 0, 0.0001, Ndemand)) %>%
  dplyr::select(site, date, Ndemand)
```


```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

### Quality check on supply calculations:
# (1) How many data points do we have for velocity (v) and width (w)?

morph_counts <- covariat_datq %>%
  group_by(site) %>%
  summarise(
    w_m_count = sum(!is.na(w_m)), 
    v_m_count = sum(!is.na(v_m))
  )

morph_counts
```


```{r, warning=F, size = 'small', echo=F, include=F,fig.width=6, fig.height=4}
##### better way to infill width and velocites to get at reach length:
# na.approx, and using Q as "Variables to be used for interpolation as in"


covariat_datqI <- covariat_datq %>%
  group_by(site) %>%
  arrange(date) %>%
  mutate(
    # Fit a linear model for w_m ~ Q_m using non-missing values
    w_m_apr = ifelse(is.na(w_m), predict(lm(w_m ~ depth_m, data = cur_data(), na.action = na.omit), newdata = cur_data()), w_m),
    v_m_apr = ifelse(is.na(v_m), predict(lm(v_m ~ Q_m, data = cur_data(), na.action = na.omit), newdata = cur_data()), v_m)
  ) %>%
  ungroup()

covariat_datqI <- covariat_datqI %>%
  group_by(site) %>%
  arrange(date) %>%  # Ensure chronological order
   mutate( ## 17 NAs
    w_m_apr = ifelse(is.na(w_m_apr),
                  rollapplyr(w_m_apr, width = 15, FUN = function(x) mean(x, na.rm = TRUE), fill = NA, partial = TRUE),
                  w_m_apr),
    v_m_apr = ifelse(is.na(v_m_apr),
                  rollapplyr(v_m_apr, width = 15, FUN = function(x) mean(x, na.rm = TRUE), fill = NA, partial = TRUE),
                  v_m_apr))
```

```{r, warning=F, size = 'small', echo=F,include=F, fig.width=9, fig.height=10}

TS_plot_w <- ggplot(covariat_datqI, aes(x = date, y = w_m_apr, color=site, shape =site)) +
  geom_point(size = 2, alpha = 0.5, position = position_dodge(width = 0.3)) +
  geom_point(size = 2, alpha = 0.7) +
  geom_point(aes(x = date, y = w_m), color="black") +
  scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) + theme_classic() +
  facet_grid(site~.)

TS_plot_v <- ggplot(covariat_datqI, aes(x = date, y = v_m_apr, color=site, shape =site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_point(size = 2, alpha = 0.7) +
    geom_point(aes(x = date, y = v_m), color="black") +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
    scale_color_manual(values = siteC_colors) +
  theme_classic() +facet_grid(site~.)

n_s_grid <- ggarrange(
  TS_plot_w,
  TS_plot_v,
  labels = c("a", "b"),
  ncol = 1, nrow = 2,
  label.x = 0.95,  # Move label to the right
  label.y = 1,     # Keep label at the top
  hjust = 1,       # Right-align the label
  vjust = 1        # Top-align the label
)

n_s_grid

# Where the black points are the survey measures of width or velocity.


```


#### Calculate nitrogen supply:

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
covariat_nsupply <- covariat_datqI %>%
  left_join(nitrogen_data, by=c("date", "site")) %>%
  dplyr::select(site, catch, date, water_year, reach_length,
                v_m_apr,w_m_apr, Q_m, K600_daily_mean,
                NO3_mgL_dl_sw, NH4_mgL_dl_sw, PO4_ugL_dl_sw, NO3_mgL_i, NH4_mgL_i) %>%
  mutate(
    K600_daily_mean = case_when(
      is.na(K600_daily_mean) & site == "BWL" ~ 22, 
      is.na(K600_daily_mean) & site == "BWU" ~ 16,
      is.na(K600_daily_mean) & site == "GBU" ~ 32,
      is.na(K600_daily_mean) & site == "GBL" ~ 25,
      TRUE ~ K600_daily_mean)) %>%
  mutate(Q_Ls = Q_m * 1000, # flow from csm to Ls
  # calculate reach length in m
  reachL = c((v_m_apr*w_m_apr*8640)/K600_daily_mean), # seconds to days
   # Calculate no3 supply 
  NO3_supply = c(((86400*Q_Ls*(NO3_mgL_dl_sw/1000))/(w_m_apr*reachL))),
  NO3_supply_new = c(((86400*Q_Ls*(NO3_mgL_i/1000))/(w_m_apr*reachL))),

   # Calculate nh3 supply 
  NH4_supply = c(((86400*Q_Ls*(NH4_mgL_dl_sw/1000))/(w_m_apr*reachL))), ## unit should be g N m-2 d-1
 NH4_supply_new = c(((86400*Q_Ls*(NH4_mgL_i/1000))/(w_m_apr*reachL))),
  PO4_supply = c(((86400*Q_Ls*(PO4_ugL_dl_sw/1e-6))/(w_m_apr*reachL))) ## unit should be g N m-2 d-1
   )  %>%
  dplyr::select(site, date, reachL, reach_length, Q_Ls, NO3_supply, 
                NO3_supply_new, NH4_supply, PO4_supply, NH4_supply_new, NO3_mgL_i, NH4_mgL_i, PO4_ugL_dl_sw)

```



```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
ndyn <- covariat_datq %>%
  left_join(covariat_nsupply, by=c("site", "date"))%>%
  left_join(covariat_ndemand, by=c ("site", "date")) 

summary(ndyn)

```


### **Figure 2**
Setting: Showing the delayed onset of baseflow in wetter years.
Color as water year. 

DOY - April 1 = 91
DOY - May 1 = 121
DOY -June 1 = 152
DOY - Sept 1 = 244
DOY - Oct 1 = 274

```{r, warning=F, size = 'small', echo=F, include=FALSE}

names(covariat_datq)

covariat_datq<-covariat_datq%>%
  mutate(yday=yday(date))


overall_pf<- covariat_datq %>%
    filter(yday >= 92, yday <= 153) %>%
  group_by(site, water_year) %>%
  summarise(
    max_pf = max(Q_m, na.rm = TRUE),
    min_pf = min(Q_m, na.rm = TRUE),
    max_pf_yday = yday[which.max(Q_m)],
    min_pf_yday = yday[which.min(Q_m)],
    mean_pf = mean(Q_m, na.rm = TRUE),
    mean_pf_yday = yday[which.min(abs(Q_m - mean_pf))]) %>%
  ungroup()


overall_bf<- covariat_datq %>%
    filter(yday >= 170, yday <= 274) %>%
  group_by(site) %>%
  summarise(
    max_q = max(Q_m, na.rm = TRUE),
    min_q = min(Q_m, na.rm = TRUE),
    max_q_yday = yday[which.max(Q_m)],
    min_q_yday = yday[which.min(Q_m)],
    mean_q = mean(Q_m, na.rm = TRUE),
    mean_q_yday = yday[which.min(abs(Q_m - mean_q))]) %>%
  ungroup()


overall_bf_df <- covariat_datq %>%
  left_join(overall_bf, by = c("site"))


steepest_slopes <- overall_bf_df %>%
    filter(yday >= 153, yday <= 274) %>%
  #  arrange(site, water_year, yday) %>%
  mutate(
    mean_q = case_when(
      site == "GBL" & water_year == 2023 ~ mean_q + 0.031,  # Adjust ave_q for GBL in 2021
      TRUE ~ mean_q)) %>%
  mutate(
    mean_q = case_when(
      site == "GBL" & water_year == 2024 ~ mean_q + 0.01,  # Adjust ave_q for GBL in 2021
      TRUE ~ mean_q)) %>%
    mutate(
    Q_m = case_when(
      site == "GBL" & water_year == 2021 ~ Q_m + 0.001,  # Adjust ave_q for GBL in 2021
      TRUE ~ Q_m)) %>%
  group_by(site, water_year) %>%
  summarise(
    ave_q = mean(mean_q, na.rm = TRUE),
    max_q = max(Q_m, na.rm = TRUE),
    min_q = min(Q_m, na.rm = TRUE),
    max_q_yday = yday[which.max(Q_m)],
    min_q_yday = yday[which.min(Q_m)],
    mean_q_yday = yday[which.min(abs(Q_m - mean_q))]
   # max_slope = max(slope, na.rm = TRUE),
  #  max_slope_yday = yday[which(slope == max(slope, na.rm = TRUE))[1]],
  #  min_slope = min(slope, na.rm = TRUE),
  #  min_slope_yday = yday[which(slope == min(slope, na.rm = TRUE))[1]]
  ) %>%
  ungroup() 

```

```{r, warning=F, size = 'small', echo=F, include=F}
# Merge covariat_datq with steepest_slopes to get mean_q_yday
Baseflowplots <- covariat_datq %>%
  dplyr::select(date, site, catch, water_year, Q_m, yday) %>%
  left_join(steepest_slopes %>% select(site, water_year, mean_q_yday, ave_q), by = c("site", "water_year","yday"= "mean_q_yday")) %>%
    left_join(overall_pf %>% select(site, water_year, max_pf, max_pf_yday), by = c("site", "water_year", "yday"= "max_pf_yday"))  %>%filter(site=="BWL" | site=="GBL")


Baseflowplot1 <- Baseflowplots%>%
  mutate(
    ave_q = case_when(
      site == "GBL" & water_year == 2021 ~ ave_q - 0.006,  # Adjust ave_q for GBL in 2021
      TRUE ~ ave_q))


Baseflowplot <- ggplot(Baseflowplot1 %>% 
                         filter(water_year < 2025), 
                       aes(x = yday, y = Q_m, color = as.factor(water_year))) +
  geom_line() +  
  scale_color_viridis_d(name = "Year") +  
  xlim(91, 234) + 
  facet_wrap(.~site, scales = "free") + 
  theme_classic() + 
  ylab(expression(Streamflow~(m^3~s^-1))) +
  xlab("Day of year") +

  # Vertical lines at ave_q day
  geom_vline(data = Baseflowplot1 %>% filter(water_year < 2025),
             aes(xintercept = yday[ave_q == ave_q], color = as.factor(water_year)),
             linetype = "dashed", size = 0.5, alpha = 0.9) +

  # Points for max_pf and ave_q
  geom_point(aes(x = yday, y = ave_q, color = as.factor(water_year)), 
             shape = 19, size = 1.5, alpha = 0.9)

BF_sum <- Baseflowplot1%>%
  filter(!is.na(Baseflowplot1$ave_q))

BF_sum

```


```{r, warning=F, size = 'small', echo=F, fig.width=9, fig.height=4.25}

Baseflowplot <- ggplot(Baseflowplot1 %>% 
                         filter(water_year < 2025), 
                       aes(x = yday, y = Q_m, color = as.factor(water_year))) +
  geom_line() +  
  scale_color_viridis_d(name = "Year") +  
  xlim(91, 234) + 
  facet_grid(site~., scales = "free") + 
  theme_classic() + 
  theme(legend.position = "bottom")+
  ylab(expression(Streamflow~(m^3~s^-1))) +
  xlab("Day of year") +

  # Vertical lines at ave_q day
  geom_vline(data = Baseflowplot1 %>% filter(water_year < 2025),
             aes(xintercept = yday[ave_q == ave_q], color = as.factor(water_year)),
             linetype = "dashed", size = 0.5, alpha = 0.9) +

  # Points for max_pf and ave_q
  geom_point(aes(x = yday, y = ave_q, color = as.factor(water_year)), 
             shape = 19, size = 1.5, alpha = 0.9) +

  geom_text(data = Baseflowplot1 %>% 
              filter(site == "BWL" & water_year < 2025), 
            aes(x = 232, y = 8.7, label = "51 days"),  # Adjusted to max Q_m and max yday for top-right corner
            color = "#440154", size = 4, hjust = 1, vjust = 1, fontface = "bold") +
  geom_text(data = Baseflowplot1 %>% 
              filter(site == "BWL" & water_year < 2025), 
            aes(x = 232, y = 8, label = "30 days"),  # Adjust the position and text as needed
            color = "#3B528B", size = 4, hjust = 1, vjust = 1, fontface = "bold") +
  geom_text(data = Baseflowplot1 %>% 
              filter(site == "BWL" & water_year < 2025), 
            aes(x = 232, y = 7.3, label = "27 days"),  # Adjust the position and text as needed
            color = "#fad311", size = 4, hjust = 1, vjust = 1, fontface = "bold") +
  geom_text(data = Baseflowplot1 %>% 
              filter(site == "GBL" & water_year < 2025), 
            aes(x = 232, y = 0.85, label = "42 days"),  # Adjusted to max Q_m and max yday for top-right corner
            color = "#440154", size = 4, hjust = 1, vjust = 1, fontface = "bold") +
  geom_text(data = Baseflowplot1 %>% 
              filter(site == "GBL" & water_year < 2025), 
            aes(x = 232, y = 0.78, label = "38 days"),  # Adjust the position and text as needed
            color = "#3B528B", size = 4, hjust = 1, vjust = 1, fontface = "bold") +
  geom_text(data = Baseflowplot1 %>% 
              filter(site == "GBL" & water_year < 2025), 
            aes(x = 232, y = 0.71, label = "29 days"),  # Adjust the position and text as needed
            color = "#fad311", size = 4, hjust = 1, vjust = 1, fontface = "bold")




Baseflowplot




```  



```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Fig2_baseflow_v4.png", plot = Baseflowplot, width =4.5, height = 4.75, units = "in")

```




```{r, warning=F, size = 'small', echo=F,include=F, fig.width=9, fig.height=10}
steepest_slopes

Dec1 = 335

BW21= Dec1 - 162

BW22= Dec1 - 183

BW23= Dec1 - 214

BF_change = (163-BW23)/163

(Dec1- 163) - BW23

GB21= Dec1 - 153

GB22= Dec1 - 161

GB23= Dec1 - 201

GB_change = (178-GB23)/178

(Dec1- 178)-GB23


```


```{r, warning=F, size = 'small', echo=F, include=FALSE}

##### Kernal density plots of GPP and ER

BWL_KD_plot <- ggplot(covariat_datq%>%dplyr::filter(site=="BWL" &water_year<2025), aes(x = GPP_mean, y = ER_mean, color = as.factor(water_year))) +
  geom_density_2d(bins=10, size=0.5) + 
  geom_point(alpha=0.5)+
  geom_abline(slope = -1, intercept = 0, color = "black") +  # 1:1 line
xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
 ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
    scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
      scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
     scale_color_viridis_d(option = "viridis", name = "Water year") +
  theme_classic() +
          annotate("text", x = 7, y = -2, label = "BW Lower", size = 5, fontface = "bold", hjust = 0.5) 

BWU_DF_fixed <- covariat_datq%>%dplyr::filter(site=="BWU") %>%
  filter(water_year < 2024) %>%
  mutate(water_year = factor(water_year, levels = c(2021, 2022, 2023, 2024))) %>%
  bind_rows(tibble(GPP_mean = NA, ER_mean = NA, water_year = factor(2024, levels = c(2021, 2022, 2023, 2024))))  # Add dummy row


BWU_KD_plot <- ggplot(BWU_DF_fixed, aes(x = GPP_mean, y = ER_mean, color = water_year)) +
  geom_density_2d(bins = 10, size = 0.5) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = -1, intercept = 0, color = "black") +  # 1:1 line
  scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
  scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
  xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
  ylab(NULL) +
  #ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
  scale_color_viridis_d(option = "viridis", name = "Water year") +
  theme_classic() +
        annotate("text", x = 7, y = -2, label = "BW Upper", size = 5, fontface = "bold", hjust = 0.5) 
BWU_KD_plot



GBU_DF_clean <- covariat_datq%>%dplyr::filter(site=="GBU") %>%
filter(water_year<2025)%>%
  filter(!is.na(GPP_mean) & !is.na(ER_mean))%>%
  dplyr::select(date, water_year, GPP_mean, ER_mean)

# Compute 2D density
library(MASS)
density_data <- with(GBU_DF_clean, kde2d(GPP_mean, ER_mean, n = 25))

# Convert density data to dataframe
density_df <- data.frame(
  expand.grid(x = density_data$x, y = density_data$y),
  z = as.vector(density_data$z)
)

# Plot with contour lines
GBU_KD_plot <- ggplot() +
  geom_point(data = GBU_DF_clean, aes(x = GPP_mean, y = ER_mean, color = as.factor(water_year)), alpha = 0.5) +
    geom_contour(data = density_df, aes(x = x, y = y, z = z), color = "#f2e54b", bins = 25, size=0.25) +
  scale_x_continuous(position = "top") +
    geom_abline(slope = -1, intercept = 0, color = "black") +  # 1:1 line
   xlab(NULL) +
    ylab(NULL) +
  #ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
    scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
    scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
  scale_color_viridis_d(option = "viridis", name = "Water year") +
  theme_classic() +
        annotate("text", x = 7, y = -2, label = "GB Upper", size = 5, fontface = "bold", hjust = 0.5) 

GBU_KD_plot


GBL_DF_clean <- covariat_datq%>%dplyr::filter(site=="GBL") %>%
  filter(!is.na(GPP_mean) & !is.na(ER_mean))%>%
  dplyr::select(date, water_year, GPP_mean, ER_mean)

# Compute 2D density
library(MASS)
density_data <- with(GBL_DF_clean, kde2d(GPP_mean, ER_mean, n = 25))

# Convert density data to dataframe
density_df <- data.frame(
  expand.grid(x = density_data$x, y = density_data$y),
  z = as.vector(density_data$z)
)


# Plot with contour lines
GBL_KD_plot <- ggplot() +
#  geom_contour(data = density_df, aes(x = x, y = y, z = z), color = "black", bins = 10) +
  geom_point(data = GBL_DF_clean%>%filter(water_year<2025), aes(x = GPP_mean, y = ER_mean, color = as.factor(water_year)), alpha = 0.5) +
  scale_x_continuous(position = "top") +
      geom_contour(data = density_df, aes(x = x, y = y, z = z), color = "#f2e54b", bins = 25, size=0.25) +
  geom_abline(slope = -1, intercept = 0, color = "black") +  # 1:1 line
    #xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
   xlab(NULL) +
  ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
  scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
      scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
  scale_color_viridis_d(option = "viridis",  name = "Water year") +
  theme_classic() +
      annotate("text", x = 7, y = -2, label = "GB Lower", size = 5, fontface = "bold", hjust = 0.25) 





```

```{r, warning=F, size = 'small', echo=F, include=F}
# Modify each plot to rename legend title & adjust legend formatting
BWL_KD_plot <- BWL_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 1))

BWU_KD_plot <- BWU_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 1))

GBL_KD_plot <- GBL_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 1))

GBU_KD_plot <- GBU_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 1))
```

### **Figure 3**

##### Kernal density plots of GPP and ER

Metabolism  regimes
Color as water year. 

```{r, warning=F, size = 'small', echo=F, fig.width=9, fig.height=7}
# Arrange plots with shared legend at the bottom
KD_coeff_grid <- ggarrange(
  BWL_KD_plot,
  BWU_KD_plot,
  GBL_KD_plot,
  GBU_KD_plot,
  labels = c("a", "b", "c", "d"),
  ncol = 2, nrow = 2,
  common.legend = TRUE, 
  legend = "bottom"
)

KD_coeff_grid
```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Fig2_KD_CH1_grid_v2.png", plot = KD_coeff_grid, width = 6, height = 5.25, units = "in")

```




```{r, warning=F, size = 'small', echo=F, include=FALSE, include=F}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWL") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
      filter(site=="BWL") %>%
  filter(!is.na(GPP_mean)) %>%
  dplyr:: select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Lower")
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, include=F}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWU") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
      filter(site=="BWU") %>%
  filter(!is.na(GPP_mean)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt_BWU <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Upper")
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, include=F}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBL") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
      filter(site=="GBL") %>%
  filter(!is.na(GPP_mean)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt_GBL <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Lower")
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, include=F}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBU") %>%
  filter(!is.na(do.obs_m)) %>%
  dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
  filter(site=="GBU") %>%
  filter(!is.na(GPP_mean)) %>%
  dplyr:: select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt_GBU <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Upper",
       caption = "Black: DO Observed | Green: GPP Mean")
```

### Supplemental Figures for showing the data resolution for DO and metab


```{r, warning=F, size = 'small', echo=F, include=F, fig.width=10, fig.height=4.5}
### big grid 
WY_n_grid2 <- ggarrange(
  templt,
  templt_BWU,
  templt_GBL,
  templt_GBU,
  ncol = 1, nrow = 4)

WY_n_grid2
```

#### Comparable cumulative metabolism
Where days that the model can't identify GPP (in green) or ER (orange) but there is DO, we then assume the metabolism (GPP/ER) to be 0 


```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWL") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_GPP = !is.na(GPP_mean),
         plot_GPP = ifelse(is.na(GPP_mean), 0, GPP_mean),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, yday_2022, yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 2022, 2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(GPP_cumsum = cumsum(plot_GPP))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt_1 <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_GPP), aes(y = 0.090), alpha= 0.8, color = "#579467", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Lower - GPP") +facet_grid(year~.)
templt_1
```

```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_bw <- date_datf_plt %>%
  filter(site=="BWL" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

BWL_plot <- ggplot(date_datf_plt_bw, aes(x = yday, y = GPP_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) + 
  labs(x = "Day of Water Year", color = "Year", 
       title = "BW Lower") +
  ylab(expression(GPP~(g~O[2]~m^-2~yr^-1))) +
  xlab(NULL) +
  scale_color_manual(values=c("#440154", "#3B528B", "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() +
   xlim(91, 335)
#  xlim(115, 290)

BWL_plot

# Compute the maximum cumulative GPP for each year
date_datf_plt_sum <- date_datf_plt_bw %>%
  group_by(year) %>%
  summarise(
    T_gpp = max(GPP_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_gpp -T_gpp[year == 2023]) / T_gpp * 100)

```




```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWL") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, ER_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_ER = !is.na(ER_mean),
         ER_abs = (ER_mean*-1),
         plot_ER = ifelse(is.na(ER_abs), 0, ER_abs),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, yday_2022, yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 2022, 2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(ER_cumsum = cumsum(plot_ER))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_ER), aes(y = 0.090), alpha= 0.8, color = "chocolate", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Lower - ER") +facet_grid(year~.)
templt
```

```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_bw <- date_datf_plt %>%
  filter(site=="BWL" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

BWL_plot1 <- ggplot(date_datf_plt_bw, aes(x = yday, y = ER_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) + 
      ylim(0,1500)+
  labs(x = "Day of Water Year", color = "Year") +
  ylab(expression("|"~ER~"|"~(g~O[2]~m^-2~yr^-1))) +
  scale_color_manual(values=c("#440154", "#3B528B", "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() +
    xlab(NULL) +
     xlim(91, 335)
#  xlim(115, 290)


# Compute the maximum cumulative GPP for each year
date_datf_plt_sum <- date_datf_plt_bw %>%
  group_by(year) %>%
  summarise(T_cm = max(ER_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm -T_cm[year == 2023]) / T_cm * 100)


```




```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWU") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_GPP = !is.na(GPP_mean),
         plot_GPP = ifelse(is.na(GPP_mean), 0, GPP_mean),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, yday_2022, yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 2022, 2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(GPP_cumsum = cumsum(plot_GPP))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_GPP), aes(y = 0.090), alpha= 0.8, color = "#579467", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Upper - GPP") +facet_grid(year~.)
templt
```


```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_bw <- date_datf_plt %>%
  filter(site=="BWU" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

BWU_plot <- ggplot(date_datf_plt_bw, aes(x = yday, y = GPP_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) + 
  labs(x = "Day of Water Year", color = "Year", 
       title = "BW Upper") +
  ylab(expression(GPP~(g~O[2]~m^-2~yr^-1))) +
  ylim(0,400) +
  scale_color_manual(values=c("#440154", 
                              "#3B528B", 
                              "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() +
    xlab(NULL) +
       xlim(91, 335)



# Compute the maximum cumulative GPP for each year
date_datf_plt_sum <- date_datf_plt_bw %>%
  group_by(year) %>%
  summarise(T_cm = max(GPP_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm -T_cm[year == 2023]) / T_cm * 100)



```




```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWU") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, ER_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_ER = !is.na(ER_mean),
         ER_abs = (ER_mean*-1),
         plot_ER = ifelse(is.na(ER_abs), 0, ER_abs),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, yday_2022, yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 2022, 2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(ER_cumsum = cumsum(plot_ER))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_ER), aes(y = 0.090), alpha= 0.8, color = "chocolate", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Upper - ER") +facet_grid(year~.)
templt
```

```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_bw <- date_datf_plt %>%
  filter(site=="BWU" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

BWU_plot1 <- ggplot(date_datf_plt_bw, aes(x = yday, y = ER_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) + 
  labs(x = "Day of Water Year", color = "Year") +
  ylab(expression("|"~ER~"|"~(g~O[2]~m^-2~yr^-1))) +
  scale_color_manual(values=c("#440154", "#3B528B", "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() +
        ylim(0,1500)+
    xlab(NULL) +
       xlim(91, 335)

  #xlim(185, 250)


# Compute the maximum cumulative GPP for each year
date_datf_plt_sum <- date_datf_plt_bw %>%
  group_by(year) %>%
  summarise(T_cm = max(ER_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm -T_cm[year == 2023]) / T_cm * 100)

```


```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBL") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_GPP = !is.na(GPP_mean),
         plot_GPP = ifelse(is.na(GPP_mean), 0, GPP_mean),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, 
                                      yday_2022, 
                                      yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 
                                             2022, 
                                             2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(GPP_cumsum = cumsum(plot_GPP))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_GPP), aes(y = 0.090), alpha= 0.8, color = "#579467", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Lower - GPP") +facet_grid(year~.)
templt
```

```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_gb <- date_datf_plt %>%
  filter(site=="GBL" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

GBL_plot <- ggplot(date_datf_plt_gb, aes(x = yday, y = GPP_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) +
  ylim(0,30) +
  labs(x = "Day of Water Year", color = "Year", 
       title = "GB Lower") +
  ylab(expression(GPP~(g~O[2]~m^-2~yr^-1))) +
    xlab(NULL) +
  scale_color_manual(values=c("#440154", "#3B528B", "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() + xlim(91, 335)


# Compute the maximum cumulative GPP for each year
date_datf_plt_sum <- date_datf_plt_gb %>%
  group_by(year) %>%
  summarise(T_cm = max(GPP_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm -T_cm[year == 2023]) / T_cm * 100)


date_datf_plt_sum <- date_datf_plt_gb %>%
  group_by(year) %>%
  summarise(T_cm = max(GPP_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm[year == 2023]-T_cm) / T_cm[year == 2023] * 100)


```


```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBL") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, ER_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_ER = !is.na(ER_mean),
         ER_abs = (ER_mean*-1),
         plot_ER = ifelse(is.na(ER_abs), 0, ER_abs),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, yday_2022, yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 2022, 2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(ER_cumsum = cumsum(plot_ER))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_ER), aes(y = 0.090), alpha= 0.8, color = "chocolate", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Lower - ER") +facet_grid(year~.)
templt
```

```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_gb <- date_datf_plt %>%
  filter(site=="GBL" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

GBL_plot1 <- ggplot(date_datf_plt_gb, aes(x = yday, y = ER_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) + 
  labs(x = "Day of Water Year", color = "Year") +  xlab(NULL) +
  ylab(expression("|"~ER~"|"~(g~O[2]~m^-2~yr^-1))) +
  scale_color_manual(values=c("#440154", "#3B528B", "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() + xlim(91, 335)
#xlim(115, 332)

GBL_plot1



date_datf_plt_sum <- date_datf_plt_gb %>%
  group_by(year) %>%
  summarise(T_cm = max(ER_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm[year == 2023]-T_cm) / T_cm[year == 2023] * 100)

```




```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBU") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_GPP = !is.na(GPP_mean),
         plot_GPP = ifelse(is.na(GPP_mean), 0, GPP_mean),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, 
                                      yday_2022, 
                                      yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 
                                             2022, 
                                             2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(GPP_cumsum = cumsum(plot_GPP))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_GPP), aes(y = 0.090), alpha= 0.8, color = "#579467", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Upper - GPP") +facet_grid(year~.)
templt
```

```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_gb <- date_datf_plt %>%
  filter(site=="GBU" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

GBU_plot <- ggplot(date_datf_plt_gb, aes(x = yday, y = GPP_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) + 
  labs(x = "Day of Water Year", color = "Year", 
       title = "GB Upper") +
  ylab(expression(GPP~(g~O[2]~m^-2~yr^-1))) +
  scale_color_manual(values=c("#440154", "#3B528B", "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() + xlim(91, 335)
# xlim(115, 340)


date_datf_plt_sum <- date_datf_plt_gb %>%
  group_by(year) %>%
  summarise(T_cm = max(GPP_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm -T_cm[year == 2023]) / T_cm * 100)


```



```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=2}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBU") %>%
  filter(!is.na(do.obs_m)) %>%
   dplyr::select(date, do.obs_m, ER_mean) %>%
  mutate(has_do = !is.na(do.obs_m), 
         has_ER = !is.na(ER_mean),
         ER_abs = (ER_mean*-1),
         plot_ER = ifelse(is.na(ER_abs), 0, ER_abs),
         yday=yday(date),
         year=year(date))

# Identify the unique yday values for each year
yday_2021 <- unique(plot_data_DO$yday[plot_data_DO$year == 2021])
yday_2022 <- unique(plot_data_DO$yday[plot_data_DO$year == 2022])
yday_2023 <- unique(plot_data_DO$yday[plot_data_DO$year == 2023])

# Find the common yday values across all three years
common_yday <- Reduce(intersect, list(yday_2021, yday_2022, yday_2023))

# Filter the dataframe for only those common yday values
filtered_data <- plot_data_DO %>%
  filter(yday %in% common_yday & year %in% c(2021, 2022, 2023))

filtered_data_cs <- filtered_data%>%
    arrange(year, yday) %>%
    group_by(year) %>%
    mutate(ER_cumsum = cumsum(plot_ER))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(filtered_data, aes(x = yday)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(filtered_data, has_do), aes(y = 0.095), alpha=0.8, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(filtered_data, has_ER), aes(y = 0.090), alpha= 0.8, color = "chocolate", size = 1) + # GPP presence tick marks
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Upper - ER") +facet_grid(year~.)
templt
```


```{r, warning=F, size = 'small', echo=F, include=F}
#####
date_datf_plt <- date_datf %>%
  mutate(yday=yday(date),
         year=year(date))

date_datf_plt_gb <- date_datf_plt %>%
  filter(site=="GBU" & year <2024) %>%
  left_join(filtered_data_cs, by=c("yday", "year", "date"))

GBU_plot1 <- ggplot(date_datf_plt_gb, aes(x = yday, y = ER_cumsum, color = factor(year))) +
  geom_line(size = 1, alpha=0.95) + 
  ylim(0,600) +
  labs(x = "Day of Water Year", color = "Year") +
  ylab(expression("|"~ER~"|"~(g~O[2]~m^-2~yr^-1))) +
  scale_color_manual(values=c("#440154", "#3B528B", "#4bcc94")) +
 #   scale_color_viridis_d(option = "viridis",  name = "Year") +
  theme_classic() + xlim(91, 335)
#xlim(115, 332)


date_datf_plt_sum <- date_datf_plt_gb %>%
  group_by(year) %>%
  summarise(T_cm = max(ER_cumsum, na.rm = TRUE)) %>%
  mutate(percent_change = (T_cm -T_cm[year == 2023]) / T_cm * 100)

```

### **Figure 4**

#### Cummulative GPP and ER 

From overlapping DOY observations in each year. 

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=8, fig.height=8.5}

Csum_grid <- ggarrange(
  BWL_plot,
  BWU_plot,
  GBL_plot,
  GBU_plot,
  ncol = 1, nrow = 4,
  common.legend = TRUE, 
  align=c("v"),
  labels = c("a", "c", "e", "g"),
  label.x = 0.8,  # Move label to the right
  label.y = 1, 
  legend = "bottom")

Csum_grid_er <- ggarrange(
  BWL_plot1,
  BWU_plot1,
  GBL_plot1,
  GBU_plot1,
  ncol = 1, nrow = 4,
  common.legend = TRUE, 
  align=c("v"),
  labels = c("b", "d", "f", "h"),
  label.x = 0.8,  # Move label to the right
  label.y = 1, 
  legend = "bottom")

Csum_grid_T <- ggarrange(
  Csum_grid,
  Csum_grid_er,
  ncol = 2, nrow = 1,
  common.legend = TRUE, 
  legend = "bottom")


Csum_grid_T

```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Fig_cumsum_GPP_v2.png", plot = Csum_grid_T, width = 5.5, height = 8.25, units = "in")

```



##### Plots of Ratios of NH4+- N supply to demand, ratios NO3-- N supply to demand

Remaid figure 4: Now with chemistry data aligned to data data frame so
that there are no sample NAs for NO3 and Nh4 when the metabolism model
failed to estimate that parameter on the same day as the chemistry
sample.

Color is now also by water year 2021-2024, and shape is reach location.

```{r, warning=F, size = 'small', echo=F, include=F}
covariat_NS_ND <- ndyn %>%
  mutate(jday = yday(date)) %>%
  dplyr::select(date, jday, Q_m, w_m, site, catch, water_year, 
                Ndemand, NO3_supply_new, NO3_supply, NH4_supply, NH4_supply_new,
                NH4_mgL_i, NO3_mgL_i) %>%
  mutate(
    NO3_SupDem = NO3_supply / Ndemand,
    NH4_SupDem = NH4_supply / Ndemand,
    N_SupDem = (NH4_supply + NO3_supply) / Ndemand
  ) %>%
  distinct(date, site, .keep_all = TRUE)  %>%
    mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  )) %>%
    group_by(site, date, catch) %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

N_ratio_plots <- ggplot(covariat_NS_ND%>%filter(water_year<2025), aes(x = (NO3_supply), y = (Ndemand), color = as.factor(water_year), shape=site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
    geom_point( aes(x = (NH4_supply), y = Ndemand, color = as.factor(water_year)),
                size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
    scale_color_viridis_d(option = "viridis",  name = "Water year") +
      scale_shape_manual(values = c(15,0,17,2), name = "Site") +
    scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10)) + 
  scale_y_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                       labels = scales::label_number()) +
#    scale_x_continuous(trans = "log", breaks = c(0.001, 0.003, 0.1, 0.3, 1, 1.6)) +
 #     scale_y_continuous(trans = "log",  breaks = c(0.0001, 0.001, 0.003, 0.05, 0.1, 0.3)) +
 # xlim(0,1) +
 # ylim(0, 1) +
   ylab(expression(log(Nitrogen~demand)~(g~N~m^-2~d^-1))) +
     xlab(expression(log(Nitrogen~supply)~(g~N~m^-2~d^-1))) +
  theme_classic() 


NO3_supp_plots <- ggplot(covariat_NS_ND%>%filter(water_year<2025), aes(y = (NO3_supply_new), x = jday, color = as.factor(water_year), shape=site)) +
  geom_point(size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_point( aes(y = log(NH4_supply_new+1), x = jday, color = as.factor(water_year), shape=site), 
                size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
    scale_color_viridis_d(option = "viridis", name = "Water year") +  # Use _c for continuous data
#  ylim(0,1.50) +
   xlab(NULL) +
    scale_y_continuous(trans = "log", breaks = scales::log_breaks(base = 10)) +
  geom_smooth(aes(group = as.factor(water_year), fill = as.factor(water_year)), 
            se = TRUE, linewidth = 1, method = "gam", formula = y ~ s(x, k = 10), alpha = 0.1)+
     ylab(expression(log(Supply)~(g~N~m^-2~d^-1))) +
  theme_classic() +
      scale_x_continuous(
  limits = c(15, 285),
  breaks = seq(15, 285, by = 30)  
)+
      scale_fill_viridis_d(option = "viridis", name = "Water year") + 
  scale_shape_manual(values = c(15,0,17,2)) +
    theme(legend.position = "none") +
  facet_grid(catch~.)
# Remove legend

# Define threshold for high NO3 demand (above 3rd quartile)
high_Ndemand_threshold <- 0.075

N_demand_plot1 <- ggplot(covariat_NS_ND%>%filter(water_year<2025), aes(y = (Ndemand), x = jday, color = as.factor(water_year), shape = site)) +
  geom_point(size = 2, alpha = 0.85, position = position_dodge(width = 0.8)) +
  scale_color_viridis_d(option = "viridis", name = "Water year") +  # Use _c for continuous data
    scale_fill_viridis_d(option = "viridis", name = "Water year") +  # Use _c for continuous data
  xlab("Day of year") + 
    geom_smooth(aes(group = as.factor(water_year), fill = as.factor(water_year)), 
            se = TRUE, linewidth = 1, method = "gam", formula = y ~ s(x, k = 10), alpha = 0.1)+
    scale_y_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                         labels = scales::label_number()) +
 # geom_hline(yintercept = high_Ndemand_threshold, linetype = "dashed", color = "grey25") +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
  ylab(expression(log(Demand)~(g~N~m^-2~d^-1))) +
  theme_classic() +
      scale_x_continuous(
  limits = c(15, 285),
  breaks = seq(15, 285, by = 30)  
)+
  theme(legend.position = "none")  +
    facet_grid(catch~.)

N_demand_plot1

```

### **Figure 5**


```{r, warning=F, size = 'small', echo=F,include=T, fig.width=12, fig.height=6}

n_s_grid <- ggarrange(
  NO3_supp_plots,
  N_demand_plot1,
  labels = c("b", "c"),
    align = c("v"),
  ncol = 1, nrow = 2,
  label.x = 0.91,  # Move label to the right
  label.y = 1,     # Keep label at the top
  hjust = 1,       # Right-align the label
  vjust = 1        # Top-align the label
)



N_ratio_plots <- N_ratio_plots + 
  theme(
    aspect.ratio = 1, 
    plot.margin = margin(10, 20, 10, 20),
    legend.position = "bottom"
  ) +
  guides(
    shape = guide_legend(nrow = 2),  # Shape legend on first line
    color = guide_legend(nrow = 2)   # Color legend on second line
  )

Ndyn_grid <- ggarrange(
  N_ratio_plots,
  n_s_grid,
  ncol = 2, nrow = 1,
  labels = c("a", ""),
  vjust = 7,
  label.x = 0.23,  
  #common.legend = TRUE, 
  #legend = "bottom",
  widths = c(1.3, 1.6)
)

Ndyn_grid


```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=9, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Nsupply_grid_CH1_v3.png", plot = Ndyn_grid, width = 10.75, height = 6.75, units = "in")

```

### Nitrogen Uptake dynamics from TASCC

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
n_df <- n_up%>%
  filter(success=="yes") %>%
  mutate(
         Uadd_g_m2_min = c(Uadd_ug_L_min/1000000),
         Uadd_g_m2_D = c(Uadd_g_m2_min*1440)) 

uptake <- n_df %>%
  pivot_wider(
    names_from = method, 
    values_from = Uadd_g_m2_D, 
    names_prefix = "Uadd_g_m2_D_") %>%
  dplyr::select(site, date, Uadd_g_m2_D_NH3, Uadd_g_m2_D_NO3)

summary(uptake)
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=6, fig.height=4}

uptake_df <-  covariat_NS_ND%>%
  full_join(uptake)

```

### Linking ecosystem funtion and biogeochemical dynamics:

We found that autotrophic production (and so nitrogen demand) is
suppressed in wetter years. We want to know how the reduced autrophic
production could effect nitrogen retention and transport.

-   To estimate what amount of the nitrogen can be could be transformed
    via uptake in at a given reach?

    -   Fractional uptake efficiencies (FUE) for N?

    -   Might consider the FUE at the lower station as downstream
        export?

-   To estimate what amount of the nitrogen can be could be transformed
    via uptake in a stream

    -   Difference in FUE between reaches for overall stream processing?

-   In wet years, even though supply increases, we would expect
    biological processes like uptake to decrease. So what percent of the
    N supply is either processes or exported in wet verse dry years?

##### Consider the units

-   Areal max uptake - Ut - ug / m2 min -\> we converted to g m2 day

-   Uptake velocity - Vf - m / min

-   Uptake length - Sw - m

-   Supply and demand is in g N m-2 d-1

### Methods for evaluating nitrogen cycling

According to [Covino et al.
2018](https://www.journals.uchicago.edu/doi/abs/10.1086/699202?casa_token=z4FRLNRrBH8AAAAA:g2dwDEk5ct5-NxSqV0w2PILcK9ArSQhBnEeVBmOHiEHU_RMeWBRu4RWAzJG6ilh7wSeD30YDPkyH&casa_token=_yfAVNMW2ZQAAAAA:LH4hXzHGlRGjdsnCKp28IBUCho9RqquzLdge8TkzP3UNGQdvoI8SqtoxxyHw67tIEtm_4uM6CLmY)
:

-   Supply (S): The available nitrogen in the system (in g N/m/day).

-   Demand (D): The total biological nitrogen demand (in g N/m/day).

-   Uptake rate (U): The amount of nitrogen removed from the water
    column via assimilation, denitrification, or other biological
    processes.

#### U = (D \* S) / (D + S)

-   When demand (D) is much greater than supply (S): Almost all
    available nitrogen is taken up, so uptake approaches supply (U  S)

-   When supply (S) is much greater than demand (D): Uptake is limited
    by biological demand, and uptake approaches demand (U  D)

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=3}
uptake_dyn <- uptake_df %>%
  group_by(site, date) %>%
  mutate(
    jday = yday(date),
    U_NO3_calc = c((Ndemand*NO3_supply_new)/(Ndemand+NO3_supply_new)),
    U_NH4_calc = c((Ndemand*NH4_supply_new)/(Ndemand+NH4_supply_new))) %>%
  group_by(site, date) %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop") %>%
  mutate(catch = case_when(
    site== "BWL" ~ "BW",
    site== "BWU" ~ "BW",
    site== "GBL" ~ "GB",
    site== "GBU" ~ "GB",
    TRUE ~ NA_character_  
  ))
  

summary(uptake_dyn)

hist1<- ggplot(uptake_dyn, aes(x = U_NO3_calc)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal()
hist1

hist2<- ggplot(uptake_dyn, aes(x = U_NH4_calc)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal()
hist2


n_df_temp <- uptake_dyn %>%
  group_by(site) %>%
  summarise(U_NO3_calc= c(mean(U_NO3_calc, na.rm=T)*1000),
            U_NH4_calc= c(mean(U_NH4_calc, na.rm=T)*1000), 
            Q_ls=c(mean(Q_m, na.rm=T)*1000))
#   
# n_df_temp$Uadd_mg_m2_D <- (n_df_temp$Uadd_g_m2_D*1000)


```

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=9, fig.height=6}

uptake_dyn <- uptake_dyn %>%
  mutate(
    S_D_NO3 = NO3_supply_new / Ndemand,
    S_D_NH4 = NH4_supply_new / Ndemand
  )

summary(uptake_dyn$S_D_NO3)
summary(uptake_dyn$S_D_NH4)
quantile(uptake_dyn$S_D_NO3, probs = c(0.1, 0.9), na.rm = TRUE)
quantile(uptake_dyn$S_D_NH4, probs = c(0.1, 0.9), na.rm = TRUE)

```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}
hist1<- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = log(S_D_NO3+1))) +
 # geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 5) +  scale_color_manual(values = site_colors) + 
  geom_density(alpha = 0.7, aes(fill = site,  color = site)) +
  scale_color_manual(values = site_colors)  +
  scale_fill_manual(values = site_colors) + theme_minimal() +
  xlab(expression(log(NO[3]~Supply/N~Demand)))  
hist1

hist2<- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = log(S_D_NH4+1))) +
 # geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 5) +  scale_color_manual(values = site_colors) + 
  geom_density(alpha = 0.7, aes(fill = site,  color = site)) +
  scale_color_manual(values = site_colors)  +
  scale_fill_manual(values = site_colors) + theme_minimal() +
  xlab(expression(log(NH[4]~Supply/N~Demand))) 
hist2

```

```{r, warning=F, size = 'small', echo=F,include=F, fig.width=7, fig.height=6}

Ndyn_grid <- ggarrange(
  hist1,
  hist2,
  ncol = 1, nrow = 2,
    labels = c("a", "b"),
  common.legend = TRUE, 
   widths = c(1.75, 2.25),
  legend = "bottom")

Ndyn_grid
```

### Supply and demand dynamics tend to vary with catchment and reach:

Looks like N supply is greater than demand at GB -- indicating that
uptake (U) should be low and possibly limited by low biologic demand. So
we expect more nitrogen to be transported in GB.

Looks Like N demand is greater than supply at BW -- U should be high and
most available nitrogen should be retained.

### **Figure 6**


```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}

no3_S_plot <- ggplot(uptake_dyn, aes(x = (NO3_supply_new), y = (U_NO3_calc), color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.1)) +
  #scale_color_viridis_c(option = "viridis", name = "Day of year") + 
      scale_color_manual(values = siteC_colors) +
    scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                         labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                           labels = scales::label_number()) + 
  # scale_y_continuous(trans = "log") +#, breaks = c(0.01, 0.03, 0.1, 0.3, 1, 3, 10)) 
  #scale_x_continuous(trans = "log")  +
  geom_abline(slope = (1), intercept = 0, color = "black") +  # 1:1 line
  scale_shape_manual(values = c(15, 0, 17, 2)) +
 #xlim(0, 1) +
  theme_classic() + xlab(NULL)+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  #xlab(expression(log(N~supply)~(g~m^-2~d^-1))) +
  ylab(expression(log(NO[3]~U[t])~(g~m^-2~d^-1)))



no3_D_plot <-ggplot(uptake_dyn, aes(x = (Ndemand), y = (U_NO3_calc), color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.1)) +
 # scale_color_viridis_c(option = "viridis", name = "Day of year") + 
    scale_color_manual(values = siteC_colors) +
      scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                           labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                           labels = scales::label_number()) + 
   # xlim(0, 0.45) +
    geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
  scale_shape_manual(values = c(15, 0, 17, 2)) +theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
 # xlab(expression(log(N~demand)~(g~m^-2~d^-1))) +
  xlab(NULL)+ylab(NULL)
   #ylab(expression(log(NO[3]~U[calc])~(g~m^-2~d^-1)))


nh4_S_plot <-ggplot(uptake_dyn, aes(x = NH4_supply_new, y = U_NH4_calc,color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.1)) +
  #scale_color_viridis_c(option = "viridis", name = "Day of year") +
     # xlim(0, 0.150) +
        scale_x_continuous(trans = "log", 
                           breaks = scales::log_breaks(base = 10), 
                             labels = scales::label_number(),
                                 limits = c(1e-4, 10),) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10),
                         limits = c(1e-4, 1e-1),
                           labels = scales::label_number()
                         ) + 
    geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
      scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) +theme_classic() +
  xlab(expression(log(N~supply)~(g~m^-2~d^-1))) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
   ylab(expression(log(NH[4]~U[t])~(g~m^-2~d^-1)))


nh4_D_plot <-ggplot(uptake_dyn, aes(x = (Ndemand), y = (U_NH4_calc), color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.1)) +
  #scale_color_viridis_c(option = "viridis", name = "Day of year") + 
      scale_color_manual(values = siteC_colors) + 
          scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                               labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10), 
                         limits = c(1e-4, 1e-1),
                           labels = scales::label_number()) + 
    geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
  scale_shape_manual(values = c(15, 0, 17, 2)) +theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  xlab(expression(log(N~demand)~(g~m^-2~d^-1))) + ylab(NULL)
    #  xlim(0, 0.45) +
  # ylab(expression(log(NH[4]~U[calc])~(g~m^-2~d^-1)))

Ndyn_grid <- ggarrange(
  no3_S_plot,
  no3_D_plot,
  nh4_S_plot,
  nh4_D_plot,
  align=c("v"),
  labels = c("a", "b", "c", "d"),
  ncol = 2, nrow = 2,
  common.legend = TRUE, 
  label.x = 0.3, 
  label.y = 1,    
  hjust = 1,  
  vjust = 1,  
  widths = c(0.49, 0.48),
  legend = "bottom")

Ndyn_grid


```



```{r, warning=F, size = 'small', echo=F, include=F, fig.width=9, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/N_uptake_dyn_grid_CH1_v2.png", plot = Ndyn_grid, width = 6.5, height = 5.25, units = "in")


uptake_dyn_sum <- uptake_dyn %>%
  filter(!is.na(Ndemand) & !is.na(NO3_supply_new) & !is.na(NH4_supply_new))
  

```


Uptake (U) approaches supply at BW (U  S; plots a & c). This is less
true for GB where supply is greater than uptake (U \< S) indicating
something other than supply is limiting biologic uptake at GB.

Similarly, U  D at GB (plots b & d), providing additional evidence that
uptake is more limited by biological demand, relative to N supply.

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}

lm_no3_d_gb <- lmer(log(U_NO3_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_no3_d_gb)
r.squaredGLMM(lm_no3_d_gb)

lm_no3_d_bw <- lmer(log(U_NO3_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_no3_d_bw)
r.squaredGLMM(lm_no3_d_bw)

lm_nh4_d_gb <- lmer(log(U_NH4_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_nh4_d_gb)
r.squaredGLMM(lm_nh4_d_gb)

lm_nh4_d_bw <- lmer(log(U_NH4_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_nh4_d_bw)
r.squaredGLMM(lm_nh4_d_bw)

lm_no3_s_gb <- lmer(log(U_NO3_calc+1) ~ scale(NO3_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_no3_s_gb)
r.squaredGLMM(lm_no3_s_gb)


lm_no3_s_bw <- lmer(log(U_NO3_calc+1) ~ scale(NO3_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_no3_s_bw)
r.squaredGLMM(lm_no3_s_bw)


lm_nh4_s_gb <- lmer(log(U_NH4_calc+1) ~ scale(NH4_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_nh4_s_gb)
r.squaredGLMM(lm_nh4_s_gb)


lm_nh4_s_bw <- lmer(log(U_NH4_calc+1) ~ scale(NH4_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_nh4_s_bw)
r.squaredGLMM(lm_nh4_s_bw)


```


```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}
#### Identify High N Demand Events 2021-2023

# Define threshold for high NO3 demand (above 3rd quartile)
high_Ndemand_threshold <- quantile(na.omit(uptake_dyn$Ndemand), probs = 0.75)


# Filter data for high NO3 demand instances
high_Ndemand_sites <- uptake_dyn %>%
  filter(Ndemand > high_Ndemand_threshold) %>%
  dplyr::select(site, date, water_year, jday, Ndemand, NO3_supply_new, U_NO3_calc) %>%
  arrange(desc(Ndemand))  # Sort by highest demand

# Summary statistics of high-demand occurrences by site
high_Ndemand_summary <- high_Ndemand_sites %>%
  group_by(site) %>%
  summarize(
    count = n(),
    mean_Ndemand = mean(Ndemand, na.rm = TRUE),
    max_Ndemand = max(Ndemand, na.rm = TRUE),
    earliest_date = min(date, na.rm = TRUE),
    latest_date = max(date, na.rm = TRUE)
  ) %>%
  arrange(desc(count))

# Print summary table
print(high_Ndemand_summary)
```


```{r, warning=F, size = 'small', echo=F, include=F, fig.width=9, fig.height=6}
#### Identify High NO3 supply Events 2021-2023

# Define threshold for high NO3 demand (above 3rd quartile)
high_NO3_sup_threshold <- quantile(na.omit(uptake_dyn$NO3_supply_new), probs = 0.75)

# Filter data for high NO3 demand instances
high_NO3_sup_sites <- uptake_dyn %>%
  filter(NO3_supply > high_NO3_sup_threshold) %>%
 dplyr:: select(site, date, water_year, jday, Ndemand, NO3_supply_new, U_NO3_calc) %>%
  arrange(desc(NO3_supply_new))  # Sort by highest demand

# Summary statistics of high-demand occurrences by site
high_NO3_supply_summary <- high_NO3_sup_sites %>%
  group_by(site) %>%
  summarize(
    count = n(),
    mean_NO3_supply = mean(NO3_supply_new, na.rm = TRUE),
    max_NO3_supply = max(NO3_supply_new, na.rm = TRUE),
    earliest_date = min(date, na.rm = TRUE),
    latest_date = max(date, na.rm = TRUE)
  ) %>%
  arrange(desc(count))

# Print summary table
print(high_NO3_supply_summary)
```


```{r, warning=F, size = 'small', echo=F, include=F, fig.width=9, fig.height=6}
#### Identify High NH4 supply Events 2021-2023

# Define threshold for high NO3 demand (above 3rd quartile)
high_NH4_sup_threshold <- quantile(na.omit(uptake_dyn$NH4_supply_new), probs = 0.75)

# Filter data for high NO3 demand instances
high_NH4_sup_sites <- uptake_dyn %>%
  filter(NH4_supply > high_NH4_sup_threshold) %>%
 dplyr:: select(site, date, water_year, jday, Ndemand, NH4_supply_new, U_NH4_calc) %>%
  arrange(desc(NH4_supply_new))  # Sort by highest demand

# Summary statistics of high-demand occurrences by site
high_NH4_supply_summary <- high_NH4_sup_sites %>%
  group_by(site) %>%
  summarize(
    count = n(),
    mean_NH4_supply = mean(NH4_supply_new, na.rm = TRUE),
    max_NH4_supply = max(NH4_supply_new, na.rm = TRUE),
    earliest_date = min(date, na.rm = TRUE),
    latest_date = max(date, na.rm = TRUE)
  ) %>%
  arrange(desc(count))

# Print summary table
print(high_NH4_supply_summary)
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}
# Plot high NO3 demand over time
TS_high_N_demand<- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = date, y = Ndemand, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  geom_hline(yintercept = high_Ndemand_threshold, linetype = "dashed", color = "grey25") +
  labs(title = "N Demand Over Time",
       x = "Date",
       y = "N Demand (g N/m/day)") +
  theme_classic()


TS_high_NO3_sup <- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = date, y = NO3_supply_new, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  geom_hline(yintercept = high_NO3_sup_threshold, linetype = "dashed", color = "grey25") +
  labs(title = "NO3 Supply Over Time",
       x = "Date",
       y = "NO3 Supply (g N/m/day)") +
  theme_classic()


TS_high_NH4_sup <- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = date, y = NH4_supply_new, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  geom_hline(yintercept = high_NH4_sup_threshold, linetype = "dashed", color = "grey25") +
  labs(title = "NH4 Supply Over Time",
       x = "Date",
       y = "NH4 Supply (g N/m/day)") +
  theme_classic()
```

#### Optional supplemental plot of daily demand and suppply 2021-2023

Dashed horizontal lines are the 75th quantile of each response.

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=8}

Ndyn_grid <- ggarrange(
  TS_high_N_demand,
  TS_high_NO3_sup,
  TS_high_NH4_sup,
  align = c("v"),
  ncol = 1, nrow = 3,
  labels = c("a", "b", "c"),
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid

```

Demand highest in 2021 and typically peaks in fall. 
Supply for NH4 or NO3 appears to be low in 2021, with slight elevation in 2023. 
Supply for either N is typically higher at GB relative to BW.

#### Fractional uptake efficiency for each nitrogen type:

A value close to 1 suggests high efficiency, meaning most of the
supplied nitrogen was absorbed, while a value close to 0 suggests that
most of the supplied nitrogen remained in the system

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=3}
uptake_dyn2 <- uptake_dyn %>%
  mutate(
    frac_NO3_uptake = U_NO3_calc / NO3_supply_new,
    frac_NH4_uptake = U_NH4_calc / NH4_supply_new,
    frac_N_uptake = (U_NH4_calc + U_NO3_calc) / (NH4_supply_new+NO3_supply_new)
  ) %>%
      mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  ))

uptake_dyn2 <- uptake_dyn2 %>%
  mutate(
    frac_NO3_uptake = ifelse(NO3_supply_new > 0, U_NO3_calc / NO3_supply_new, NA), ## unit less
    frac_NH4_uptake = ifelse(NH4_supply_new > 0, U_NH4_calc / NH4_supply_new, NA)
  )

hist1<- ggplot(uptake_dyn2, aes(x = frac_NH4_uptake)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_classic() +
     xlab(expression(FUE~NH[4]))


hist2<- ggplot(uptake_dyn2, aes(x = frac_NO3_uptake)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_classic() +
   xlab(expression(FUE~NO[3]))

```

```{r, warning=F, size = 'small', echo=F,include=T, fig.width=6, fig.height=4}

Ndyn_grid <- ggarrange(
  hist1,
  hist2,
  align = c("v"),
  ncol = 1, nrow = 2,
    labels = c("a", "b"),
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid
```


#### Summary of fractional uptake of N from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
uptake_dyn_sum <- uptake_dyn2%>%
  filter(water_year<2024)%>%
  group_by(site, WY_lab) %>%
  summarise(frac_NO3_uptake = mean(frac_NO3_uptake, na.rm=T),
           frac_NH4_uptake = mean(frac_NH4_uptake, na.rm=T),
           frac_N_uptake = mean(frac_N_uptake, na.rm=T),
           N_demand = mean(Ndemand, na.rm=T),
           NO3_supply = mean(NO3_supply_new, na.rm=T),
           NH4_supply = mean(NH4_supply_new, na.rm=T),
          NO3_mgL = mean(NO3_mgL_i, na.rm=T),
           NH4_mgL = mean(NH4_mgL_i, na.rm=T))
  
uptake_dyn_sum


uptake_dyn_bw <- uptake_dyn2 %>%
  filter(site=="BWU")

summary(uptake_dyn_bw)

```

##### Percent change in FUE by reach for NO3, NH4, and total N (NO3+NH4) from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
uptake_dyn_wide <- uptake_dyn_sum %>%
  pivot_wider(names_from = WY_lab, values_from = c(frac_NO3_uptake, frac_NH4_uptake, frac_N_uptake, 
                                                   N_demand, NO3_supply, NH4_supply, 
                                                   NO3_mgL, NH4_mgL))

# Calculate percent change from Dry to Wet years
uptake_dyn_wide1 <- uptake_dyn_wide %>%
  mutate(
    pct_FUE_NO3 = round((((frac_NO3_uptake_wet - frac_NO3_uptake_dry) / frac_NO3_uptake_dry) * 100), 1),
    pct_FUE_NH4 = round((((frac_NH4_uptake_wet - frac_NH4_uptake_dry) / frac_NH4_uptake_dry) * 100), 1),
    pct_FUE_N = round((((frac_N_uptake_wet - frac_N_uptake_dry) / frac_N_uptake_dry) * 100),1),
    pct_demand = round((((N_demand_wet - N_demand_dry) / N_demand_dry) * 100),1),
    pct_NO3_supply = round((((NO3_supply_wet - NO3_supply_dry) / NO3_supply_dry) * 100),1),
    pct_NH4_supply = round((((NH4_supply_wet - NH4_supply_dry) / NH4_supply_dry) * 100),1),
    pct_NO3 = round((((NO3_mgL_wet - NO3_mgL_dry) / NO3_mgL_dry) * 100),1),
    pct_NH4 = round((((NH4_mgL_wet - NH4_mgL_dry) / NH4_mgL_dry) * 100),1)) %>%
  dplyr::select(site, pct_FUE_NO3, pct_FUE_NH4, pct_FUE_N,
                pct_demand, pct_NO3_supply, pct_NH4_supply, pct_NO3, pct_NH4)

uptake_dyn_wide1

```

Fractional uptake efficiency appeared to decrease from dry to wet years
for both NO3 NH4.

### Nitrogen dynamics within streams from upper to lower reaches:

#### Looking at possible nitrogen retention with BW or GB:

-   NO/NH retention fraction close to 1: Most nitrogen is
    processed/retained before reaching the lower reach.

-   NO/NH retention fraction close to 0: Most nitrogen passes
    downstream unchanged.

-   Negative retention values: suggest an increase in nitrogen
    downstream, possibly from inputs like tributaries or groundwater

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=9, fig.height=3}
# Define reach lengths
bw_reach_length <- 4150  # meters (BWU to BWL)
gb_reach_length <- 1100  # meters (GBU to GBL)

# Calculate NO3 and NH4 retention with reach area
reach_rent <- uptake_dyn %>%
  filter(site %in% c("BWU", "BWL", "GBU", "GBL")) %>%
  group_by(catch, date) %>%
  summarize(
    NO3_supply_upper = NO3_supply_new[site %in% c("BWU", "GBU")],
    NO3_supply_lower = NO3_supply_new[site %in% c("BWL", "GBL")],
    NH4_supply_upper = NH4_supply_new[site %in% c("BWU", "GBU")],
    NH4_supply_lower = NH4_supply_new[site %in% c("BWL", "GBL")],
    U_NO3_upper = U_NO3_calc[site %in% c("BWU", "GBU")],
    U_NO3_lower = U_NO3_calc[site %in% c("BWL", "GBL")],
    U_NH4_upper = U_NH4_calc[site %in% c("BWU", "GBU")],
    U_NH4_lower = U_NH4_calc[site %in% c("BWL", "GBL")],
    NO3_upper = NO3_mgL_i[site %in% c("BWU", "GBU")],
    NO3_lower = NO3_mgL_i[site %in% c("BWL", "GBL")],
    NH4_upper = NH4_mgL_i[site %in% c("BWU", "GBU")],
    NH4_lower = NH4_mgL_i[site %in% c("BWL", "GBL")],
    w_m_upper = w_m[site %in% c("BWU", "GBU")],  # Stream width for upper reach
    w_m_lower = w_m[site %in% c("BWL", "GBL")]   # Stream width for lower reach
  ) %>%
  mutate(
    # Assign reach length based on the system
    reach_length = case_when(
      catch == "BW" ~ bw_reach_length,
      catch == "GB" ~ gb_reach_length
    ),
    # Calculate reach area (reach length * width)
    reach_area = reach_length * ((w_m_upper + w_m_lower) / 2),  # Average width
    
    # Calculate NO3 and NH4 retention fractions
    NO3_retention = 1 - (NO3_supply_lower / NO3_supply_upper),
    NH4_retention = 1 - (NH4_supply_lower / NH4_supply_upper),
    
    # Calculate processed nitrogen (g/m2/day  reach area)
    NO3_processed = (NO3_supply_upper - NO3_supply_lower) * reach_area,
    NH4_processed = (NH4_supply_upper - NH4_supply_lower) * reach_area,
    NO3_processedi = (NO3_upper - NO3_lower) * reach_area,
    NH4_processedi = (NH4_upper - NH4_lower) * reach_area
  )%>%
  mutate(jday=yday(date))

reach_rent<- water_year(reach_rent)
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=3}

hist1<- ggplot(reach_rent, aes(x = NO3_retention)) +
  geom_density(alpha = 0.7, aes(fill = catch,  color = catch)) +
  scale_color_manual(values = catch_colors)  + xlim(-2.5,1) +
  scale_fill_manual(values = catch_colors) + theme_minimal() +
      geom_vline(xintercept = 0, linetype = "dashed", color = "grey", size = 1) + 
      geom_vline(xintercept = 1, linetype = "dotted", color = "grey25", size = 1) +
  xlab(expression(NO[3]~retention~between~reaches))


hist2<-ggplot(reach_rent, aes(x = NH4_retention)) +
 # geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 5) +  scale_color_manual(values = site_colors) + 
  geom_density(alpha = 0.7, aes(fill = catch,  color = catch)) +
  scale_color_manual(values = catch_colors)  + 
  xlim(-2.5,1) +
  scale_fill_manual(values = catch_colors) + theme_minimal() +
      geom_vline(xintercept = 0, linetype = "dashed", color = "grey", size = 1) + 
      geom_vline(xintercept = 1, linetype = "dotted", color = "grey25", size = 1) +
  xlab(expression(NH[4]~retention~between~reaches)) 
hist2



```


```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}

date_range <- range(as.Date("2021-03-20"), as.Date("2023-11-01"))

Rent_NO3_plt <- ggplot(reach_rent%>%filter(water_year<2024), aes(x = date, y = NO3_retention, color = catch, shape = catch)) +
  geom_point(size = 2, alpha = 0.7, position = position_dodge(width = 0.3)) +
      scale_color_manual(values = catch_colors) +
  geom_point(size = 2, alpha = 0.7) +
  xlab(NULL) +
    scale_x_date(date_breaks = "4 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
        geom_hline(yintercept = 1, linetype = "dotted", color = "grey25") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
   ylab(expression(Fractional~NO[3]~retention)) +
    scale_shape_manual(values = c(15, 17)) +
  theme_classic()

p_NO3 <- ggExtra::ggMarginal(Rent_NO3_plt + theme(legend.position = "none"), 
                         type = "density",
                         margins = "y",  # Only add density plot on the right (y-axis)
                         size = 4, 
                         groupFill = TRUE, 
                         alpha = 0.7)


Rent_NH4_plt <- ggplot(reach_rent %>% filter(water_year < 2024), 
                       aes(x = date, y = NH4_retention, color = catch, shape = catch)) +
  geom_point(size = 2, alpha = 0.7, position = position_dodge(width = 0.3)) +
  geom_point(size = 2, alpha = 0.7) +
      scale_x_date(date_breaks = "4 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
    scale_color_manual(values = catch_colors) +
  geom_hline(yintercept = 1, linetype = "dotted", color = "grey25") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  ylab(expression(Fractional~NH[4]~retention)) +
  scale_shape_manual(values = c(15, 17)) +
  xlab("Date (month-yr)") +
  theme_classic()

p_Nh4 <- ggExtra::ggMarginal(Rent_NH4_plt + theme(legend.position = "none"), 
                         type = "density",
                         margins = "y",  # Only add density plot on the right (y-axis)
                         size = 4, 
                         groupFill = TRUE, 
                         alpha = 0.7)
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}

Ndyn_grid <- ggarrange(
  Rent_NO3_plt,
  Rent_NH4_plt,
  ncol = 1, nrow = 2,
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid

```

### **Figure 7**

Fraction nitrogen retention between reaches:


```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}

Ndyn_grid <- ggarrange(
  p_NO3,
  p_Nh4,
  labels = c("a", "b"),
  align=c("v"),
  label.x = 0.12, 
  label.y = 1,    
  hjust = 1,  
  vjust = 1,  
  ncol = 1, nrow = 2) #,
 # common.legend = TRUE, 
#  legend = "bottom")

Ndyn_grid

```


```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}

# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Reach_retention_CH1.png", plot = Ndyn_grid, width = 6.5, height = 4, units = "in")


```

#### Summarize stream N uptake of N from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
reach_rent_sum <- reach_rent%>%
   mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  ))

reach_rent_sum <- reach_rent_sum %>%
  filter(water_year<2024)%>%
  group_by(catch, WY_lab) %>%
  summarise(NO3_retention = mean(NO3_retention, na.rm=T),
           NH4_retention = mean(NH4_retention, na.rm=T),
           NO3_processed = mean(NO3_processedi, na.rm=T),
           NH4_processed = mean(NH4_processedi, na.rm=T)
           )
reach_rent_sum

date_range <- reach_rent %>%
  filter(water_year<2024) %>%
   filter(!is.na(NH4_retention) | !is.na(NO3_retention)) %>%
  group_by(catch) %>%
  summarize(
    start_date = min(date, na.rm = TRUE),
    end_date = max(date, na.rm = TRUE)
  )

print(date_range)
```

##### Percent change in FUE by reach for NO3, NH4, and total N (NO3+NH4) from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
reach_rent_wide <- reach_rent_sum %>%
  pivot_wider(names_from = WY_lab, values_from = c(NO3_retention, NH4_retention, NO3_processed, 
                                                   NH4_processed))

# Calculate percent change from Dry to Wet years
reach_rent_wide1 <- reach_rent_wide %>%
  mutate(
    pct_NO3_retention = round((((NO3_retention_dry - NO3_retention_wet) / NO3_retention_dry) * 100), 1),
    pct_NH4_retention = round((((NH4_retention_dry - NH4_retention_wet) / NH4_retention_dry) * 100), 1),
    pct_NO3_proc = round((((NO3_processed_wet - NO3_processed_dry) / NO3_processed_dry) * 100),1),
    pct_NH4_proc = round((((NH4_processed_wet - NH4_processed_dry) / NH4_processed_dry) * 100),1)) %>%
  dplyr::select(catch, pct_NO3_retention, pct_NH4_retention, pct_NO3_proc, pct_NH4_proc)

reach_rent_wide1

```



```{r, warning=F, size = 'small', echo=F, include=FALSE}

covariat_nsupply <- covariat_datqI %>%
  left_join(nitrogen_data, by=c("date", "site")) %>%
  mutate(
    K600_daily_mean = case_when(
      is.na(K600_daily_mean) & site == "BWL" ~ 22, 
      is.na(K600_daily_mean) & site == "BWU" ~ 16,
      is.na(K600_daily_mean) & site == "GBU" ~ 32,
      is.na(K600_daily_mean) & site == "GBL" ~ 25,
      TRUE ~ K600_daily_mean)) %>%
  mutate(Q_Ls = Q_m * 1000, # flow from csm to Ls
  # calculate reach length in m
  reachL = c((v_m_apr*w_m_apr*8640)/K600_daily_mean), # seconds to days
   # Calculate no3 supply 
  NO3_supply = c(((86400*Q_Ls*(NO3_mgL_dl_sw/1000))/(w_m_apr*reachL))),
  NO3_supply_new = c(((86400*Q_Ls*(NO3_mgL_i/1000))/(w_m_apr*reachL))),

   # Calculate nh3 supply 
  NH4_supply = c(((86400*Q_Ls*(NH4_mgL_dl_sw/1000))/(w_m_apr*reachL))), ## unit should be g N m-2 d-1
 NH4_supply_new = c(((86400*Q_Ls*(NH4_mgL_i/1000))/(w_m_apr*reachL))),
  PO4_supply = c(((86400*Q_Ls*(PO4_ugL_dl_sw/1e-6))/(w_m_apr*reachL))) ## unit should be g N m-2 d-1
   ) 



BWL_DF <- nitrogen_data%>%
  filter(site=="BWL") %>%
  dplyr::select(site, date, NO3_mgL_i, NH4_mgL_i)

summary_mean <- BWL_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- BWL_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- BWL_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max





BWU_DF <- nitrogen_data%>%
  filter(site=="BWU") %>%
  dplyr::select(site, date, NO3_mgL_i, NH4_mgL_i)

summary_mean <- BWU_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- BWU_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- BWU_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max





GBL_DF <- nitrogen_data%>%
  filter(site=="GBL") %>%
  dplyr::select(site, date, NO3_mgL_i, NH4_mgL_i)

summary_mean <- GBL_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- GBL_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- GBL_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max



GBU_DF <- nitrogen_data%>%
  filter(site=="GBU") %>%
  dplyr::select(site, date, NO3_mgL_i, NH4_mgL_i)

summary_mean <- GBU_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- GBU_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- GBU_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max

```



```{r, warning=F, size = 'small', echo=F, include=FALSE}

uptake_comp <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/uptake_rate_comparisons.csv")

uptake_comp_s <- uptake_comp%>%
  group_by(source) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop") 


uptake_comp_s <- uptake_comp%>%
  group_by(source) %>%
  summarise(across(everything(), min, na.rm = TRUE), .groups = "drop") 
  

str(uptake_comp)


# p3 <- ggplot(uptake_comp, aes(x = Biogeocliatic.region, y = U_mg_N_m2_d, color = source, shape = shaded)) +
#   geom_point(position = position_jitter(width = 0.25, height = 0), size = 3, alpha = 0.75) +
#     scale_color_manual(values=c("#054fb9","#054fb9", 
#                                 "#d1b736",
#                                 "#DD6E42", "#DD6E42", 
#                                 "#440154", "#4bcc94")) + theme_classic()


p1 <- ggplot(uptake_comp, aes(x = Biogeocliatic.region, y = U_mg_N_m2_d, color = source, shape = source)) +
  geom_point(position = position_jitter(width = 0.25, height = 0), size = 2, alpha = 0.75) +
  scale_shape_manual(values = c(15, 0, 
                                3, 17, 2,
                                19, 18)) +
    scale_color_manual(values=c("#054fb9","#054fb9", 
                                "#d1b736",
                                "#DD6E42", "#DD6E42", 
                                "#440154", "#4bcc94")) + theme_classic() +
  xlab("Biogeoclimatic region") + ylab(expression(Nitrogen~U[t]~(mg~m^-2~d^-1)))



p2 <- ggplot(uptake_comp, aes(x = GPP, y = U_mg_N_m2_d, color = source, shape = source)) +
    geom_point(size = 2, alpha = 0.75) +
    scale_shape_manual(values = c(15, 0, 
                                3, 17, 2,
                                19, 18)) +
    scale_color_manual(values=c("#054fb9","#054fb9", 
                                "#d1b736",
                                "#DD6E42", "#DD6E42", 
                                "#440154", "#4bcc94")) + theme_classic() +
  xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) + ylab(expression(Nitrogen~U[t]~(mg~m^-2~d^-1))) +
  theme(legend.position = "none")




p3 <- ggplot(uptake_comp, aes(x = ER, y = U_mg_N_m2_d, color = source, shape = source)) +
    geom_point(size = 2, alpha = 0.75) +
    scale_shape_manual(values = c(15, 0, 
                                3, 17, 2,
                                19, 18)) +
    scale_color_manual(values=c("#054fb9","#054fb9", 
                                "#d1b736",
                                "#DD6E42", "#DD6E42", 
                                "#440154", "#4bcc94")) + theme_classic() +
    xlab(expression("|"~ER~"|"~(g~O[2]~m^-2~d^-1)))  + ylab(NULL) +
    theme(legend.position = "none")



p4 <- ggplot(uptake_comp, aes(x = discharge_L_s, y = U_mg_N_m2_d, color = source, shape = source)) +
    geom_point(size = 2, alpha = 0.75) +
    scale_shape_manual(values = c(15, 0, 
                                3, 17, 2,
                                19, 18)) +
    scale_color_manual(values=c("#054fb9","#054fb9", 
                                "#d1b736",
                                "#DD6E42", "#DD6E42", 
                                "#440154", "#4bcc94")) + theme_classic() +
    xlab(expression(Q~(L~s^-1))) + ylab(NULL) +
    theme(legend.position = "none")




```


### **Figure 8**

Contextualizing Nitrogen uptake and productivity to other studies

```{r, warning=F, size = 'small', echo=F,include=T, fig.width=10, fig.height=5}

n_s_grid <- ggarrange(
  p2,
  p3,
  p4,
  labels = c("b", "c", "d"),
  ncol = 3, nrow = 1,
  label.x = 0.95, 
  label.y = 1,    
  hjust = 1,  
  vjust = 1    
)




Ndyn_grid <- ggarrange(
  p1,
  n_s_grid,
  ncol = 1, nrow = 2,
  labels = c("a", ""),
  label.x = 0.12,
  label.y = 1,    
  hjust = 1,      
  vjust = 1)    

Ndyn_grid

```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=9, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/N_uptake_comp_grid_CH1.png", plot = Ndyn_grid, width = 6.5, height = 4.75, units = "in")

```


#### Extra stuff from first draft of MS:


```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
library(lmerTest)
library(MuMIn)
mod1 <- lmer(log(GPP_mean+1) ~ scale(AFDM_ugcm2) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)


mod1 <- lmer(log(GPP_mean+1) ~ scale(Chla_ugL_Q) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)

mod1 <- lmer(log(Chla_ugL_Q+1) ~ scale(AFDM_ugcm2) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)

mod1 <- lmer(log((ER_mean*-1)+1) ~ scale(AFDM_ugcm2) + (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)


mod1 <- lmer(log((ER_mean*-1)+1)  ~ scale(AFDM_mgg) + (1|site)+ (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)

mod1 <- lmer(log((ER_mean*-1)+1)  ~ scale(Chla_ugL_Q) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

BM_cor_plt <- ggplot(covariat_datq, aes(x =AFDM_ugcm2, y = GPP_mean)) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
      # geom_smooth(data = covariat_datq%>%filter(catch=="BW") , aes(color = "grey50"), method = "lm", se = FALSE, alpha = 0.5) + 
            scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                               labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10), 
                           labels = scales::label_number()) + 
   ylab(expression(log(GPP)~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Biomass)~(g~cm^-2))) +
  scale_color_manual(values = catch_colors)

BM_cor_plt1 <- ggplot(covariat_datq, aes(x = (Chla_ugL_Q), y = (GPP_mean))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
              scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                               labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10), 
                           labels = scales::label_number()) + 
      geom_smooth(aes(color = "grey50"), method = "lm", se = FALSE, alpha = 0.5) + 
  ylab(expression(log(GPP)~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Chla)~(g~L^-1))) +
  scale_color_manual(values = catch_colors)

BM_cor_plt2 <- ggplot(covariat_datq, aes(y = (Chla_ugL_Q), x = (AFDM_ugcm2))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
      geom_smooth(aes(color = "grey50"), method = "lm", se = FALSE, alpha = 0.5) + 
  theme_classic() + 
                scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                               labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10), 
                           labels = scales::label_number()) + 
  xlab(expression(log(Biomass)~(g~cm^-2))) +
  ylab(expression(log(Chla)~(g~L^-1))) +
  scale_color_manual(values = catch_colors)


BM_cor_plt3 <- ggplot(covariat_datq, aes(x = (AFDM_ugcm2), y = ((ER_mean*-1)))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
                  scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                               labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10), 
                           labels = scales::label_number()) + 
  ylab(expression(log(abs(ER))~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Biomass)~(g~cm^-2))) +
  scale_color_manual(values = catch_colors)


BM_cor_plt4 <- ggplot(covariat_datq, aes(x = (Chla_ugL_Q), y = ((ER_mean*-1)))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
  scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                               labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10), 
                           labels = scales::label_number()) + 
   # geom_smooth(aes(color = catch), method = "lm", se = FALSE, alpha = 0.5, lty="dashed") + 
    ylab(expression(log(abs(ER))~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Chla)~(g~L^-1))) +
  scale_color_manual(values = catch_colors)


BM_cor_plt5 <- ggplot(covariat_datq, aes(x = (AFDM_mgg), y = ((ER_mean*-1)))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
  scale_x_continuous(trans = "log", breaks = scales::log_breaks(base = 10),
                               labels = scales::label_number()) + 
      scale_y_continuous(trans = "log", 
                         breaks = scales::log_breaks(base = 10), 
                           labels = scales::label_number()) + 
    ylab(expression(log(abs(ER))~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(OM)~(mg~g^-1))) +
  scale_color_manual(values = catch_colors)

```

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=8, fig.height=7}
BP_grid <- ggarrange(
  BM_cor_plt,
  BM_cor_plt1,
  BM_cor_plt2,
  BM_cor_plt3,
  BM_cor_plt4,
  BM_cor_plt5,
  align = c("v"),
  labels = c("a", "b", "c",
             "d", "e", "f"),
  ncol = 3, nrow = 2,
  common.legend = TRUE,
  legend = "right"
)

BP_grid
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/BP_grid_CH1.png", plot = BP_grid, width = 8.5, height = 4.75, units = "in")

```




#### Looking at stoichiometeric ratios of N:P overtime?

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

names(ndyn)

Stoich_df <- ndyn %>%
  mutate(
    jday= yday(date),
    NO3_uM_pw = (NO3_mgL_dl_pw * 1000) / 62.0049,  # Convert NO3 to mol/L
    NH4_uM_pw = (NH4_mgL_dl_pw * 1000) / 18.0385,  # Convert NH4 to mol/L
    PO4_uM_pw = PO4_ugL_dl_pw / 30.9738,  # Convert PO4 to mol/L
    Tot_N_uM_pw = NO3_uM_pw + NH4_uM_pw,  # Total nitrogen in mol/L
    N_P_ratio_pw = if_else(PO4_uM_pw > 0, Tot_N_uM_pw / PO4_uM_pw, NA_real_),  # Avoid division by zero
    
    NO3_uM_sw = (NO3_mgL_i * 1000) / 62.0049,  # Convert NO3 to mol/L
    NH4_uM_sw = (NH4_mgL_i * 1000) / 18.0385,  # Convert NH4 to mol/L
    PO4_uM_sw = PO4_ugL_dl_sw.y / 30.9738,  # Convert PO4 to mol/L
    Tot_N_uM_sw = NO3_uM_sw + NH4_uM_sw,  # Total nitrogen in mol/L
    N_P_ratio_sw = if_else(PO4_uM_sw > 0, Tot_N_uM_sw / PO4_uM_sw, NA_real_)
  )

Stoich_df < water_year(Stoich_df)
```


### N:P

Looks like N:P \<16 across most observations

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=9, fig.height=4}

N_P_ratio_plots_sw <- ggplot(Stoich_df %>%filter(water_year<2024), aes(x = jday, y = N_P_ratio_sw, color = site)) +
  geom_point(size = 2, alpha = 0.75, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = site_colors) +
  geom_hline(yintercept = 16) +
   ylab(expression(N:P~(umol~L^-1))) +
     xlab("Day of year") +
  facet_grid(.~water_year) +
  theme_classic()

N_P_ratio_plots_sw
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=5, fig.height=4}
N_P_ratio_plots <- ggplot(Stoich_df %>%filter(water_year<2024), aes(y = GPP_mean, x = N_P_ratio_sw, color = site)) +
  geom_point(size = 2, alpha = 0.75, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = site_colors) +
   xlab(expression(N:P~(umol~L^-1))) +
  #facet_grid(.~water_year) +
  theme_classic()

N_P_ratio_plots
```


#### Table of mean N:P ratios by site


```{r, warning=F, size = 'small', echo=F, fig.width=5, include=FALSE,fig.height=4}

Stoich_table_sum <- Stoich_df%>%
  filter(!is.na(N_P_ratio_sw))%>%
  filter(N_P_ratio_sw>15.5) 

#32 total 107

Stoich_plot <- Stoich_df %>%
  filter(water_year<2024) %>%
  group_by(site, water_year) %>%
  dplyr::summarise(
    Tot_N_uMm = round(mean(Tot_N_uM_sw, na.rm = TRUE), 3),
    N_P_ratiom = round(mean(N_P_ratio_sw, na.rm = TRUE), 4),
    N_P_sd = round(sd(N_P_ratio_sw, na.rm = TRUE), 4),
    N_P_se = round(sd(N_P_ratio_sw, na.rm = TRUE) / sqrt(sum(!is.na(N_P_ratio_sw))), 4)  # Standard Error
  ) %>%
  mutate(
    N_P_sd = if_else(is.na(N_P_sd), N_P_ratiom, N_P_sd),  # Replace NA SD with mean
    N_P_se = if_else(is.na(N_P_se), 0, N_P_se)  # Replace NA SE with 0
  )

```

```{r, warning=F, size = 'small', echo=F, fig.width=5, include=FALSE,fig.height=4}

covariat_stats <- covariat_NS_ND%>%
  filter(water_year<2024) %>%
      mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    TRUE ~ NA_character_  
  )) %>%
  group_by(site, WY_lab) %>%
summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")


library(dplyr)

# Calculate percentage change from dry to wet for each site
covariat_stats_summary <- covariat_stats %>%
  group_by(site, WY_lab) %>%
  summarise(across(c(Ndemand, NO3_supply_new, NH4_supply_new), mean, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = WY_lab, values_from = c(Ndemand, NO3_supply_new, NH4_supply_new)) %>%
  mutate(
    Ndemand_pct_change = ((Ndemand_wet - Ndemand_dry) / Ndemand_dry) * 100,
    NO3_supply_new_pct_change = ((NO3_supply_new_wet - NO3_supply_new_dry) / NO3_supply_new_dry) * 100,
    NH4_supply_new_pct_change = ((NH4_supply_new_wet - NH4_supply_new_dry) / NH4_supply_new_dry) * 100
  )

# View the result
print(covariat_stats_summary)

```


###  box plots 

```{r, warning=F, size = 'small', echo=F, fig.width=5, include=FALSE,fig.height=4}

covariat_dat_bp <- covariat_datq %>%
  mutate(week = week(date))

# Find how many unique water years are in the data
n_years <- covariat_dat_bp %>%
  filter(site == "BWL") %>%
  pull(water_year) %>%
  unique() %>%
  length()

# Filter weeks with non-NA GPP_mean in all water years
valid_weeks <- covariat_dat_bp_BW %>%
  filter(site == "BWL", !is.na(GPP_mean)) %>%
  mutate(week = week(date)) %>%
  group_by(week, water_year) %>%
  summarise(n_nonNA = n(), .groups = "drop") %>%
  group_by(week) %>%
  summarise(n_years_with_data = n_distinct(water_year)) %>%
  filter(n_years_with_data == n_years) %>%
  pull(week)

# Define the water years you want on the x-axis, including 2021
desired_years <- c("2021", "2022", "2023")

plot_BW_OM <- ggplot(
  covariat_dat_bp %>% 
    filter(site == "BWL", water_year %in% 2022:2023),  # only show 20222023 data
  aes(x = factor(water_year, levels = desired_years), y = AFDM_mgg, fill = factor(water_year))) +
  
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  geom_jitter(aes(color = factor(catch)),
              size = 1.5, alpha = 0.25,
              width = 0.2, height = 0, shape = 15) +
  
  # Optional: Add a dummy transparent box for 2021 to keep the spacing (not strictly needed if axis levels are set)
  # geom_blank(data = covariat_dat_bp %>% filter(water_year == 2021), aes(x = factor(2021), y = 10)) +

  scale_color_manual(values = catch_colors) +
  scale_fill_manual(values = c("2021" = "#440154", "2022" = "#3B528B", "2023" = "#4bcc94")) +
  ylab(expression(OM~(mg~g^-1))) + 
  labs(x = "BW Lower", fill = "Water Year", color = "Catchment", shape = "Catchment") +
  theme_minimal()


```




```{r, warning=F, size = 'small', echo=F, fig.width=5, include=FALSE,fig.height=4}

covariat_dat_bp <- covariat_datq %>%
  mutate(week = week(date))

# Define the water years you want on the x-axis, including 2021
desired_years <- c("2021", "2022", "2023")

plot_Nsupply <- ggplot(
  uptake_dyn2 %>% 
    filter(site == "BWL", water_year %in% 2021:2023),  # only show 20222023 data
  aes(x = factor(water_year, levels = desired_years), y = NO3_supply, fill = factor(water_year))) +
  
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  geom_jitter(aes(color = factor(catch)),
              size = 1.5, alpha = 0.25,
              width = 0.2, height = 0, shape = 15) +
  
  # Optional: Add a dummy transparent box for 2021 to keep the spacing (not strictly needed if axis levels are set)
  # geom_blank(data = covariat_dat_bp %>% filter(water_year == 2021), aes(x = factor(2021), y = 10)) +

  scale_color_manual(values = catch_colors) +
  scale_fill_manual(values = c("2021" = "#440154", "2022" = "#3B528B", "2023" = "#4bcc94")) +
  ylab(expression(OM~(mg~g^-1))) + 
  labs(x = "BW Lower", fill = "Water Year", color = "Catchment", shape = "Catchment") +
  theme_minimal()



```


## Final thoughts:

### Main points:

-   **Overall** across all reaches there is low nitrogen demand, low
    uptake, and moderate nitrogen supply.

    -   Peak nitrogen supply tends to occur ahead of peak demand.

    -   Nitrogen supply increased increased from wet to dry years, while
        nitrogen demand and fractional uptake efficiency (FUE) both
        decreased.

    -   FUE is higher for NH4 relative to NO3

#### Stream specifics nitrogen dynamics:

-   **GB:** N supply is greater than demand at GB  indicating that
    uptake (U) should be low and possibly limited by low biologic
    demand.

    -   FUE also tends to be near 0 at GB

    -   There are some negative values of nitrogen retention between
        upper and lower reaches suggesting some other source of nitrogen
        is present downstream of GBU (likely groundwater).

    -   So we expect more nitrogen to be transported relative to the
        amount transformed or retained in GB.

-   **BW:** N demand can be greater than nitrogen supply at BW -- U
    tends to be more related to supply dynamics.

    -   FUE tends to be near 1.

    -   Most nitrogen retention between upper and lower reaches appears
        to between 0 and 1 suggesting it could be retained or processed
        between the upper and lower reaches.

    -   Relative to GB, BW can actually process or retain a large
        portion of the nitrogen concentrations in stream water, despite
        being a larger stream.

    
    
    