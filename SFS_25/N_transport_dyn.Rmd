---
title: 'Nitrogen dynamics for MS draft: Spatiotemporal variation in mountain stream metabolism and nitrogen cycling across contrasting flow regimes '
author: "Kelly Loria"
date: "`r Sys.Date()`"
output:
   html_document:
    theme: simplex
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style type="text/css">
body, td {font-size: 13px;}
code.r{font-size: 9px;}
pre {font-size: 11px}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = F, message = F)
knitr::opts_knit$set(root.dir = '/Users/kellyloria/Documents/Publications/')
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

```

```{r, echo = F, message = F, include=FALSE}
### Packages
#setwd("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/BWL_k600/")
lapply(c("plyr","dplyr","ggplot2","cowplot",
         "lubridate","tidyverse", "reshape2", "ggpubr", "ggpattern", "broom.mixed",
         "glmmTMB",
         "lme4", "lmerTest", "MuMIn", "PerformanceAnalytics", "car"), require, character.only=T)
```

## 

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
daoc_date<- Sys.Date()

lapply(c("plyr","dplyr","ggplot2","cowplot",
         "lubridate","tidyverse", "reshape2", "ggpubr", "ggpattern",
         "lme4", "lmerTest", "MuMIn", "PerformanceAnalytics", "car"), require, character.only=T)
site_colors <- c(
  "BWL" = "#054fb9",
  "BWU" = "#97b5c2",
  "GBL" = "#DD6E42",
  "GBU" = "#d9cb7c"
)

siteC_colors <- c(
  "BWL" = "#054fb9",
  "BWU" = "#054fb9",
  "GBL" = "#DD6E42",
  "GBU" = "#DD6E42"
)



catch_colors <- c(
  "BW" = "#054fb9",
  "GB" = "#DD6E42"
)


## Fxn for water year:
water_year <- function(data) {
  # Ensure the `date` column exists
  if (!"date" %in% names(data)) {
    stop("The dataframe must contain a column named 'date'.")
  }
  
  # Convert the `date` column to Date format (if not already)
  data$date <- as.Date(data$date)
  
  # Add the water_year column
  data$water_year <- with(data, {
    year <- as.numeric(format(date, "%Y"))
    month <- as.numeric(format(date, "%m"))
    ifelse(month >= 10, year + 1, year)
  })
  
  return(data)
}

# Define fill patterns for water years
water_year_patterns <- c("wave","weave","stripe","circle", "stripe", "circle")


# Create a sequence of dates
date_seq <- seq(from = as.Date("2021-03-20"), to = as.Date("2024-10-10"), by = "day")
```

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}

# Convert the sequence to a dataframe
date_df <- data.frame(date = date_seq)
date_df$site <- "BWL"
date_df$catch <- "BW"
date_df1 <- data.frame(date = date_seq)
date_df1$site <- "GBL"
date_df1$catch <- "GB"
date_df2 <- data.frame(date = date_seq)
date_df2$site <- "GBU"
date_df2$catch <- "GB"
date_df3 <- data.frame(date = date_seq)
date_df3$site <- "BWU"
date_df3$catch <- "BW"

date_datf <- rbind(date_df,date_df1,date_df2, date_df3)

# ## Fxn for water year:
# water_year <- function(data) {
#   # Ensure the `date` column exists
#   if (!"date" %in% names(data)) {
#     stop("The dataframe must contain a column named 'date'.")
#   }
#   
#   # Convert the `date` column to Date format (if not already)
#   data$date <- as.Date(data$date)
#   
#   # Add the water_year column
#   data$water_year <- with(data, {
#     year <- as.numeric(format(date, "%Y"))
#     month <- as.numeric(format(date, "%m"))
#     ifelse(month >= 10, year + 1, year)
#   })
#   
#   return(data)
# }
# ## Function to perform ANOVA and post-hoc test within each site
# comparisons <- list(
#   c("2021", "2022"),
#   c("2021", "2023"),
#   c("2022", "2023"),
#   c("2023", "2024")
# )
# ```
# 
# ```{r, warning=F, size = 'small', echo=FALSE, include=F}
# ##==========================
# library(dataRetrieval)
# ## Bring in Streamflow
# siteNo_BW <- "10336660"
# 
# # Define the parameter codes for flow and stage
# pCode_flow <- "00060"
# pCode_stage <- "00065"
# pCode_temp <- "00010"
# 
# # Set the start date to "1980-01-01" and end date to today (current date)
# start.date <- "2021-04-01"
# end.date <- "2024-10-10"
# 
# HRflow_data_BW <- readNWISuv(
#   siteNumbers = siteNo_BW,
#   parameterCd = c(pCode_temp, pCode_flow, pCode_stage),
#   startDate = start.date,
#   endDate = end.date
# ) %>%
#   select(
#     datetime = "dateTime",
#     dischargeCFS = "X_00060_00000",
#     wtr_USGS = "X_.AquaTroll._00010_00000",
#     stageF = "X_00065_00000"
#   ) %>%
#   mutate(datetime = as.POSIXct(datetime, tz = "UTC") %>%
#            with_tz("America/Los_Angeles")) # Convert to Pacific Time
# 
# ### mutate for SI units:
# HRflow_BWL <- HRflow_data_BW %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/29.00787),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 0.647),
#     adjusted_depth =  c(stage_m * 0.233),
#     site="BWL"
#   )
# 
# HRflow_BWU <- HRflow_data_BW %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/29.00787),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 0.444),
#     adjusted_depth =  c(stage_m * 0.503),
#     site="BWU")
# 
# 
# #depth slope 0.233
# 
# 
# ##==========================
# ## Bring in Streamflow
# siteNo_GB <- "10336730" #siteNo_BW <- "10336660"
# 
# # Define the parameter codes for flow and stage
# pCode_flow <- "00060"
# pCode_stage <- "00065"
# pCode_temp <-"00010"
# 
# 
# # Set the start date to "1980-01-01" and end date to today (current date)
# start.date <- "2021-03-11"
# end.date <- "2024-10-16"
# 
# HRflow_data_GB <- readNWISuv(
#   siteNumbers = siteNo_GB,
#   parameterCd = c(pCode_temp, pCode_flow, pCode_stage),
#   startDate = start.date,
#   endDate = end.date
# ) %>%
#   select(
#     datetime = "dateTime",
#     dischargeCFS = "X_00060_00000",
#     wtr_USGS = "X_00010_00000",
#     stageF = "X_00065_00000"
#   ) %>%
#   mutate(datetime = as.POSIXct(datetime, tz = "UTC") %>%
#            with_tz("America/Los_Angeles")) # Convert to Pacific Time
# 
# ### mutate for SI units:
# HRflow_GBL <- HRflow_data_GB %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/10.64485),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 0.812),
#     adjusted_depth =  c(stage_m * 0.979),
#      site="GBL")
# 
# 
# ### mutate for SI units:
# HRflow_GBU <- HRflow_data_GB %>%
#   mutate(
#     dischargeCMS= c(dischargeCFS*0.0283168),
#     scale_Q= c((dischargeCFS*0.0283168)/10.64485),
#     stage_m= c(stageF*0.3048),
#     adjusted_dischargeCMS = c(dischargeCMS * 1.104),
#     adjusted_depth =  c(stage_m * 0.357),
#      site="GBU")
# 
# Flow_df <- rbind(HRflow_BWL, HRflow_BWU, HRflow_GBL, HRflow_GBU)
# 
# flow_df<- Flow_df %>%
#   mutate(date= as.Date(datetime))%>%
#   group_by(site, date) %>%
#   dplyr::select(!datetime)%>%
#   summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop") %>%
#   mutate(Q_m = adjusted_dischargeCMS,
#          depth_m = adjusted_depth)%>%
#   dplyr::select(site, date, Q_m, depth_m)
# 
# summary(flow_df)


# saveRDS(flow_df, file = "/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_flow_df.rds")

```

```{r, warning=F, size = 'small', echo=FALSE, include=F}
### Read in all data
####
date_datf <- water_year(date_datf)

covariat_dat <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_covariate_dat_AFDM.rds") %>%
  dplyr::select("date", "Site","bulk.density","AFDM_mgg","AFDM_mgcm2", "Chla_ugL_Q", "Pheo_ugL_Q")
summary(covariat_dat)

covariat_dat <- date_datf %>%
  left_join(covariat_dat, by=c("date", "site"="Site"))

flow_df <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_flow_df.rds")

covariat_dat <- covariat_dat %>%
    left_join(flow_df, by=c("date", "site"))


bg_nuts <- readRDS("/Users/kellyloria/Documents/LittoralMetabModeling/RawData/WaterChem/NS_chem_dat_nh4_24.rds") %>%
  filter(location=="stream") %>%
    mutate(NO3_mgL_dl = if_else(NO3_mgL_dl < 0.0015, 0.0015, NO3_mgL_dl))%>%
    mutate(NH4_mgL_dl=if_else(NH4_mgL_dl < 0.001, 0.001, NH4_mgL_dl))%>%
    mutate(PO4_ugL_dl=if_else(PO4_ugL_dl < 0.201, 0.201, PO4_ugL_dl)) %>%
  mutate(PO4_ugL_dl=if_else(DOC_mgL_dl < 0.25, 0.125, DOC_mgL_dl)) %>%
  group_by(site, shore, date, depth, location, substrate) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")


##### pivot wider 
bg_nuts_wide <- bg_nuts %>%
  dplyr::select(site, date, substrate, NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill) %>%
  group_by(site, date,substrate) %>% 
  summarise(across(c(NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill), mean, na.rm = TRUE), .groups = "drop") %>% 
  pivot_wider(names_from = substrate, values_from = c(NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill), names_sep = "_")

######


WQ_dat <- read.csv("/Users/kellyloria/Documents/LittoralMetabModeling/RawData/WaterChem/Stream_Lake_YSI_WaterQuality.csv")%>%
  mutate(date = as.Date(date, format="%m/%d/%y")) %>%
  dplyr::select("site", "date","pH") %>%
  dplyr:: group_by(site, date) %>%
  dplyr::summarise(pH=mean(pH, na.rm=T))

covariat_datq <- covariat_dat%>%
  left_join(bg_nuts_wide[ , c("site", "date", "NO3_mgL_dl_sw", "NO3_mgL_dl_pw", "NH4_mgL_dl_sw", 
                              "NH4_mgL_dl_pw", "PO4_ugL_dl_sw","PO4_ugL_dl_pw", "DOC_mgL_dl_sw",
                              "DOC_mgL_dl_pw", "pH_infill_sw",  "pH_infill_pw")], by=c("date", "site"))

covariat_datq <- covariat_datq%>%
  left_join(WQ_dat,  by=c("date", "site"))


## bring in SPC data 
### missing 2024 BW SPC
SPC_BWL <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_BWL_SPCv2.rds") %>%
  filter(datetime>as.POSIXct("2021-04-29 24:00:00"))
SPC_BWL$site <- "BWL"
SPC_BWU <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_BWU_SPCv2.rds")
SPC_BWU$site <- "BWU"
SPC_GBL <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_GBL_SPCv2.rds")
SPC_GBL$site <- "GBL"
SPC_GBU <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_GBU_SPCv2.rds")
SPC_GBU$site <- "GBU"

SPC_dat <- rbind(SPC_BWL, SPC_BWU, SPC_GBL, SPC_GBU)
SPC_dat <- SPC_dat %>%
  mutate(date =as.Date(datetime)) 

SPC_dat_day <- SPC_dat %>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    wt= mean(wtr, na.rm=T),
    wt_sd= sd(wtr, na.rm=T),
    SPC_m=mean(SPC, na.rm=T),
    SPC_sd=sd(SPC, na.rm=T))

#hist(SPC_dat_day$wt_sd)
#hist(SPC_dat_day$SPC_sd)

SPC_datD <- SPC_dat_day %>%
  filter(wt_sd<4.1 & SPC_sd <35)
  
#hist(SPC_datD$wt_sd)
#hist(SPC_datD$SPC_sd)
  
covariat_datq <- covariat_datq%>%
  left_join(SPC_datD, by=c("date", "site"))

### 
## Bring in morph data : 
morph_df <- read.csv("/Users/kellyloria/Documents/UNR/MSMmetab/stream_morphology_core.csv")%>%
  filter(quality =="trust") %>%
    mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%dT%H:%M:%SZ"),
           date=as.Date(datetime)) %>%
  rename(site="Site")


Morph_dat_day <- morph_df%>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    v_m=mean(v_estimation, na.rm=T),
    w_m=mean(w, na.rm=T),
    depth_measure=mean(z, na.rm=T))


covariat_datq <- covariat_datq%>%
  left_join(Morph_dat_day, by=c("date", "site"))

#### DO ###
## BWL  
BWL_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_BWL_mod_dat.rds") %>%
  mutate(site="BWL")
summary(BWL_dat) 

## BWU 
BWU_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/BWU_k600/25_BWU_mod_dat.rds") %>%
  mutate(site="BWU")
summary(BWU_dat)

## GBL 
GBL_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_GBL_mod_dat.rds") %>%
  mutate(site="GBL")
summary(GBL_dat)

## GBU 
GBU_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_GBU_mod_dat.rds") %>%
  mutate(site="GBU")
summary(GBU_dat)


miniDOT_dat <- rbind(BWL_dat, BWU_dat, GBL_dat, GBU_dat)
miniDOT_dat_day <- miniDOT_dat%>%
  mutate(date =as.Date(solar.time))%>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    do.obs_m=mean(DO.obs, na.rm=T),
    do.obs_sd=sd(DO.obs, na.rm=T),
    wtr_m=mean(temp.water, na.rm=T),
    wtr_sd=sd(temp.water, na.rm=T))

covariat_datq <- covariat_datq%>%
  left_join(miniDOT_dat_day, by=c("date", "site"))

### N-uptake metrics
n_up <- read.csv("/Users/kellyloria/Documents/UNR/Ncycle/BTC_N_Table_2025_figure.csv")%>%
  mutate(date = as.Date(date, format="%m/%d/%y")) 

covariat_datq <- covariat_datq%>%
  left_join(n_up, by=c("date", "site"))

##================================
## Load metabolism model data
##================================
BWL_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/BWL_Full_2025-02-06_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>% 
  mutate(site="BWL",
         catch="BW")

summary(BWL_met_binned)

GBL_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/GBL_Full_2025-02-02_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="GBL",
         catch="GB")


BWU_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/BWU_Full_2025-02-04_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="BWU",
         catch="BW")

GBU_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/GBU_Full_2025-02-03_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date,GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="GBU",
         catch="GB")

metab_dat <- rbind(BWL_met_binned, BWU_met_binned, GBL_met_binned, GBU_met_binned)

covariat_datq <- covariat_datq%>%
  left_join(metab_dat, by=c("date", "site", "catch"))
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# Define the columns of interest
# cols_to_check <- c("bulk.density", "AFDM_mgg", "AFDM_mgcm2", "Chla_ugL_Q", "Pheo_ugL_Q",
#                    "Q_m", "depth_m", "NO3_mgL_dl_sw", "NO3_mgL_dl_pw", "NH4_mgL_dl_sw", 
#                    "NH4_mgL_dl_pw", "PO4_ugL_dl_sw", "PO4_ugL_dl_pw", "DOC_mgL_dl_sw", 
#                    "DOC_mgL_dl_pw", "pH_infill_sw", "pH_infill_pw", "pH", "wt", "wt_sd", 
#                    "SPC_m", "SPC_sd", "v_m", "w_m", "depth_measure", "do.obs_m", "do.obs_sd", 
#                    "wtr_m", "wtr_sd", "method", "carboy_NaCl_g", "carboy_N_g", "liter_h2o", 
#                    "reach_length", "Uadd_ug_L_min", "Uadd_min_sd", "Uadd_min_sd.1", "sw_m", 
#                    "sw_sd", "vf", "vf.sd", "Vf_m_min", "vf_min_sd", "success", "GPP_mean", 
#                    "ER_mean", "NEP_daily_mean", "K600_daily_mean", "GPP_2.5pct", "GPP_97.5pct", 
#                    "ER_2.5pct", "ER_97.5pct", "K600_daily_2.5pct", "K600_daily_predlog_97.5pct", 
#                    "GPP_daily_Rhat", "ER_daily_Rhat", "K600_daily_Rhat")
# 
# # Filter out rows where all selected columns are NA
# f_data <- covariat_datq %>%
#   filter(rowSums(!is.na(select(., all_of(cols_to_check)))) > 0)
# 
# # Check the structure of the filtered dataset
# str(f_data)
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

covariat_datq$AFDM_ugcm2 <- (covariat_datq$AFDM_mgcm2 *1000)
#hist(covariat_datq$AFDM_ugcm2 )

covariat_datq$Biom_Chla <- (covariat_datq$AFDM_ugcm2)/(covariat_datq$Chla_ugL_Q)
#hist(covariat_datq$Biom_Chla)

summary(covariat_datq)

```

#### Possible nutrient data infill from EGRET package

<https://github.com/DOI-USGS/EGRET/blob/main/R/readUserDaily.r>

<https://cran.r-project.org/web/packages/EGRET/vignettes/EGRET.html>

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=9, fig.height=4}
library(EGRET)

egret_BWL_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NO31.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="BWL") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NO31.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt <- ggplot(egret_BWL_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWL NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt

egret_BWL_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="BWL") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWL_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt1 <- ggplot(egret_BWL_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWL NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt1

###

egret_BWU_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NO3.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="BWU") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NO3.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt2 <- ggplot(egret_BWU_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWU NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt2

egret_BWU_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="BWU") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_BWU_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt3 <- ggplot(egret_BWU_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "BWU NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt3

###

egret_GBL_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NO3.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="GBL") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NO3.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt4 <- ggplot(egret_GBL_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBL NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt4

egret_GBL_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="GBL") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBL_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt5 <- ggplot(egret_GBL_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBL NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt5

###

egret_GBU_N <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NO3.csv") %>%
  mutate(NO3_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NO3_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NO3_mgL_i = if_else(is.na(NO3_mgL_dl), NO3_mgL_m, NO3_mgL_dl))%>%
  mutate(date = as.Date(Date))  %>%
  mutate(site="GBU") %>%
  dplyr::select(date, site, NO3_mgL_i, NO3_mgL_dl, NO3_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NO3.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt6 <- ggplot(egret_GBU_N, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NO3_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NO3_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NO3_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBU NO3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt6

egret_GBU_A <- read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NH4.csv") %>%
  mutate(NH4_mgL_dl = if_else(ConcAve < 0.0015, 0.0015, ConcAve))%>%
  mutate(NH4_mgL_m = if_else(ConcDay_mod < 0.0015, 0.0015, ConcDay_mod))%>%
  mutate(NH4_mgL_i = if_else(is.na(NH4_mgL_m), NH4_mgL_m, NH4_mgL_m))%>%
  mutate(date = as.Date(Date))  %>%
    mutate(site="GBU") %>%
  dplyr::select(date, site, NH4_mgL_i, NH4_mgL_dl, NH4_mgL_m) %>%
  dplyr::group_by(date, site) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

infill_count <- sum(is.na(read.csv("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/EGRET_GBU_NH4.csv")$ConcAve))
infill_count

# Create the plot
logQ_plt7 <- ggplot(egret_GBU_A, aes(x = date)) +
  # Sample data as black points
  geom_point(aes(y = NH4_mgL_dl, color = "Sampled N"), alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_dl, color = "Sampled N")) +
  # Modeled data as red triangles
  geom_point(aes(y = NH4_mgL_m, color = "Modeled N"), shape = 2, alpha = 0.9) + 
  geom_line(aes(y = NH4_mgL_m, color = "Modeled N"), alpha = 0.9) + 
  scale_color_manual(values = c("Sampled N" = "black", "Modeled N" = "#D62828")) + 
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y") +  # Set breaks every 4 months
  theme_bw() + labs(title = "GBL NH4") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
logQ_plt7

nitrogen_dat <- rbind(egret_BWL_N,
                      egret_BWU_N, 
                      egret_GBL_N, 
                      egret_GBU_N)

nitrogen_datA <- rbind(egret_BWL_A, 
                      egret_BWU_A,
                      egret_GBL_A, 
                      egret_GBU_A)

nitrogen_data <- nitrogen_dat %>% full_join(nitrogen_datA, by=c("date", "site"))

```

#### Calculate nitrogen demand:

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
# Constants
ra <- 0.5  # Autotrophic respiration coefficient (Hall & Tank 2003)
C_Nauto <- 16  # Autotrophic C:N ratio (Stelzer & Lamberti 2001)
C_Nhetero <- 20  # Heterotrophic C:N ratio (Hall & Tank 2003)
HGE <- 0.05  # Heterotrophic Growth Efficiency (Hall & Tank 2003)

# Calculate components of nitrogen demand
covariat_ndemand <- covariat_datq %>%
  group_by(site) %>% 
  mutate(
    # Autotrophic respiration (raGPP)
    raGPP = GPP_mean * ra,
    # Autotrophic assimilation of N
    Auto_N_assim = GPP_mean / C_Nauto,
    # Heterotrophic respiration (Rh)
    Rh = ER_mean - raGPP,
    # Heterotrophic assimilation of N
    Hetero_N_assim = (Rh * HGE) / C_Nhetero,
    # Total nitrogen demand
    Ndemand = Auto_N_assim + Hetero_N_assim, # unit should be g N m-2 d-1
    Ndemand = if_else(Ndemand < 0, 0.0001, Ndemand)) %>%
  dplyr::select(site, date, Ndemand)
```

### Quality check on supply calculations:

(1) How many data points do we have for velocity (v) and width (w)?

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=6, fig.height=4}
morph_counts <- covariat_datq %>%
  group_by(site) %>%
  summarise(
    w_m_count = sum(!is.na(w_m)), 
    v_m_count = sum(!is.na(v_m))
  )

morph_counts
```

##### better way to infill width and velocites to get at reach length:

na.approx, and using Q as "Variables to be used for interpolation as in"

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
covariat_datqI <- covariat_datq %>%
  group_by(site) %>%
  arrange(date) %>%
  mutate(
    # Fit a linear model for w_m ~ Q_m using non-missing values
    w_m_apr = ifelse(is.na(w_m), predict(lm(w_m ~ depth_m, data = cur_data(), na.action = na.omit), newdata = cur_data()), w_m),
    v_m_apr = ifelse(is.na(v_m), predict(lm(v_m ~ Q_m, data = cur_data(), na.action = na.omit), newdata = cur_data()), v_m)
  ) %>%
  ungroup()

covariat_datqI <- covariat_datqI %>%
  group_by(site) %>%
  arrange(date) %>%  # Ensure chronological order
   mutate( ## 17 NAs
    w_m_apr = ifelse(is.na(w_m_apr),
                  rollapplyr(w_m_apr, width = 15, FUN = function(x) mean(x, na.rm = TRUE), fill = NA, partial = TRUE),
                  w_m_apr),
    v_m_apr = ifelse(is.na(v_m_apr),
                  rollapplyr(v_m_apr, width = 15, FUN = function(x) mean(x, na.rm = TRUE), fill = NA, partial = TRUE),
                  v_m_apr))
```

```{r, warning=F, size = 'small', echo=F,include=T, fig.width=9, fig.height=10}

TS_plot_w <- ggplot(covariat_datqI, aes(x = date, y = w_m_apr, color=site, shape =site)) +
  geom_point(size = 2, alpha = 0.5, position = position_dodge(width = 0.3)) +
  geom_point(size = 2, alpha = 0.7) +
  geom_point(aes(x = date, y = w_m), color="black") +
  scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) + theme_classic() +
  facet_grid(site~.)

TS_plot_v <- ggplot(covariat_datqI, aes(x = date, y = v_m_apr, color=site, shape =site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_point(size = 2, alpha = 0.7) +
    geom_point(aes(x = date, y = v_m), color="black") +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
    scale_color_manual(values = siteC_colors) +
  theme_classic() +facet_grid(site~.)

n_s_grid <- ggarrange(
  TS_plot_w,
  TS_plot_v,
  labels = c("a", "b"),
  ncol = 1, nrow = 2,
  label.x = 0.95,  # Move label to the right
  label.y = 1,     # Keep label at the top
  hjust = 1,       # Right-align the label
  vjust = 1        # Top-align the label
)

n_s_grid

```

Where the black points are the survey measures of width or velocity.

#### Calculate nitrogen supply:

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
covariat_nsupply <- covariat_datqI %>%
  left_join(nitrogen_data, by=c("date", "site")) %>%
  dplyr::select(site, catch, date, water_year, reach_length,
                v_m_apr,w_m_apr, Q_m, K600_daily_mean,
                NO3_mgL_dl_sw, NH4_mgL_dl_sw, PO4_ugL_dl_sw, NO3_mgL_i, NH4_mgL_i) %>%
  mutate(
    K600_daily_mean = case_when(
      is.na(K600_daily_mean) & site == "BWL" ~ 22, 
      is.na(K600_daily_mean) & site == "BWU" ~ 16,
      is.na(K600_daily_mean) & site == "GBU" ~ 32,
      is.na(K600_daily_mean) & site == "GBL" ~ 25,
      TRUE ~ K600_daily_mean)) %>%
  mutate(Q_Ls = Q_m * 1000, # flow from csm to Ls
  # calculate reach length in m
  reachL = c((v_m_apr*w_m_apr*8640)/K600_daily_mean), # seconds to days
   # Calculate no3 supply 
  NO3_supply = c(((86400*Q_Ls*(NO3_mgL_dl_sw/1000))/(w_m_apr*reachL))),
  NO3_supply_new = c(((86400*Q_Ls*(NO3_mgL_i/1000))/(w_m_apr*reachL))),

   # Calculate nh3 supply 
  NH4_supply = c(((86400*Q_Ls*(NH4_mgL_dl_sw/1000))/(w_m_apr*reachL))), ## unit should be g N m-2 d-1
 NH4_supply_new = c(((86400*Q_Ls*(NH4_mgL_i/1000))/(w_m_apr*reachL))),
  PO4_supply = c(((86400*Q_Ls*(PO4_ugL_dl_sw/1e-6))/(w_m_apr*reachL))) ## unit should be g N m-2 d-1
   )  %>%
  dplyr::select(site, date, reachL, reach_length, Q_Ls, NO3_supply, 
                NO3_supply_new, NH4_supply, PO4_supply, NH4_supply_new, NO3_mgL_i, NH4_mgL_i)

```

#### As a follow up... Which type of reach length works best?

I think the empirical calculation as K600 remained similar across flows.

But - **Covino et al picked a static length**:

"...Our experimental stream reach was near the Wooden Bridge in the
Korstian Division and stretched 175 and 200 m up- and downstream,
respectively.. We used a stream length of 100 m (King et al. 2014).
Ideal estimates of supply to the stream bed would exceed the stream
length over which the water column mixes vertically and, therefore,
solutes would be available to the bed, but we lacked hydrodynamic
information to estimate this length..."

Here I chose to estimate instead estimate reach length based off
Laurel's advice for using the gas exchange estimates to get estimate
theoretic reach length. Where reach length = velocity (m s\^-1) \* width
(in m) / gas exchange (m day\^-1).

But the empirical RL is calculated across the entire non- trimmed time
sieries of flow so does have some outliers at peak flows. Often when we
weren't sampling during those event flows and also couldn't model
metabolism then as well.

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=10, fig.height=5}
# from dilution 
RL_DG_plot<- ggplot(covariat_nsupply%>%mutate(year=year(date)), aes(x = reach_length, fill = factor(year))) +
  geom_histogram(bins = 15, alpha = 0.7, color = "black") +  # Adjust bins as needed
  scale_fill_viridis_d(name = "Year") +  # Use viridis colors for distinction
  theme_classic() +
  xlab("Reach Length - from dilution") +
  ylab("Count") +facet_grid(.~site)

summary(covariat_nsupply$reach_length)


RL_EMP_plot<- ggplot(covariat_nsupply%>%mutate(year=year(date))%>%filter(reachL<1000), aes(x = reachL, fill = factor(year))) +
  geom_histogram(bins = 15, alpha = 0.7, color = "black") +  # Adjust bins as needed
  scale_fill_viridis_d(name = "Year") +  # Use viridis colors for distinction
  theme_classic() +
  geom_vline(xintercept = 500, linetype = "dotted", color = "grey", size = 1) +  # Vertical line at 250
  xlab("Reach Length - empirical") +
  ylab("Count") +facet_grid(.~site)

summary(covariat_nsupply$reachL)


RL_grid <- ggarrange(
  RL_DG_plot,
  RL_EMP_plot,
  labels = c("a", "b"),
  ncol = 1, nrow = 2,
  label.x = 0.95,  # Move label to the right
  label.y = 1,     # Keep label at the top
  hjust = 1,       # Right-align the label
  vjust = 1        # Top-align the label
)

RL_grid
```

The vertical dotted line is 500 m to help compare ranges with the large
range of unrealistic RL at high flows.

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=10, fig.height=3}
# from dilution 
RL_EMP_plot<- ggplot(covariat_nsupply%>%mutate(year=year(date))%>%filter(reachL<1000), aes(x = reachL, fill = factor(year))) +
  geom_histogram(bins = 15, alpha = 0.7, color = "black") +  # Adjust bins as needed
  scale_fill_viridis_d(name = "Year") +  # Use viridis colors for distinction
  theme_classic() +
  geom_vline(xintercept = 500, linetype = "dotted", color = "grey", size = 1) +  # Vertical line at 250
  xlab("Reach Length - empirical") +
  ylab("Count") +facet_grid(.~site)
RL_EMP_plot
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
ndyn <- covariat_datq %>%
  left_join(covariat_nsupply, by=c("site", "date"))%>%
  left_join(covariat_ndemand, by=c ("site", "date")) 

summary(ndyn)

```

##### Plots of Ratios of NH4+- N supply to demand, ratios NO3-- N supply to demand

Remaid figure 4: Now with chemistry data aligned to data data frame so
that there are no sample NAs for NO3 and Nh4 when the metabolism model
failed to estimate that parameter on the same day as the chemistry
sample.

Color is now also by water year 2021-2024, and shape is reach location.

```{r, warning=F, size = 'small', echo=F, include=F}
covariat_NS_ND <- ndyn %>%
  mutate(jday = yday(date)) %>%
  dplyr::select(date, jday, Q_m, w_m, site, catch, water_year, 
                Ndemand, NO3_supply_new, NO3_supply, NH4_supply, NH4_supply_new,
                NH4_mgL_i, NO3_mgL_i) %>%
  mutate(
    NO3_SupDem = NO3_supply / Ndemand,
    NH4_SupDem = NH4_supply / Ndemand,
    N_SupDem = (NH4_supply + NO3_supply) / Ndemand
  ) %>%
  distinct(date, site, .keep_all = TRUE)  %>%
    mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  )) %>%
    group_by(site, date, catch) %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
  


# ## adjust the demand y axis to be from 0 to 1 
# N_ratio_plots <- ggplot(covariat_NS_ND%>%filter(water_year<2025), aes(x = log(NO3_supply+1), y = log(Ndemand+1), color = as.factor(water_year), shape=site)) +
#   geom_point(size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
#     geom_point( aes(x = log(NH4_supply+1), y = Ndemand, color = as.factor(water_year)),
#                 size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
#   geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
#     scale_color_viridis_d(option = "viridis",  name = "Water year") +
#       scale_shape_manual(values = c(15,0,17,2)) +
#   xlim(0,1) +
#  # ylim(0, 1) +
#    ylab(expression(log(Nitrogen~demand+1)~(g~N~m^-2~d^-1))) +
#      xlab(expression(log(Nitrogen~supply+1)~(g~N~m^-2~d^-1))) +
#   theme_classic()


N_ratio_plots <- ggplot(covariat_NS_ND%>%filter(water_year<2025), aes(x = log(NO3_supply+1), y = log(Ndemand+1), color = as.factor(water_year), shape=site)) +
  geom_point(size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
    geom_point( aes(x = log(NH4_supply+1), y = Ndemand, color = as.factor(water_year)),
                size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
    scale_color_viridis_d(option = "viridis",  name = "Water year") +
      scale_shape_manual(values = c(15,0,17,2), name = "Site") +
  xlim(0,1) +
 # ylim(0, 1) +
   ylab(expression(log(Nitrogen~demand+1)~(g~N~m^-2~d^-1))) +
     xlab(expression(log(Nitrogen~supply+1)~(g~N~m^-2~d^-1))) +
  theme_classic()


NO3_supp_plots <- ggplot(covariat_NS_ND%>%filter(water_year<2025), aes(y = log(NO3_supply_new+1), x = jday, color = as.factor(water_year), shape=site)) +
  geom_point(size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_point( aes(y = log(NH4_supply_new+1), x = jday, color = as.factor(water_year), shape=site), 
                size = 2, alpha = 0.85, position = position_dodge(width = 0.3)) +
    scale_color_viridis_d(option = "viridis", name = "Water year") +  # Use _c for continuous data
  xlim(15,360) + ylim(0,1.50) +
   xlab(NULL) +
 # geom_smooth(se=F) +
   # geom_smooth(aes(group = as.factor(water_year)), se = FALSE, linewidth = 1) +
     ylab(expression(log(Supply+1)~(g~N~m^-2~d^-1))) +
  theme_classic() +
  scale_shape_manual(values = c(15,0,17,2)) +
    theme(legend.position = "none")  # Remove legend

# Define threshold for high NO3 demand (above 3rd quartile)
high_Ndemand_threshold <- 0.075

N_demand_plot1 <- ggplot(covariat_NS_ND%>%filter(water_year<2025), aes(y = log(Ndemand+1), x = jday, color = as.factor(water_year), shape = site)) +
  geom_point(size = 2, alpha = 0.85, position = position_dodge(width = 0.8)) +
  scale_color_viridis_d(option = "viridis", name = "Water year") +  # Use _c for continuous data
  xlab("Day of year") + 
  xlim(15, 360) + ylim(0,1.50) +
 # geom_hline(yintercept = high_Ndemand_threshold, linetype = "dashed", color = "grey25") +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
  ylab(expression(log(Demand+1)~(g~N~m^-2~d^-1))) +
  theme_classic() +
  theme(legend.position = "none")  # Remove legend

N_demand_plot1

```

```{r, warning=F, size = 'small', echo=F,include=T, fig.width=10, fig.height=5}

n_s_grid <- ggarrange(
  NO3_supp_plots,
  N_demand_plot1,
  labels = c("b", "c"),
  ncol = 1, nrow = 2,
  label.x = 0.95,  # Move label to the right
  label.y = 1,     # Keep label at the top
  hjust = 1,       # Right-align the label
  vjust = 1        # Top-align the label
)



N_ratio_plots <- N_ratio_plots + 
  theme(
    aspect.ratio = 1, 
    plot.margin = margin(10, 20, 10, 20),
    legend.position = "bottom"
  ) +
  guides(
    shape = guide_legend(nrow = 2),  # Shape legend on first line
    color = guide_legend(nrow = 2)   # Color legend on second line
  )

Ndyn_grid <- ggarrange(
  N_ratio_plots,
  n_s_grid,
  ncol = 2, nrow = 1,
  labels = c("a", ""),
  #common.legend = TRUE, 
  #legend = "bottom",
  widths = c(1.2, 1.6)
)

Ndyn_grid


```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Nsupply_grid_CH1_v2.png", plot = Ndyn_grid, width = 10.5, height = 5.5, units = "in")

```

### Nitrogen Uptake dynamics from TASCC

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
n_df <- n_up%>%
  filter(success=="yes") %>%
  mutate(
         Uadd_g_m2_min = c(Uadd_ug_L_min/1000000),
         Uadd_g_m2_D = c(Uadd_g_m2_min*1440),
         Vf_mm_min=c(Vf_m_min)*1000) 

uptake <- n_df %>%
  pivot_wider(
    names_from = method, 
    values_from = Uadd_g_m2_D, 
    names_prefix = "Uadd_g_m2_D_") %>%
  dplyr::select(site, date, Uadd_g_m2_D_NH3, Uadd_g_m2_D_NO3)


uptake2 <- n_df %>%
  pivot_wider(
    names_from = method, 
    values_from = c(Uadd_g_m2_D, Vf_mm_min)
  ) 
summary(uptake)

uptake_df <-  covariat_NS_ND%>%
  full_join(uptake)

```

### Linking ecosystem funtion and biogeochemical dynamics:

We found that autotrophic production (and so nitrogen demand) is
suppressed in wetter years. We want to know how the reduced autrophic
production could effect nitrogen retention and transport.

-   To estimate what amount of the nitrogen can be could be transformed
    via uptake in at a given reach?

    -   Fractional uptake efficiencies (FUE) for N?

    -   Might consider the FUE at the lower station as downstream
        export?

-   To estimate what amount of the nitrogen can be could be transformed
    via uptake in a stream

    -   Difference in FUE between reaches for overall stream processing?

-   In wet years, even though supply increases, we would expect
    biological processes like uptake to decrease. So what percent of the
    N supply is either processes or exported in wet verse dry years?

##### Consider the units

-   Areal max uptake - Ut - ug / m2 min -\> we converted to g m2 day

-   Uptake velocity - Vf - m / min

-   Uptake length - Sw - m

-   Supply and demand is in g N m-2 d-1

### New analysis of Nitrogen dynamics:

#### Methods for evaluating nitrogen cycling

According to [Covino et al.
2018](https://www.journals.uchicago.edu/doi/abs/10.1086/699202?casa_token=z4FRLNRrBH8AAAAA:g2dwDEk5ct5-NxSqV0w2PILcK9ArSQhBnEeVBmOHiEHU_RMeWBRu4RWAzJG6ilh7wSeD30YDPkyH&casa_token=_yfAVNMW2ZQAAAAA:LH4hXzHGlRGjdsnCKp28IBUCho9RqquzLdge8TkzP3UNGQdvoI8SqtoxxyHw67tIEtm_4uM6CLmY)
:

-   Supply (S): The available nitrogen in the system (in g N/m²/day).

-   Demand (D): The total biological nitrogen demand (in g N/m²/day).

-   Uptake rate (U): The amount of nitrogen removed from the water
    column via assimilation, denitrification, or other biological
    processes.

#### U = (D \* S) / (D + S)

-   When demand (D) is much greater than supply (S): Almost all
    available nitrogen is taken up, so uptake approaches supply (U ≈ S)

-   When supply (S) is much greater than demand (D): Uptake is limited
    by biological demand, and uptake approaches demand (U ≈ D)

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=3}
uptake_dyn <- uptake_df %>%
  group_by(site, date) %>%
  mutate(
    jday = yday(date),
    U_NO3_calc = c((Ndemand*NO3_supply_new)/(Ndemand+NO3_supply_new)),
    U_NH4_calc = c((Ndemand*NH4_supply_new)/(Ndemand+NH4_supply_new))) %>%
  group_by(site, date) %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop") %>%
  mutate(catch = case_when(
    site== "BWL" ~ "BW",
    site== "BWU" ~ "BW",
    site== "GBL" ~ "GB",
    site== "GBU" ~ "GB",
    TRUE ~ NA_character_  
  ))
  

summary(uptake_dyn)

hist1<- ggplot(uptake_dyn, aes(x = U_NO3_calc)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal()
hist1

hist2<- ggplot(uptake_dyn, aes(x = U_NH4_calc)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal()
hist2

```

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}

uptake_dyn <- uptake_dyn %>%
  mutate(
    S_D_NO3 = NO3_supply_new / Ndemand,
    S_D_NH4 = NH4_supply_new / Ndemand
  )

summary(uptake_dyn$S_D_NO3)
summary(uptake_dyn$S_D_NH4)
quantile(uptake_dyn$S_D_NO3, probs = c(0.1, 0.9), na.rm = TRUE)
quantile(uptake_dyn$S_D_NH4, probs = c(0.1, 0.9), na.rm = TRUE)

```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}
hist1<- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = log(S_D_NO3+1))) +
 # geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 5) +  scale_color_manual(values = site_colors) + 
  geom_density(alpha = 0.7, aes(fill = site,  color = site)) +
  scale_color_manual(values = site_colors)  +
  scale_fill_manual(values = site_colors) + theme_minimal() +
  xlab(expression(log(NO[3]~Supply/N~Demand)))  
hist1

hist2<- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = log(S_D_NH4+1))) +
 # geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 5) +  scale_color_manual(values = site_colors) + 
  geom_density(alpha = 0.7, aes(fill = site,  color = site)) +
  scale_color_manual(values = site_colors)  +
  scale_fill_manual(values = site_colors) + theme_minimal() +
  xlab(expression(log(NH[4]~Supply/N~Demand))) 
hist2

```

```{r, warning=F, size = 'small', echo=F,include=T, fig.width=7, fig.height=6}

Ndyn_grid <- ggarrange(
  hist1,
  hist2,
  ncol = 1, nrow = 2,
    labels = c("a", "b"),
  common.legend = TRUE, 
   widths = c(1.75, 2.25),
  legend = "bottom")

Ndyn_grid
```

### Supply and demand dynamics tend to vary with catchment and reach:

Looks like N supply is greater than demand at GB -- indicating that
uptake (U) should be low and possibly limited by low biologic demand. So
we expect more nitrogen to be transported in GB.

Looks Like N demand is greater than supply at BW -- U should be high and
most available nitrogen should be retained.

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}

no3_S_plot <- ggplot(uptake_dyn%>%filter(NO3_supply_new<1), aes(x = log(NO3_supply_new+1), y = log(U_NO3_calc+1), color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.1)) +
  #scale_color_viridis_c(option = "viridis", name = "Day of year") + 
      scale_color_manual(values = siteC_colors) +
  geom_abline(slope = (1), intercept = 0, color = "black") +  # 1:1 line
  scale_shape_manual(values = c(15, 0, 17, 2)) +
 #xlim(0, 1) +
  theme_classic() +
  xlab(expression(log(N~supply)~(g~m^-2~d^-1))) +
  ylab(expression(log(NO[3]~U[calc])~(g~m^-2~d^-1)))



no3_D_plot <-ggplot(uptake_dyn, aes(x = log(Ndemand+1), y = log(U_NO3_calc+1), color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.1)) +
 # scale_color_viridis_c(option = "viridis", name = "Day of year") + 
    scale_color_manual(values = siteC_colors) +
   # xlim(0, 0.45) +
    geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
  scale_shape_manual(values = c(15, 0, 17, 2)) +theme_classic() +
  xlab(expression(log(N~demand)~(g~m^-2~d^-1))) +
   ylab(expression(log(NO[3]~U[calc])~(g~m^-2~d^-1)))


nh4_S_plot <-ggplot(uptake_dyn%>%filter(NH4_supply_new<1), aes(x = NH4_supply_new, y = U_NH4_calc,color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.1)) +
  #scale_color_viridis_c(option = "viridis", name = "Day of year") +
     # xlim(0, 0.150) +
    geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
      scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) +theme_classic() +
  xlab(expression(log(N~supply)~(g~m^-2~d^-1))) +
   ylab(expression(log(NH[4]~U[calc])~(g~m^-2~d^-1)))


nh4_D_plot <-ggplot(uptake_dyn, aes(x = log(Ndemand+1), y = log(U_NH4_calc+1), color = site, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.1)) +
  #scale_color_viridis_c(option = "viridis", name = "Day of year") + 
      scale_color_manual(values = siteC_colors) +
    geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
  scale_shape_manual(values = c(15, 0, 17, 2)) +theme_classic() +
  xlab(expression(log(N~demand)~(g~m^-2~d^-1))) +
    #  xlim(0, 0.45) +
   ylab(expression(log(NH[4]~U[calc])~(g~m^-2~d^-1)))

Ndyn_grid <- ggarrange(
  no3_S_plot,
  no3_D_plot,
  nh4_S_plot,
  nh4_D_plot,
  labels = c("a", "b", "c", "d"),
  ncol = 2, nrow = 2,
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid
```

Uptake (U) approaches supply at BW (U ≈ S; plots a & c). This is less
true for GB where supply is greater than uptake (U \< S) indicating
something other than supply is limiting biologic uptake at GB.

Similarly, U ≈ D at GB (plots b & d), providing additional evidence that
uptake is more limited by biological demand, relative to N supply.

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}

lm_no3_d_gb <- lmer(log(U_NO3_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_no3_d_gb)
r.squaredGLMM(lm_no3_d_gb)

lm_no3_d_bw <- lmer(log(U_NO3_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_no3_d_bw)
r.squaredGLMM(lm_no3_d_bw)

lm_nh4_d_gb <- lmer(log(U_NH4_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_nh4_d_gb)
r.squaredGLMM(lm_nh4_d_gb)

lm_nh4_d_bw <- lmer(log(U_NH4_calc+1) ~ scale(Ndemand) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_nh4_d_bw)
r.squaredGLMM(lm_nh4_d_bw)

lm_no3_s_gb <- lmer(log(U_NO3_calc+1) ~ scale(NO3_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_no3_s_gb)
r.squaredGLMM(lm_no3_s_gb)


lm_no3_s_bw <- lmer(log(U_NO3_calc+1) ~ scale(NO3_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_no3_s_bw)
r.squaredGLMM(lm_no3_s_bw)


lm_nh4_s_gb <- lmer(log(U_NH4_calc+1) ~ scale(NH4_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="GB"))
summary(lm_nh4_s_gb)
r.squaredGLMM(lm_nh4_s_gb)


lm_nh4_s_bw <- lmer(log(U_NH4_calc+1) ~ scale(NH4_supply_new) + (1|water_year), data= uptake_dyn%>%filter(catch=="BW"))
summary(lm_nh4_s_bw)
r.squaredGLMM(lm_nh4_s_bw)


```

### Looking at specific events based on the 75th quantile?

#### Identify High N Demand Events 2021-2023

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
# Define threshold for high NO3 demand (above 3rd quartile)
high_Ndemand_threshold <- quantile(na.omit(uptake_dyn$Ndemand), probs = 0.75)


# Filter data for high NO3 demand instances
high_Ndemand_sites <- uptake_dyn %>%
  filter(Ndemand > high_Ndemand_threshold) %>%
  select(site, date, water_year, jday, Ndemand, NO3_supply_new, U_NO3_calc) %>%
  arrange(desc(Ndemand))  # Sort by highest demand

# Summary statistics of high-demand occurrences by site
high_Ndemand_summary <- high_Ndemand_sites %>%
  group_by(site) %>%
  summarize(
    count = n(),
    mean_Ndemand = mean(Ndemand, na.rm = TRUE),
    max_Ndemand = max(Ndemand, na.rm = TRUE),
    earliest_date = min(date, na.rm = TRUE),
    latest_date = max(date, na.rm = TRUE)
  ) %>%
  arrange(desc(count))

# Print summary table
print(high_Ndemand_summary)
```

#### Identify High NO3 supply Events 2021-2023

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
# Define threshold for high NO3 demand (above 3rd quartile)
high_NO3_sup_threshold <- quantile(na.omit(uptake_dyn$NO3_supply_new), probs = 0.75)

# Filter data for high NO3 demand instances
high_NO3_sup_sites <- uptake_dyn %>%
  filter(NO3_supply > high_NO3_sup_threshold) %>%
  select(site, date, water_year, jday, Ndemand, NO3_supply_new, U_NO3_calc) %>%
  arrange(desc(NO3_supply_new))  # Sort by highest demand

# Summary statistics of high-demand occurrences by site
high_NO3_supply_summary <- high_NO3_sup_sites %>%
  group_by(site) %>%
  summarize(
    count = n(),
    mean_NO3_supply = mean(NO3_supply_new, na.rm = TRUE),
    max_NO3_supply = max(NO3_supply_new, na.rm = TRUE),
    earliest_date = min(date, na.rm = TRUE),
    latest_date = max(date, na.rm = TRUE)
  ) %>%
  arrange(desc(count))

# Print summary table
print(high_NO3_supply_summary)
```

#### Identify High NH4 supply Events 2021-2023

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
# Define threshold for high NO3 demand (above 3rd quartile)
high_NH4_sup_threshold <- quantile(na.omit(uptake_dyn$NH4_supply_new), probs = 0.75)

# Filter data for high NO3 demand instances
high_NH4_sup_sites <- uptake_dyn %>%
  filter(NH4_supply > high_NH4_sup_threshold) %>%
  select(site, date, water_year, jday, Ndemand, NH4_supply_new, U_NH4_calc) %>%
  arrange(desc(NH4_supply_new))  # Sort by highest demand

# Summary statistics of high-demand occurrences by site
high_NH4_supply_summary <- high_NH4_sup_sites %>%
  group_by(site) %>%
  summarize(
    count = n(),
    mean_NH4_supply = mean(NH4_supply_new, na.rm = TRUE),
    max_NH4_supply = max(NH4_supply_new, na.rm = TRUE),
    earliest_date = min(date, na.rm = TRUE),
    latest_date = max(date, na.rm = TRUE)
  ) %>%
  arrange(desc(count))

# Print summary table
print(high_NH4_supply_summary)
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}
# Plot high NO3 demand over time
TS_high_N_demand<- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = date, y = Ndemand, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  geom_hline(yintercept = high_Ndemand_threshold, linetype = "dashed", color = "grey25") +
  labs(title = "N Demand Over Time",
       x = "Date",
       y = "N Demand (g N/m²/day)") +
  theme_classic()


TS_high_NO3_sup <- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = date, y = NO3_supply_new, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  geom_hline(yintercept = high_NO3_sup_threshold, linetype = "dashed", color = "grey25") +
  labs(title = "NO3 Supply Over Time",
       x = "Date",
       y = "NO3 Supply (g N/m²/day)") +
  theme_classic()


TS_high_NH4_sup <- ggplot(uptake_dyn%>%filter(water_year<2024), aes(x = date, y = NH4_supply_new, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  geom_hline(yintercept = high_NH4_sup_threshold, linetype = "dashed", color = "grey25") +
  labs(title = "NH4 Supply Over Time",
       x = "Date",
       y = "NH4 Supply (g N/m²/day)") +
  theme_classic()
```

#### Plot daily demand and suppply 2021-2023

Dashed horizontal lines are the 75th quantile of each response.

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=8}

Ndyn_grid <- ggarrange(
  TS_high_N_demand,
  TS_high_NO3_sup,
  TS_high_NH4_sup,
  ncol = 1, nrow = 3,
  labels = c("a", "b", "c"),
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid

```

Demand highest in 2021 and typically peaks in fall. 
Supply for NH4 or NO3 appears to be low in 2021, with slight elevation in 2023. 
Supply for either N is typically higher at GB relative to BW.

#### Fractional uptake efficiency for each nitrogen type:

A value close to 1 suggests high efficiency, meaning most of the
supplied nitrogen was absorbed, while a value close to 0 suggests that
most of the supplied nitrogen remained in the system

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=3}
uptake_dyn2 <- uptake_dyn %>%
  mutate(
    frac_NO3_uptake = U_NO3_calc / NO3_supply_new,
    frac_NH4_uptake = U_NH4_calc / NH4_supply_new,
    frac_N_uptake = (U_NH4_calc + U_NO3_calc) / (NH4_supply_new+NO3_supply_new)
  ) %>%
      mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  ))

uptake_dyn2 <- uptake_dyn2 %>%
  mutate(
    frac_NO3_uptake = ifelse(NO3_supply_new > 0, U_NO3_calc / NO3_supply_new, NA), ## unit less
    frac_NH4_uptake = ifelse(NH4_supply_new > 0, U_NH4_calc / NH4_supply_new, NA)
  )

hist1<- ggplot(uptake_dyn2, aes(x = frac_NH4_uptake)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal() +
     xlab(expression(FUE~NH[4]))


hist2<- ggplot(uptake_dyn2, aes(x = frac_NO3_uptake)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 10) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal() +
   xlab(expression(FUE~NO[3]))

```

```{r, warning=F, size = 'small', echo=F,include=T, fig.width=6, fig.height=4}

Ndyn_grid <- ggarrange(
  hist1,
  hist2,
  ncol = 1, nrow = 2,
    labels = c("a", "b"),
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}
#### Time sieries of fractional uptake efficiency in for each N:

# Plot high NO3 demand over time
Fr_NO3_sup <- ggplot(uptake_dyn2%>%filter(water_year<2024), aes(x = date, y = frac_NO3_uptake, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
   ylab(expression(NO[3]~U[calc]~(g~m^-2~d^-1)/NO[3]~supply~(g~m^-2~d^-1))) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  theme_classic()


Fr_NH4_sup <- ggplot(uptake_dyn2%>%filter(water_year<2024), aes(x = date, y = frac_NH4_uptake, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
   ylab(expression(NH[4]~U[calc]~(g~m^-2~d^-1)/Nh[4]~supply~(g~m^-2~d^-1))) +
    scale_shape_manual(values = c(15, 0, 17, 2)) +
  theme_classic()
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=8}

Ndyn_grid <- ggarrange(
  Fr_NO3_sup,
  Fr_NH4_sup,
  ncol = 1, nrow = 2,
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid

```

#### Summary of fractional uptake of N from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
uptake_dyn_sum <- uptake_dyn2%>%
  filter(water_year<2024)%>%
  group_by(site, WY_lab) %>%
  summarise(frac_NO3_uptake = mean(frac_NO3_uptake, na.rm=T),
           frac_NH4_uptake = mean(frac_NH4_uptake, na.rm=T),
           frac_N_uptake = mean(frac_N_uptake, na.rm=T),
           N_demand = mean(Ndemand, na.rm=T),
           NO3_supply = mean(NO3_supply_new, na.rm=T),
           NH4_supply = mean(NH4_supply_new, na.rm=T),
          NO3_mgL = mean(NO3_mgL_i, na.rm=T),
           NH4_mgL = mean(NH4_mgL_i, na.rm=T))
  
uptake_dyn_sum
```

##### Percent change in FUE by reach for NO3, NH4, and total N (NO3+NH4) from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
uptake_dyn_wide <- uptake_dyn_sum %>%
  pivot_wider(names_from = WY_lab, values_from = c(frac_NO3_uptake, frac_NH4_uptake, frac_N_uptake, 
                                                   N_demand, NO3_supply, NH4_supply, 
                                                   NO3_mgL, NH4_mgL))

# Calculate percent change from Dry to Wet years
uptake_dyn_wide1 <- uptake_dyn_wide %>%
  mutate(
    pct_FUE_NO3 = round((((frac_NO3_uptake_wet - frac_NO3_uptake_dry) / frac_NO3_uptake_dry) * 100), 1),
    pct_FUE_NH4 = round((((frac_NH4_uptake_wet - frac_NH4_uptake_dry) / frac_NH4_uptake_dry) * 100), 1),
    pct_FUE_N = round((((frac_N_uptake_wet - frac_N_uptake_dry) / frac_N_uptake_dry) * 100),1),
    pct_demand = round((((N_demand_wet - N_demand_dry) / N_demand_dry) * 100),1),
    pct_NO3_supply = round((((NO3_supply_wet - NO3_supply_dry) / NO3_supply_dry) * 100),1),
    pct_NH4_supply = round((((NH4_supply_wet - NH4_supply_dry) / NH4_supply_dry) * 100),1),
    pct_NO3 = round((((NO3_mgL_wet - NO3_mgL_dry) / NO3_mgL_dry) * 100),1),
    pct_NH4 = round((((NH4_mgL_wet - NH4_mgL_dry) / NH4_mgL_dry) * 100),1)) %>%
  dplyr::select(site, pct_FUE_NO3, pct_FUE_NH4, pct_FUE_N,
                pct_demand, pct_NO3_supply, pct_NH4_supply, pct_NO3, pct_NH4)

uptake_dyn_wide1

```

Fractional uptake efficiency appeared to decrease from dry to wet years
for both NO3 NH4.

### Nitrogen dynamics within streams from upper to lower reaches:

#### Looking at possible nitrogen retention with BW or GB:

-   NO₃/NH₄ retention fraction close to 1: Most nitrogen is
    processed/retained before reaching the lower reach.

-   NO₃/NH₄ retention fraction close to 0: Most nitrogen passes
    downstream unchanged.

-   Negative retention values: suggest an increase in nitrogen
    downstream, possibly from inputs like tributaries or groundwater

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=3}
# Define reach lengths
bw_reach_length <- 4150  # meters (BWU to BWL)
gb_reach_length <- 1100  # meters (GBU to GBL)

# Calculate NO3 and NH4 retention with reach area
reach_rent <- uptake_dyn %>%
  filter(site %in% c("BWU", "BWL", "GBU", "GBL")) %>%
  group_by(catch, date) %>%
  summarize(
    NO3_supply_upper = NO3_supply_new[site %in% c("BWU", "GBU")],
    NO3_supply_lower = NO3_supply_new[site %in% c("BWL", "GBL")],
    NH4_supply_upper = NH4_supply_new[site %in% c("BWU", "GBU")],
    NH4_supply_lower = NH4_supply_new[site %in% c("BWL", "GBL")],
    U_NO3_upper = U_NO3_calc[site %in% c("BWU", "GBU")],
    U_NO3_lower = U_NO3_calc[site %in% c("BWL", "GBL")],
    U_NH4_upper = U_NH4_calc[site %in% c("BWU", "GBU")],
    U_NH4_lower = U_NH4_calc[site %in% c("BWL", "GBL")],
    NO3_upper = NO3_mgL_i[site %in% c("BWU", "GBU")],
    NO3_lower = NO3_mgL_i[site %in% c("BWL", "GBL")],
    NH4_upper = NH4_mgL_i[site %in% c("BWU", "GBU")],
    NH4_lower = NH4_mgL_i[site %in% c("BWL", "GBL")],
    w_m_upper = w_m[site %in% c("BWU", "GBU")],  # Stream width for upper reach
    w_m_lower = w_m[site %in% c("BWL", "GBL")]   # Stream width for lower reach
  ) %>%
  mutate(
    # Assign reach length based on the system
    reach_length = case_when(
      catch == "BW" ~ bw_reach_length,
      catch == "GB" ~ gb_reach_length
    ),
    # Calculate reach area (reach length * width)
    reach_area = reach_length * ((w_m_upper + w_m_lower) / 2),  # Average width
    
    # Calculate NO3 and NH4 retention fractions
    NO3_retention = 1 - (NO3_supply_lower / NO3_supply_upper),
    NH4_retention = 1 - (NH4_supply_lower / NH4_supply_upper),
    
    # Calculate processed nitrogen (g/m2/day × reach area)
    NO3_processed = (NO3_supply_upper - NO3_supply_lower) * reach_area,
    NH4_processed = (NH4_supply_upper - NH4_supply_lower) * reach_area,
    NO3_processedi = (NO3_upper - NO3_lower) * reach_area,
    NH4_processedi = (NH4_upper - NH4_lower) * reach_area
  )%>%
  mutate(jday=yday(date))
summary(reach_rent)

reach_rent<- water_year(reach_rent)
```

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=3}

hist1<- ggplot(reach_rent, aes(x = NO3_retention)) +
  geom_density(alpha = 0.7, aes(fill = catch,  color = catch)) +
  scale_color_manual(values = catch_colors)  + xlim(-2.5,1) +
  scale_fill_manual(values = catch_colors) + theme_minimal() +
      geom_vline(xintercept = 0, linetype = "dashed", color = "grey", size = 1) + 
      geom_vline(xintercept = 1, linetype = "dotted", color = "grey25", size = 1) +
  xlab(expression(NO[3]~retention~between~reaches))


hist2<-ggplot(reach_rent, aes(x = NH4_retention)) +
 # geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 5) +  scale_color_manual(values = site_colors) + 
  geom_density(alpha = 0.7, aes(fill = catch,  color = catch)) +
  scale_color_manual(values = catch_colors)  + 
  xlim(-2.5,1) +
  scale_fill_manual(values = catch_colors) + theme_minimal() +
      geom_vline(xintercept = 0, linetype = "dashed", color = "grey", size = 1) + 
      geom_vline(xintercept = 1, linetype = "dotted", color = "grey25", size = 1) +
  xlab(expression(NH[4]~retention~between~reaches)) 
hist2

```

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=4.5}
Ndyn_grid <- ggarrange(
  hist1,
  hist2,
  ncol = 1, nrow = 2,
  labels = c("a", "b"),
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid
```

#### Plot daily retention dynamics 2021-2023:

```{r, warning=F, size = 'small', echo=F, include=F,fig.width=9, fig.height=6}
# Plot high NO3 demand over time
Rent_NO3_plt <- ggplot(reach_rent%>%filter(water_year<2024), aes(x = date, y = NO3_retention, color = jday, shape = catch)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
        geom_hline(yintercept = 1, linetype = "dotted", color = "grey25") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
   ylab(expression(NO[3]~retention)) +
    scale_shape_manual(values = c(15, 17)) +
  theme_classic()


Rent_NH4_plt <- ggplot(reach_rent%>%filter(water_year<2024), aes(x = date, y = NH4_retention, color = jday, shape = catch)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +
  geom_point(size = 2, alpha = 0.7) +
          geom_hline(yintercept = 1, linetype = "dotted", color = "grey25") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
   ylab(expression(NH[4]~retention)) +
    scale_shape_manual(values = c(15, 17)) +
  theme_classic()
```

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}

Ndyn_grid <- ggarrange(
  Rent_NO3_plt,
  Rent_NH4_plt,
  ncol = 1, nrow = 2,
  common.legend = TRUE, 
  legend = "bottom")

Ndyn_grid

```

#### Summarize stream N uptake of N from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
reach_rent_sum <- reach_rent%>%
   mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  ))

reach_rent_sum <- reach_rent_sum %>%
  filter(water_year<2024)%>%
  group_by(catch, WY_lab) %>%
  summarise(NO3_retention = mean(NO3_retention, na.rm=T),
           NH4_retention = mean(NH4_retention, na.rm=T),
           NO3_processed = mean(NO3_processedi, na.rm=T),
           NH4_processed = mean(NH4_processedi, na.rm=T)
           )
reach_rent_sum
```

##### Percent change in FUE by reach for NO3, NH4, and total N (NO3+NH4) from dry to wet years

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}
reach_rent_wide <- reach_rent_sum %>%
  pivot_wider(names_from = WY_lab, values_from = c(NO3_retention, NH4_retention, NO3_processed, 
                                                   NH4_processed))

# Calculate percent change from Dry to Wet years
reach_rent_wide1 <- reach_rent_wide %>%
  mutate(
    pct_NO3_retention = round((((NO3_retention_wet - NO3_retention_dry) / NO3_retention_dry) * 100), 1),
    pct_NH4_retention = round((((NH4_retention_wet - NH4_retention_dry) / NH4_retention_dry) * 100), 1),
    pct_NO3_proc = round((((NO3_processed_wet - NO3_processed_dry) / NO3_processed_dry) * 100),1),
    pct_NH4_proc = round((((NH4_processed_wet - NH4_processed_dry) / NH4_processed_dry) * 100),1)) %>%
  dplyr::select(catch, pct_NO3_retention, pct_NH4_retention, pct_NO3_proc, pct_NH4_proc)

reach_rent_wide1

```

## Final thoughts:

### Main points:

-   **Overall**– across all reaches there is low nitrogen demand, low
    uptake, and moderate nitrogen supply.

    -   Peak nitrogen supply tends to occur ahead of peak demand.

    -   Nitrogen supply increased increased from wet to dry years, while
        nitrogen demand and fractional uptake efficiency (FUE) both
        decreased.

    -   FUE is higher for NH4 relative to NO3

#### Stream specifics nitrogen dynamics:

-   **GB:** N supply is greater than demand at GB – indicating that
    uptake (U) should be low and possibly limited by low biologic
    demand.

    -   FUE also tends to be near 0 at GB

    -   There are some negative values of nitrogen retention between
        upper and lower reaches suggesting some other source of nitrogen
        is present downstream of GBU (likely groundwater).

    -   So we expect more nitrogen to be transported relative to the
        amount transformed or retained in GB.

-   **BW:** N demand can be greater than nitrogen supply at BW -- U
    tends to be more related to supply dynamics.

    -   FUE tends to be near 1.

    -   Most nitrogen retention between upper and lower reaches appears
        to between 0 and 1 suggesting it could be retained or processed
        between the upper and lower reaches.

    -   Relative to GB, BW can actually process or retain a large
        portion of the nitrogen concentrations in stream water, despite
        being a larger stream.

#### Comparing nitrogen dynamics from dry to wet years?

-   **Changes to demand?**

    -   Demand decreased by 80% at BW, by 93% at GBU and increased by
        17% GBL

-   **Changes to supply?**

    -   NO~3~ : Increased by 16% at BWL, by 184% at GBL, by 442% at GBU,
        and decreased by 5% at BWU

    -   NH~4~ : Increased by 46% at BWL, by 47% at BWU, by 112 % at GBL,
        by 244% at GBU

-   **Changes to FUE?**

    -   NO~3~ : Decreased by 46% at BWL, by 67% at BWU, by 23% at GBL,
        and by 52% at GBU

    -   NH~4~ : Decreased by 53% at BWL, by 50% at BWU, by 66% at GBL,
        by 75% at GBU

-   **Changes to between reach retention?**

    -   NO~3~ : Decreased by 42% at BW, by 103 % at GB
    -   NH~4~ : Decreased by 151% at BW, by 100 % at GB



#### How do these Vf and U compare to Vicent et al. ? 
(Tank et al.?)
0-50 vf so we have estimates above that

0-8 Uadd

```{r, warning=F, size = 'small', echo=F, include=T,fig.width=9, fig.height=6}


hist1<- ggplot(uptake2%>%filter(Vf_mm_min_NH3<200), aes(x = Vf_mm_min_NH3)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 20) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal()

hist1

hist2<- ggplot(uptake2%>%filter(Vf_mm_min_NO3<200), aes(x = Vf_mm_min_NO3)) +
  geom_histogram(aes(fill = site,  color = site),  position = "dodge", alpha = 0.7, bins = 20) +  scale_color_manual(values = site_colors) + scale_fill_manual(values = site_colors) + theme_minimal()
hist2


```
