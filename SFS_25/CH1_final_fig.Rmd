---
title: 'Figures for MS: Spatiotemporal variation in mountain stream metabolism and nitrogen cycling across contrasting flow regimes '
author: "Kelly Loria"
date: "`r Sys.Date()`"
output:
   html_document:
    theme: united
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style type="text/css">
body, td {font-size: 13px;}
code.r{font-size: 9px;}
pre {font-size: 11px}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = F, message = F)
knitr::opts_knit$set(root.dir = '/Users/kellyloria/Documents/Publications/')
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

```

```{r, echo = F, message = F, include=FALSE}
### Packages
#setwd("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/BWL_k600/")
lapply(c("plyr","dplyr","ggplot2","cowplot",
         "lubridate","tidyverse", "reshape2", "ggpubr", "ggpattern", "broom.mixed",
         "glmmTMB",
         "lme4", "lmerTest", "MuMIn", "PerformanceAnalytics", "car"), require, character.only=T)
```

## Research Questions:

(1) How does stream metabolism vary based on catchment characteristics, antecedent flow conditions, and nitrogen availability?

    -   Figures 2, 3

(2) Is variance in nitrogen demand and instream uptake (either as ammonium or nitrate) more related to biological (GPP, ER, biomass or chlorophyll-a), physical processes (flow and water temperature), or ambient nutrient and organic matter availability? 

    -   Figures 4, 5
    
(3) How does in-stream productivity and nitrogen supply and demand dynamics change within stream catchments and across dry (2021 and 2022) and wet water years (2023)?

    -   Figures 6

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
daoc_date<- Sys.Date()

lapply(c("plyr","dplyr","ggplot2","cowplot",
         "lubridate","tidyverse", "reshape2", "ggpubr", "ggpattern",
         "lme4", "lmerTest", "MuMIn", "PerformanceAnalytics", "car"), require, character.only=T)
site_colors <- c(
  "BWL" = "#054fb9",
  "BWU" = "#97b5c2",
  "GBL" = "#DD6E42",
  "GBU" = "#d9cb7c"
)

siteC_colors <- c(
  "BWL" = "#054fb9",
  "BWU" = "#054fb9",
  "GBL" = "#DD6E42",
  "GBU" = "#DD6E42"
)



catch_colors <- c(
  "BW" = "#054fb9",
  "GB" = "#DD6E42"
)

# Define fill patterns for water years
water_year_patterns <- c("wave","weave","stripe","circle", "stripe", "circle")


# Create a sequence of dates
date_seq <- seq(from = as.Date("2021-03-20"), to = as.Date("2024-10-10"), by = "day")

# Convert the sequence to a dataframe
date_df <- data.frame(date = date_seq)
date_df$site <- "BWL"
date_df$catch <- "BW"
date_df1 <- data.frame(date = date_seq)
date_df1$site <- "GBL"
date_df1$catch <- "GB"
date_df2 <- data.frame(date = date_seq)
date_df2$site <- "GBU"
date_df2$catch <- "GB"
date_df3 <- data.frame(date = date_seq)
date_df3$site <- "BWU"
date_df3$catch <- "BW"

date_datf <- rbind(date_df,date_df1,date_df2, date_df3)

## Fxn for water year:
water_year <- function(data) {
  # Ensure the `date` column exists
  if (!"date" %in% names(data)) {
    stop("The dataframe must contain a column named 'date'.")
  }
  
  # Convert the `date` column to Date format (if not already)
  data$date <- as.Date(data$date)
  
  # Add the water_year column
  data$water_year <- with(data, {
    year <- as.numeric(format(date, "%Y"))
    month <- as.numeric(format(date, "%m"))
    ifelse(month >= 10, year + 1, year)
  })
  
  return(data)
}
## Function to perform ANOVA and post-hoc test within each site
comparisons <- list(
  c("2021", "2022"),
  c("2021", "2023"),
  c("2022", "2023"),
  c("2023", "2024")
)
```

### Figure 1: Map

Not included here.

```{r, warning=F, size = 'small', echo=FALSE, include=F}
date_datf <- water_year(date_datf)

covariat_dat <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_covariate_dat_AFDM.rds") %>%
  dplyr::select("date", "Site","bulk.density","AFDM_mgg","AFDM_mgcm2", "Chla_ugL_Q", "Pheo_ugL_Q")
summary(covariat_dat)

covariat_dat <- date_datf %>%
  left_join(covariat_dat, by=c("date", "site"="Site"))

flow_df <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_flow_df.rds")

covariat_dat <- covariat_dat %>%
    left_join(flow_df, by=c("date", "site"))


bg_nuts <- readRDS("/Users/kellyloria/Documents/LittoralMetabModeling/RawData/WaterChem/NS_chem_dat_nh4_24.rds") %>%
  filter(location=="stream") %>%
    mutate(NO3_mgL_dl = if_else(NO3_mgL_dl < 0.0015, 0.0015, NO3_mgL_dl))%>%
    mutate(NH4_mgL_dl=if_else(NH4_mgL_dl < 0.001, 0.001, NH4_mgL_dl))%>%
    mutate(PO4_ugL_dl=if_else(PO4_ugL_dl < 0.201, 0.201, PO4_ugL_dl)) %>%
  mutate(PO4_ugL_dl=if_else(DOC_mgL_dl < 0.25, 0.125, DOC_mgL_dl)) %>%
  group_by(site, shore, date, depth, location, substrate) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")


##### pivot wider 
bg_nuts_wide <- bg_nuts %>%
  dplyr::select(site, date, substrate, NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill) %>%
  group_by(site, date,substrate) %>% 
  summarise(across(c(NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill), mean, na.rm = TRUE), .groups = "drop") %>% 
  pivot_wider(names_from = substrate, values_from = c(NO3_mgL_dl, NH4_mgL_dl, PO4_ugL_dl, DOC_mgL_dl, pH_infill), names_sep = "_")

######


WQ_dat <- read.csv("/Users/kellyloria/Documents/LittoralMetabModeling/RawData/WaterChem/Stream_Lake_YSI_WaterQuality.csv")%>%
  mutate(date = as.Date(date, format="%m/%d/%y")) %>%
  dplyr::select("site", "date","pH") %>%
  dplyr:: group_by(site, date) %>%
  dplyr::summarise(pH=mean(pH, na.rm=T))

covariat_datq <- covariat_dat%>%
  left_join(bg_nuts_wide[ , c("site", "date", "NO3_mgL_dl_sw", "NO3_mgL_dl_pw", "NH4_mgL_dl_sw", 
                              "NH4_mgL_dl_pw", "PO4_ugL_dl_sw","PO4_ugL_dl_pw", "DOC_mgL_dl_sw",
                              "DOC_mgL_dl_pw", "pH_infill_sw",  "pH_infill_pw")], by=c("date", "site"))

covariat_datq <- covariat_datq%>%
  left_join(WQ_dat,  by=c("date", "site"))


## bring in SPC data 
### missing 2024 BW SPC
SPC_BWL <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_BWL_SPCv2.rds") %>%
  filter(datetime>as.POSIXct("2021-04-29 24:00:00"))
SPC_BWL$site <- "BWL"
SPC_BWU <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_BWU_SPCv2.rds")
SPC_BWU$site <- "BWU"
SPC_GBL <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_GBL_SPCv2.rds")
SPC_GBL$site <- "GBL"
SPC_GBU <- readRDS("/Users/kellyloria/Documents/UNR/MSMmetab/23_CleanDat/24_GBU_SPCv2.rds")
SPC_GBU$site <- "GBU"

SPC_dat <- rbind(SPC_BWL, SPC_BWU, SPC_GBL, SPC_GBU)
SPC_dat <- SPC_dat %>%
  mutate(date =as.Date(datetime)) 

SPC_dat_day <- SPC_dat %>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    wt= mean(wtr, na.rm=T),
    wt_sd= sd(wtr, na.rm=T),
    SPC_m=mean(SPC, na.rm=T),
    SPC_sd=sd(SPC, na.rm=T))

#hist(SPC_dat_day$wt_sd)
#hist(SPC_dat_day$SPC_sd)

SPC_datD <- SPC_dat_day %>%
  filter(wt_sd<4.1 & SPC_sd <35)
  
#hist(SPC_datD$wt_sd)
#hist(SPC_datD$SPC_sd)
  
covariat_datq <- covariat_datq%>%
  left_join(SPC_datD, by=c("date", "site"))

### 
## Bring in morph data : 
morph_df <- read.csv("/Users/kellyloria/Documents/UNR/MSMmetab/stream_morphology_core.csv")%>%
  filter(quality =="trust") %>%
    mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%dT%H:%M:%SZ"),
           date=as.Date(datetime)) %>%
  rename(site="Site")


Morph_dat_day <- morph_df%>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    v_m=mean(v_estimation, na.rm=T),
    w_m=mean(w, na.rm=T),
    depth_measure=mean(z, na.rm=T))


covariat_datq <- covariat_datq%>%
  left_join(Morph_dat_day, by=c("date", "site"))

#### DO ###
## BWL  
BWL_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_BWL_mod_dat.rds") %>%
  mutate(site="BWL")
summary(BWL_dat) 

## BWU 
BWU_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/BWU_k600/25_BWU_mod_dat.rds") %>%
  mutate(site="BWU")
summary(BWU_dat)

## GBL 
GBL_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_GBL_mod_dat.rds") %>%
  mutate(site="GBL")
summary(GBL_dat)

## GBU 
GBU_dat <- readRDS("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/input_data/25_GBU_mod_dat.rds") %>%
  mutate(site="GBU")
summary(GBU_dat)


miniDOT_dat <- rbind(BWL_dat, BWU_dat, GBL_dat, GBU_dat)
miniDOT_dat_day <- miniDOT_dat%>%
  mutate(date =as.Date(solar.time))%>%
  dplyr::group_by(site, date) %>%
  dplyr::summarise(
    do.obs_m=mean(DO.obs, na.rm=T),
    do.obs_sd=sd(DO.obs, na.rm=T),
    wtr_m=mean(temp.water, na.rm=T),
    wtr_sd=sd(temp.water, na.rm=T))

covariat_datq <- covariat_datq%>%
  left_join(miniDOT_dat_day, by=c("date", "site"))

### N-uptake metrics
n_up <- read.csv("/Users/kellyloria/Documents/UNR/Ncycle/BTC_N_Table_2025_figure.csv")%>%
  mutate(date = as.Date(date, format="%m/%d/%y")) 

covariat_datq <- covariat_datq%>%
  left_join(n_up, by=c("date", "site"))

##================================
## Load metabolism model data
##================================
BWL_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/BWL_Full_2025-02-06_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>% 
  mutate(site="BWL",
         catch="BW")

summary(BWL_met_binned)

GBL_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/GBL_Full_2025-02-02_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="GBL",
         catch="GB")


BWU_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/BWU_Full_2025-02-04_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date, GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="BWU",
         catch="BW")

GBU_met_binned <- read_csv("/Users/kellyloria/Documents/Publications/2024_stream_metab_output/final_output_2025/GBU_Full_2025-02-03_daily.csv") %>%
  filter(GPP_daily_Rhat<1.05)%>%
  filter(GPP_97.5pct>0)%>%
  filter(ER_daily_Rhat<1.05) %>%
  filter(ER_2.5pct<0)%>%
  filter(K600_daily_Rhat<1.05) %>%
  mutate(
    GPP_mean = ifelse(GPP_mean < 0, 0.001, GPP_mean)) %>%
  filter(ER_mean < 0.01) %>%
  mutate(NEP_daily_mean = GPP_daily_mean + ER_daily_mean) %>%
  dplyr::select(date,GPP_mean, ER_mean, NEP_daily_mean, K600_daily_mean,
                GPP_2.5pct, GPP_97.5pct, 
                ER_2.5pct, ER_97.5pct,
                K600_daily_2.5pct, K600_daily_predlog_97.5pct,
                GPP_daily_Rhat, ER_daily_Rhat, K600_daily_Rhat) %>%
  mutate(site="GBU",
         catch="GB")

metab_dat <- rbind(BWL_met_binned, BWU_met_binned, GBL_met_binned, GBU_met_binned)

covariat_datq <- covariat_datq%>%
  left_join(metab_dat, by=c("date", "site", "catch"))


### read in streamlight data
## BWL  
BWL_SL_dat <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_StreamLightMod_BWL.rds")
summary(BWL_SL_dat) 

## BWU 
BWU_SL_dat <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_StreamLightMod_BWU.rds") 
summary(BWU_SL_dat)

## GBL 
GBL_SL_dat <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_StreamLightMod_GBL.rds") 
summary(GBL_SL_dat)

## GBU 
GBU_SL_dat <- readRDS("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/data/CH1_StreamLightMod_GBU.rds") 
summary(GBU_SL_dat)

light_mod_df <- rbind(BWL_SL_dat, BWU_SL_dat, GBL_SL_dat, GBU_SL_dat)

light_mod_df_day <- light_mod_df%>%
  mutate(date=as.Date(local_time)) %>%
  group_by(site, date)%>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop") %>%
  dplyr::select(site, date, LAI, PAR_inc, PAR_bc, veg_shade, bank_shade, PAR_surface)


covariat_datq <- covariat_datq%>%
  left_join(light_mod_df_day, by=c("date", "site"))


```


```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

covariat_datq$AFDM_ugcm2 <- (covariat_datq$AFDM_mgcm2 *1000)
#hist(covariat_datq$AFDM_ugcm2 )

covariat_datq$Biom_Chla <- (covariat_datq$AFDM_ugcm2)/(covariat_datq$Chla_ugL_Q)
#hist(covariat_datq$Biom_Chla)

summary(covariat_datq)

```

Pause to make a column for biomass to chla ratios And also make biomass
in in micro grams to more comparable to chl-a

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

covariat_datq$AFDM_ugcm2 <- (covariat_datq$AFDM_mgcm2 *1000)
#hist(covariat_datq$AFDM_ugcm2 )

covariat_datq$Biom_Chla <- (covariat_datq$AFDM_ugcm2)/(covariat_datq$Chla_ugL_Q)
#hist(covariat_datq$Biom_Chla)
```

Additive columns for combined surface and pore water nutrient as tot_ in ugL

```{r, warning=F, size = 'small', echo=T, include=F, fig.width=6, fig.height=4}

covariat_datq$tot_NO3_ugL <- c(covariat_datq$NO3_mgL_dl_pw + covariat_datq$NO3_mgL_dl_sw) *1000

covariat_datq$tot_NH4_ugL <- c(covariat_datq$NH4_mgL_dl_pw + covariat_datq$NH4_mgL_dl_sw) *1000

covariat_datq$tot_PO4_ugL <- c(covariat_datq$PO4_ugL_dl_pw + covariat_datq$PO4_ugL_dl_pw)

covariat_datq$tot_DOC_ugL <- c(covariat_datq$DOC_mgL_dl_pw + covariat_datq$DOC_mgL_dl_sw) *1000


summary(covariat_datq)

```

# Question 1

#### How does stream metabolism vary based on catchment characteristics, antecedent flow conditions, and nitrogen availability?

## Figure 2: Metabolism Time series

-   The magnitude of GPP and ER across all sites

Where GPP is in green, ER is in purple, NEP is in black dataframe:
`metab_dat`

```{r, warning=F, size = 'small', echo=F, fig.width=7, fig.height=8}
metab_TS_plot<- metab_dat %>% 
  ggplot(aes(x = date)) +
  geom_abline(slope = 0, intercept = 0, width = 1, alpha = 0.6) +
  # GPP
  geom_errorbar(aes(ymin = GPP_2.5pct, ymax = GPP_97.5pct), width = 0.2, color = "#1f7335", alpha=0.2) +
  geom_point(aes(y = GPP_mean), col = "#1f7335", alpha = 0.8, size = 0.5) +
  # ER
  geom_errorbar(aes(ymin = ER_97.5pct, ymax = ER_2.5pct), width = 0.2, color = "#6c3a8a", alpha=0.2) +
  geom_point(aes(y = ER_mean), col = "#6c3a8a", alpha = 0.8, size = 0.5) +
  # NEP Points
  geom_point(aes(y = NEP_daily_mean), alpha = 0.25, size = 0.15, shape=1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_breaks = "12 week", date_labels = "%b-%y") +
  scale_fill_manual(values = c("GPP" = "#1f7335", "ER" = "#6c3a8a")) +
  ylab(expression(Metabolism~(g~O[2]~m^-2~d^-1))) + xlab(NULL) +
  facet_wrap(~site, nrow = 4) 

metab_TS_plot
```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/metab_TS_plot_2025.png", plot = metab_TS_plot, width = 5.25, height = 6, units = "in")

```

Time series metabolism plots for each site

```{r, warning=F, size = 'small', echo=F,include=FALSE, fig.width=7, fig.height=8}
metab_TS_plot<- metab_dat %>% 
  dplyr::filter(site=="GBU")%>%
  ggplot(aes(x = date)) +
  geom_abline(slope = 0, intercept = 0, width = 1, alpha = 0.6) +
  # GPP
  geom_errorbar(aes(ymin = GPP_2.5pct, ymax = GPP_97.5pct), width = 0.2, color = "#1f7335", alpha=0.2) +
  geom_point(aes(y = GPP_mean), col = "#1f7335", alpha = 0.8, size = 0.5) +
  # ER
  geom_errorbar(aes(ymin = ER_97.5pct, ymax = ER_2.5pct), width = 0.2, color = "#6c3a8a", alpha=0.2) +
  geom_point(aes(y = ER_mean), col = "#6c3a8a", alpha = 0.8, size = 0.5) +
  # NEP Points
  geom_point(aes(y = NEP_daily_mean), alpha = 0.25, size = 0.15, shape=1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_breaks = "12 week", date_labels = "%b-%y") +
  scale_fill_manual(values = c("GPP" = "#1f7335", "ER" = "#6c3a8a")) +
  ylab(expression(Metabolism~(g~O[2]~m^-2~d^-1))) + xlab(NULL) +
  facet_wrap(~site, nrow = 4) 

metab_TS_plot
```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Sup_Figures/ metab_TS_plot_GBU_2025.png", plot = metab_TS_plot, width = 9.25, height = 5, units = "in")

```

```{r, warning=F, size = 'small', echo=F, fig.width=10, fig.height=12}
# Separate out BW 
covariat_datq_BW <- covariat_datq%>%
  dplyr::filter(site=="BWL" | site=="BWU")

# Separate out GB 
covariat_datq_GB <- covariat_datq%>%
  dplyr::filter(site=="GBL" | site=="GBU")
```

#### Descriptive stats to describe stream based differences in

Both BW to GB - large to small streams, as well as variation with
stream.

-   Water temp

-   Flow

-   OM

-   Biomass

-   Chla

-   GPP

-   \|ER\|

### BW catchment:

```{r, warning=F, size = 'small', echo=F, include=T}

summary_mean <- covariat_datq_BW %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- covariat_datq_BW %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- covariat_datq_BW %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max
```

### GB Catchment

```{r, warning=F, size = 'small', echo=F, include=T}
summary_mean <- covariat_datq_GB %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- covariat_datq_GB %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- covariat_datq_GB %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max
```

#### Break out by stream reach location:

##### BWL:

```{r, warning=F, size = 'small', echo=F, include=F}
BWL_DF<- covariat_datq_BW %>%
  dplyr::filter(site == "BWL") 

BWL_DF21 <- covariat_datq_BW %>%
  dplyr::filter(site == "BWL") %>%
  dplyr::filter(water_year==2021)

BWL_DF22 <- covariat_datq_BW %>%
  dplyr::filter(site == "BWL") %>%
  dplyr::filter(water_year==2022)

BWL_DF23 <- covariat_datq_BW %>%
  dplyr::filter(site == "BWL") %>%
  dplyr::filter(water_year==2022)


summary_mean <- BWL_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- BWL_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- BWL_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max
```

##### BWU:

```{r, warning=F, size = 'small', echo=F, include=F}
BWU_DF <- covariat_datq_BW %>%
  dplyr::filter(site == "BWU")

BWU_DF21 <- covariat_datq_BW %>%
  dplyr::filter(site == "BWU") %>%
  dplyr::filter(water_year==2021)

BWU_DF22 <- covariat_datq_BW %>%
  dplyr::filter(site == "BWU") %>%
  dplyr::filter(water_year==2022)

BWU_DF23 <- covariat_datq_BW %>%
  dplyr::filter(site == "BWU") %>%
  dplyr::filter(water_year==2023)

summary_mean <- BWU_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- BWU_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- BWU_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max
```

##### GBL:

```{r, warning=F, size = 'small', echo=F, include=F}
GBL_DF <- covariat_datq_GB %>%
  dplyr::filter(site == "GBL")

GBL_DF21 <- covariat_datq_GB %>%
  dplyr::filter(site == "GBL") %>%
  dplyr::filter(water_year==2021)

GBL_DF22 <- covariat_datq_GB %>%
  dplyr::filter(site == "GBL") %>%
  dplyr::filter(water_year==2022)

GBL_DF23 <- covariat_datq_GB %>%
  dplyr::filter(site == "GBL") %>%
  dplyr::filter(water_year==2023)

GBL_DF24 <- covariat_datq_GB %>%
  dplyr::filter(site == "GBL") %>%
  dplyr::filter(water_year==2024)

summary_mean <- GBL_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- GBL_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- GBL_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max

```

##### GBU:

```{r, warning=F, size = 'small', echo=F, include=F}
GBU_DF <- covariat_datq_GB %>%
  dplyr::filter(site == "GBU")

GBU_DF21 <- covariat_datq_GB %>%
  dplyr::filter(site == "GBU") %>%
  dplyr::filter(water_year==2021)

GBU_DF22 <- covariat_datq_GB %>%
  dplyr::filter(site == "GBU") %>%
  dplyr::filter(water_year==2022)

GBU_DF23 <- covariat_datq_GB %>%
  dplyr::filter(site == "GBU") %>%
  dplyr::filter(water_year==2023)

summary_mean <- GBU_DF %>%
    summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")
summary_mean
summary_min <- GBU_DF %>%
    summarise(across(everything(), min, na.rm = TRUE), .groups = "drop")
summary_min
summary_max <- GBU_DF %>%
    summarise(across(everything(), max, na.rm = TRUE), .groups = "drop")
summary_max
```

##### Kernal density plots of GPP and ER

Colored by years

```{r, warning=F, size = 'small', echo=F,include=FALSE, fig.width=7, fig.height=8}
library(ggplot2)

BWL_KD_plot <- ggplot(covariat_datq%>%dplyr::filter(site=="BWL" &water_year<2025), aes(x = GPP_mean, y = ER_mean, color = as.factor(water_year))) +
  geom_density_2d(bins=10, size=1) + 
  geom_point(alpha=0.5)+
  geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
 ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
    scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
      scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
     scale_color_viridis_d(option = "viridis", name = "Water year") +
  theme_classic() +
          annotate("text", x = 12, y = -2, label = "BWL", size = 6, fontface = "bold", hjust = 0.5) 


# 
# BWU_KD_plot <- ggplot(
#   BWU_DF %>% 
#     filter(site == "BWU" & water_year < 2025) %>%
#     mutate(water_year = factor(water_year, levels = as.character(sort(unique(water_year))))),  # Force correct order
#   aes(x = GPP_mean, y = ER_mean, color = water_year)  
# ) +
#   geom_density_2d(bins = 10, size = 1) + 
#   geom_point(alpha = 0.5) +
#   geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
#   xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
#   ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
#    scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
# 
#   scale_color_viridis_d(option = "viridis") +
#   theme_classic()


# 
# BWU_KD_plot <- ggplot(
#   BWU_DF %>%
#     filter(water_year < 2024) %>%
#     mutate(water_year = factor(water_year, levels = sort(unique(water_year)))),  # Ensure correct ordering
#   aes(x = GPP_mean, y = ER_mean, color = water_year)  # `water_year` is now a properly ordered factor
# ) +
#   geom_density_2d(bins = 10, size = 1) +
#   geom_point(alpha = 0.5) +
#   geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
#   scale_x_continuous(position = "top") +  # Move x-axis to the top
#   #xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
#    xlab(NULL) +
#   ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
#         scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
#      scale_color_viridis_d(option = "viridis") +
#   theme_classic()

BWU_DF_fixed <- BWU_DF %>%
  filter(water_year < 2024) %>%
  mutate(water_year = factor(water_year, levels = c(2021, 2022, 2023, 2024))) %>%
  bind_rows(tibble(GPP_mean = NA, ER_mean = NA, water_year = factor(2024, levels = c(2021, 2022, 2023, 2024))))  # Add dummy row


BWU_KD_plot <- ggplot(BWU_DF_fixed, aes(x = GPP_mean, y = ER_mean, color = water_year)) +
  geom_density_2d(bins = 10, size = 1) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
  scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
  scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
  xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
  ylab(NULL) +
  #ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
  scale_color_viridis_d(option = "viridis", name = "Water year") +
  theme_classic() +
        annotate("text", x = 12, y = -2, label = "BWU", size = 6, fontface = "bold", hjust = 0.5) 
BWU_KD_plot


# 
# BWU_KD_plot <- ggplot(BWU_DF_fixed, aes(x = GPP_mean, y = ER_mean, color = water_year)) +
#   geom_density_2d(bins = 10, size = 1) +
#   geom_point(alpha = 0.5) +
#   geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
#   scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
#   #xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
#     #xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
#    xlab(NULL) +
#   ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
#   scale_color_viridis_d(option = "viridis") +
#   theme_classic()
# 


GBU_DF_clean <- GBU_DF %>%
filter(water_year<2025)%>%
  filter(!is.na(GPP_mean) & !is.na(ER_mean))%>%
  dplyr::select(date, water_year, GPP_mean, ER_mean)
# 
# str(GBU_DF_clean)
# 
# GBU_KD_plot <- ggplot(GBU_DF_clean, aes(x = log(GPP_mean+1), y = ER_mean, color = as.factor(water_year))) +
#   stat_density_2d(size=1) + 
#   geom_point(alpha=0.25) +
#   geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
#   scale_x_continuous(position = "top") +  # Move x-axis to the top
# xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
#  ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
#      scale_color_viridis_d(option = "inferno") +
#   theme_classic()



library(MASS)



# Compute 2D density
density_data <- with(GBU_DF_clean, kde2d(GPP_mean, ER_mean, n = 100))

# Convert density data to dataframe
density_df <- data.frame(
  expand.grid(x = density_data$x, y = density_data$y),
  z = as.vector(density_data$z)
)

# Plot with contour lines
GBU_KD_plot <- ggplot() +
  geom_point(data = GBU_DF_clean, aes(x = GPP_mean, y = ER_mean, color = as.factor(water_year)), alpha = 0.5) +
    geom_contour(data = density_df, aes(x = x, y = y, z = z), color = "black", bins = 5, size=1) +
  geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
  scale_x_continuous(position = "top") +
    #xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
   xlab(NULL) +
    ylab(NULL) +
  #ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
    scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
    scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
  scale_color_viridis_d(option = "viridis", name = "Water year") +
  theme_classic() +
        annotate("text", x = 12, y = -2, label = "GBU", size = 6, fontface = "bold", hjust = 0.5) 

GBU_KD_plot


GBL_DF_clean <- GBL_DF %>%
  filter(!is.na(GPP_mean) & !is.na(ER_mean))%>%
  dplyr::select(date, water_year, GPP_mean, ER_mean)

# 
# library(MASS)
# 
# # Compute 2D density
# density_data <- with(GBL_DF_clean, kde2d(GPP_mean, ER_mean, n = 100))
# 
# # Convert density data to dataframe
# density_df <- data.frame(
#   expand.grid(x = density_data$x, y = density_data$y),
#   z = as.vector(density_data$z)
# )

# Plot with contour lines
GBL_KD_plot <- ggplot() +
#  geom_contour(data = density_df, aes(x = x, y = y, z = z), color = "black", bins = 10) +
  geom_point(data = GBL_DF_clean%>%filter(water_year<2025), aes(x = GPP_mean, y = ER_mean, color = as.factor(water_year)), alpha = 0.5) +
  geom_abline(slope = -1, intercept = 0, linetype = "dashed", color = "black") +  # 1:1 line
  scale_x_continuous(position = "top") +
    #xlab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
   xlab(NULL) +
  ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
  scale_y_continuous(limits = c(-30, 0)) +  # Ensure zero is visible
      scale_x_continuous(position = "top", limits = c(0, 13)) +  # Set x limits & move axis
  scale_color_viridis_d(option = "viridis",  name = "Water year") +
  theme_classic() +
      annotate("text", x = 12, y = -2, label = "GBL", size = 6, fontface = "bold", hjust = 0.5) 


```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=4, fig.height=10}
# Modify each plot to rename legend title & adjust legend formatting
BWL_KD_plot <- BWL_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 2))

BWU_KD_plot <- BWU_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 2))

GBL_KD_plot <- GBL_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 2))

GBU_KD_plot <- GBU_KD_plot + 
  guides(color = guide_legend(title = "Water year", nrow = 2))
```

### Modified figure 2
#### (Q1) - How does stream metabolism vary based on catchment characteristics, antecedent flow conditions, and nitrogen availability?

```{r, warning=F, size = 'small', echo=F, fig.width=6, fig.height=7}
# Arrange plots with shared legend at the bottom
KD_coeff_grid <- ggarrange(
  BWL_KD_plot,
  BWU_KD_plot,
  GBL_KD_plot,
  GBU_KD_plot,
  labels = c("a", "b", "c", "d"),
  ncol = 2, nrow = 2,
  common.legend = TRUE, 
  legend = "bottom"
)

KD_coeff_grid
```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Fig2_KD_CH1_grid_v2.png", plot = KD_coeff_grid, width = 6, height = 5.25, units = "in")

```

### General drivers of productivity

Both standing stocks

-   A. Epilithic biomass

-   B. Epilithic chl-a

Ecosystem fluxes

-   C. Gross primary productivity (GPP)

-   E. Absolute value of ecosystem respiration (ER)

Each productivity response is individually modeled within stream using
`glm`

dataframe = `covariat_datq`

#### Fixed effect co-variance ?

Maybe some with flow and water temp but all correlations are under 0.6

##### At Blackwood:

```{r, warning=F, size = 'small', echo=T, fig.width=9, fig.height=9}
cor_data <- covariat_datq_BW[, c(6, 10, 32, 67, 70, 71)]

chart.Correlation(cor_data, histogram=TRUE, pch=19)
```

##### At Glenbrook:

```{r, warning=F, size = 'small', echo=T, fig.width=9, fig.height=9}
cor_data <- covariat_datq_GB[, c(6, 11:14, 18, 28, 30)]

chart.Correlation(cor_data, histogram=TRUE, pch=19)
```

### A. Biomass models

##### BW:

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=4, fig.height=4}
#What's the response distribution? 
#hist(covariat_datq_BW$AFDM_ugcm2)
#hist(log(covariat_datq_BW$AFDM_ugcm2+1))
```

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}
biomass_mod_bw <- lmer(log(AFDM_ugcm2+1)~ 
                         scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                         scale(PAR_surface) + 
                         (1|site), data=covariat_datq_BW)

summary(biomass_mod_bw)
vif(biomass_mod_bw)
#hist(residuals(biomass_mod_bw), main = paste(NULL))
r.squaredGLMM(biomass_mod_bw)
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, fig.width=6, fig.height=4}
# Extract fixed effects and confidence intervals
fixed_effects <- broom.mixed::tidy(biomass_mod_bw, effects = "fixed", conf.int = TRUE)
# Filter to exclude intercept and arrange predictors
fixed_effects1 <- fixed_effects[fixed_effects$term != "(Intercept)", ]
fixed_effects1 <- fixed_effects1[order(fixed_effects1$estimate), ]  # Order by estimate
fixed_effects1$Catchment <- "BW"
```

##### GB:

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}
biomass_mod_gb <- lmer(log(AFDM_ugcm2+1)~ 
                                                  scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                         scale(PAR_surface) + 
                         (1|site), data=covariat_datq_GB)

summary(biomass_mod_gb)
vif(biomass_mod_gb)
#hist(residuals(biomass_mod_gb), main = paste(NULL))
r.squaredGLMM(biomass_mod_gb)
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, fig.width=6, fig.height=4}
fixed_effects_gb <- broom.mixed::tidy(biomass_mod_gb, effects = "fixed", conf.int = TRUE)

# Filter to exclude intercept and arrange predictors
fixed_effects_gb1 <- fixed_effects_gb[fixed_effects_gb$term != "(Intercept)", ]
fixed_effects_gb1 <- fixed_effects_gb1[order(fixed_effects_gb1$estimate), ]  # Order by estimate
fixed_effects_gb1$Catchment <- "GB"
```

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}

fxd_eff <- rbind(fixed_effects_gb1, fixed_effects1)

fxd_eff1 <- fxd_eff %>%
  mutate(Significance = case_when(
    p.value <= 0.05 ~ "sig",
    p.value > 0.05 & p.value <= 0.1  ~ "marg.",
    p.value > 0.1  ~ "not sig."))


term_labels <- c(
  "scale(NO3_mgL_dl * 1000)" = expression(NO[3]~(µg~L^-1)),
  "scale(PO4_ugL_dl)" = expression(PO[4]~(µg~L^-1)),
 # "scale(DOC_mgL_dl)" = expression(DOC~(mg~L^-1)),
  "scale(AFDM_mgg)" = expression(OM~(mg~g^-1)),
  "scale(NH4_mgL_dl * 1000)" = expression(NH[4]~(µ~L^-1)),
  "scale(wtr_m)" = expression(Temp~(degree~C)),
  "scale(Q_m)" = expression(Q~(m^3~s^-1))
)

# Add an offset column based on Catchment
fxd_eff1 <- fxd_eff1 %>%
  mutate(y_position = as.numeric(reorder(term, estimate)) + ifelse(Catchment == "BW", 0.2, 0))

Biomass_coeff_plot <-ggplot(fxd_eff1, aes(x = estimate, y = reorder(term, estimate), color = Catchment, shape = Significance)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0, alpha = 0.85, position = position_dodge(width = 0.3)) +
  theme_classic() +
  scale_shape_manual(values = c(4, 19)) +
  scale_color_manual(values = catch_colors) +
  geom_vline(xintercept = 0) +
  labs(
    x = NULL,
    y = "Predictors",
    title = "Epilithic biomass"
  ) +
  scale_y_discrete(labels = term_labels) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(size = 12)
  )


Biomass_coeff_plot
```

### B. Chlorophyll-a models

##### BW:

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}

chla_mod_bw <- lmer(log(Chla_ugL_Q+1) ~ 
                        scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                         scale(PAR_surface) + 
                      (1|site), data=covariat_datq_BW)

summary(chla_mod_bw)
vif(chla_mod_bw)
#hist(residuals(chla_mod_bw), main = paste(NULL))
r.squaredGLMM(chla_mod_bw)
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, fig.width=6, fig.height=4}
# Extract fixed effects and confidence intervals
fixed_effects_chl <- broom.mixed::tidy(chla_mod_bw, effects = "fixed", conf.int = TRUE)
# Filter to exclude intercept and arrange predictors
fixed_effects_chl1 <- fixed_effects_chl[fixed_effects_chl$term != "(Intercept)", ]
fixed_effects_chl1 <- fixed_effects_chl1[order(fixed_effects_chl1$estimate), ]  # Order by estimate
fixed_effects_chl1$Catchment <- "BW"

```

##### GB

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}

chla_mod_gb <- lmer(log(Chla_ugL_Q+1) ~ 
                        scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                         scale(PAR_surface) + 
                    (1|site), data=covariat_datq_GB)

summary(chla_mod_gb)
vif(chla_mod_gb)
#hist(residuals(chla_mod_gb), main = paste(NULL))
r.squaredGLMM(chla_mod_gb)
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, fig.width=6, fig.height=4}

fixed_effects_chlg <- broom.mixed::tidy(chla_mod_gb, effects = "fixed", conf.int = TRUE)
# Filter to exclude intercept and arrange predictors
fixed_effects_chlg1 <- fixed_effects_chlg[fixed_effects_chlg$term != "(Intercept)", ]
fixed_effects_chlg1 <- fixed_effects_chlg1[order(fixed_effects_chlg1$estimate), ]  # Order by estimate
fixed_effects_chlg1$Catchment <- "GB"
```

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
fxd_eff_chla <- rbind(fixed_effects_chlg1, fixed_effects_chl1)

fxd_eff_chla1 <- fxd_eff_chla %>%
  mutate(Significance = case_when(
    p.value <= 0.05 ~ "sig.",
    p.value > 0.05 & p.value <= 0.1  ~ "marg.",
    p.value > 0.1  ~ "not sig."))


term_labels_chla <- c(
  "scale(NO3_mgL_dl * 1000)" = expression(NO[3]~(µg~L^-1)),
  "scale(PO4_ugL_dl)" = expression(PO[4]~(µg~L^-1)),
   # "scale(DOC_mgL_dl)" = expression(DOC~(mg~L^-1)),
  "scale(AFDM_mgg)" = expression(OM~(mg~g^-1)),
  "scale(NH4_mgL_dl * 1000)" = expression(NH[4]~(µ~L^-1)),
  "scale(wtr_m)" = expression(Temp~(degree~C)),
  "scale(Q_m)" = expression(Q~(m^3~s^-1))
)

# Add an offset column based on Catchment
fxd_eff_chla1 <- fxd_eff_chla1 %>%
  mutate(y_position = as.numeric(reorder(term, estimate)) + ifelse(Catchment == "BW", 0.2, 0))


chla_coeff_plot <-ggplot(fxd_eff_chla1, aes(x = estimate, y = reorder(term, estimate), color = Catchment, shape = Significance)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0, alpha = 0.85, position = position_dodge(width = 0.3)) +
  theme_classic() +
  scale_shape_manual(values = c(1,4, 19)) +
  scale_color_manual(values = catch_colors) +
  geom_vline(xintercept = 0) +
  labs(
    x = NULL,
    y = NULL,
    title = "Epilithic chl-a"
  ) +
  scale_y_discrete(labels = term_labels_chla) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(size = 12)
  )
chla_coeff_plot

#########
```

### C. GPP models

##### BW:

```{r, warning=F, size = 'small', echo=T, include=F, fig.width=6, fig.height=4}
# What's the response distribution? 

covariat_datq_BW_na <- covariat_datq_BW %>%
  drop_na(GPP_mean) %>%
  mutate(ab_ER = ER_mean*-1)

covariat_datq_BW_na$Q_m <- (log(covariat_datq_BW_na$Q_m+1))

# Possibility still too skewed to use a normal distribution in lmer. 

```

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}
gpp_mod_bw <- lmer(log(GPP_mean+1) ~ 
                        scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                         scale(PAR_surface) + (1|site), 
                  data=covariat_datq_BW_na)

summary(gpp_mod_bw)
vif(gpp_mod_bw)
#hist(residuals(gpp_mod_bw),main = paste(NULL))
r.squaredGLMM(gpp_mod_bw)
```

```{r, warning=F, size = 'small', echo=F, include=FALSE, fig.width=6, fig.height=4}

# Extract fixed effects and confidence intervals
fixed_effects_nep <- broom.mixed::tidy(gpp_mod_bw, effects = "fixed", conf.int = TRUE)
# Filter to exclude intercept and arrange predictors
fixed_effects_nep <- fixed_effects_nep[fixed_effects_nep$term != "(Intercept)", ]
fixed_effects_nep <- fixed_effects_nep[order(fixed_effects_nep$estimate), ]  # Order by estimate
fixed_effects_nep$Catchment <- "BW"
```

##### GB:

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
# What's the response distribution? 

covariat_datq_GB_na <- covariat_datq_GB %>%
    drop_na(GPP_mean) %>%
  mutate(ab_ER = ER_mean*-1)

  #drop_na(GPP_mean)
```

Highly skewed even when log transformed.

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}
gpp_mod_gb <- lmer(log(GPP_mean+1) ~ 
                        scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                         scale(PAR_surface) + (1|site), data=covariat_datq_GB_na)

summary(gpp_mod_gb)
vif(gpp_mod_gb)
#hist(residuals(gpp_mod_gb), main = paste(NULL))
r.squaredGLMM(gpp_mod_gb)

```

```{r, warning=F, size = 'small', echo=T, fig.width=6, fig.height=4}

fixed_effects_nep1 <- broom.mixed::tidy(gpp_mod_gb, effects = "fixed", conf.int = TRUE)
# Filter to exclude intercept and arrange predictors
fixed_effects_nep1 <- fixed_effects_nep1[fixed_effects_nep1$term != "(Intercept)", ]
fixed_effects_nep1 <- fixed_effects_nep1[order(fixed_effects_nep1$estimate), ]  # Order by estimate
fixed_effects_nep1$Catchment <- "GB"
```

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
fxd_eff_nep <- rbind(fixed_effects_nep, fixed_effects_nep1)

fxd_eff_nep1 <- fxd_eff_nep %>%
  mutate(Significance = case_when(
    p.value <= 0.05 ~ "sig.",
    p.value > 0.05 & p.value <= 0.1  ~ "marg.",
    p.value > 0.1  ~ "not sig."))


term_labels_nep <- c(
  "scale(NO3_mgL_dl * 1000)" = expression(NO[3]~(µg~L^-1)),
  "scale(PO4_ugL_dl)" = expression(PO[4]~(µg~L^-1)),
    "scale(AFDM_mgg)" = expression(OM~(mg~g^-1)),
 # "scale(DOC_mgL_dl)" = expression(DOC~(mg~L^-1)),
  "scale(NH4_mgL_dl * 1000)" = expression(NH[4]~(µ~L^-1)),
  "scale(wtr_m)" = expression(Temp~(degree~C)),
  "scale(Q_m)" = expression(Q~(m^3~s^-1))
)

# Add an offset column based on Catchment
fxd_eff_nep1 <- fxd_eff_nep1 %>%
  mutate(y_position = as.numeric(reorder(term, estimate)) + ifelse(Catchment == "BW", 0.2, 0))


nep_coeff_plot <-ggplot(fxd_eff_nep1, aes(x = estimate, y = reorder(term, estimate), color = Catchment, shape = Significance)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0, alpha = 0.85, position = position_dodge(width = 0.3)) +
  theme_classic() +
  scale_shape_manual(values = c(1,4, 19)) +
  scale_color_manual(values = catch_colors) +
  geom_vline(xintercept = 0) +
  labs(
    x = "Scaled effect size",
    y = "Predictors",
    title = "GPP"
  ) +
  scale_y_discrete(labels = term_labels_nep) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(size = 12)
  )
```

### D. \|ER\| models

##### BW:

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}
er_mod_bw <- lmer(log(ab_ER+1) ~ 
                    scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                        scale(PAR_surface) + (1|site), 
                  data=covariat_datq_BW_na)

summary(er_mod_bw)
vif(er_mod_bw)
#hist(residuals(er_mod_bw), main = paste(NULL))
r.squaredGLMM(er_mod_bw)

```

```{r, warning=F, size = 'small', echo=T, fig.width=6, fig.height=4}
# Extract fixed effects and confidence intervals
fixed_effects_er <- broom.mixed::tidy(er_mod_bw, effects = "fixed", conf.int = TRUE)
# Filter to exclude intercept and arrange predictors
fixed_effects_er <- fixed_effects_er[fixed_effects_er$term != "(Intercept)", ]
fixed_effects_er <- fixed_effects_er[order(fixed_effects_er$estimate), ]  # Order by estimate
fixed_effects_er$Catchment <- "BW"
```

##### GB:

```{r, warning=F, size = 'small', echo=T, fig.width=3, fig.height=3.5}
er_mod_gb <- lmer(log(ab_ER+1) ~ 
                    scale(tot_NO3_ugL) + 
                         scale(tot_NH4_ugL) + 
                        scale(AFDM_mgg)+
                         scale(wtr_m) + 
                         scale(Q_m) + 
                        scale(PAR_surface) +  (1|site),
                  data=covariat_datq_GB_na)

summary(er_mod_gb)
vif(er_mod_gb)
#hist(residuals(er_mod_gb), main = paste(NULL))
r.squaredGLMM(er_mod_gb)
```

```{r, warning=F, size = 'small', echo=T, fig.width=6, fig.height=4}

fixed_effects_er1 <- broom.mixed::tidy(er_mod_gb, effects = "fixed", conf.int = TRUE)
# Filter to exclude intercept and arrange predictors
fixed_effects_er1 <- fixed_effects_er1[fixed_effects_er1$term != "(Intercept)", ]
fixed_effects_er1 <- fixed_effects_er1[order(fixed_effects_er1$estimate), ]  # Order by estimate
fixed_effects_er1$Catchment <- "GB"
```

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
fxd_eff_er <- rbind(fixed_effects_er, fixed_effects_er1)

fxd_eff_er1 <- fxd_eff_er %>%
  mutate(Significance = case_when(
    p.value <= 0.05 ~ "sig.",
    p.value > 0.05 & p.value <= 0.1  ~ "marg.",
    p.value > 0.1  ~ "not sig."))


term_labels_er <- c(
  "scale(NO3_mgL_dl * 1000)" = expression(NO[3]~(µg~L^-1)),
  "scale(PO4_ugL_dl)" = expression(PO[4]~(µg~L^-1)),
    "scale(AFDM_mgg)" = expression(OM~(mg~g^-1)),
 # "scale(DOC_mgL_dl)" = expression(DOC~(mg~L^-1)),
  "scale(NH4_mgL_dl * 1000)" = expression(NH[4]~(µ~L^-1)),
  "scale(wtr_m)" = expression(Temp~(degree~C)),
  "scale(Q_m)" = expression(Q~(m^3~s^-1))
)

# Add an offset column based on Catchment
fxd_eff_er1 <- fxd_eff_er1 %>%
  mutate(y_position = as.numeric(reorder(term, estimate)) + ifelse(Catchment == "BW", 0.2, 0))

er_coeff_plot <-ggplot(fxd_eff_er1, aes(x = estimate, y = reorder(term, estimate), color = Catchment, shape = Significance)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0, alpha = 0.85, position = position_dodge(width = 0.3)) +
  theme_classic() +
  scale_shape_manual(values = c(1,4, 19)) +
  scale_color_manual(values = catch_colors) +
  geom_vline(xintercept = 0) +
  labs(
    x = "Scaled effect size",
    y = NULL,
    title = "|ER|"
  ) +
  scale_y_discrete(labels = term_labels_er) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(size = 12)
  )

er_coeff_plot

```

### Figure 3: General drivers for biomass, chl-a and GPP

#### (Q1) - How does stream metabolism vary based on catchment characteristics, antecedent flow conditions, and nitrogen availability?

Mainly addresses how productivity is associated with nutrients and water
quality:

```{r, warning=F, size = 'small', echo=F, fig.width=6, fig.height=6}

### big grid 
coeff_grid <- ggarrange(
  Biomass_coeff_plot,
  chla_coeff_plot,
  nep_coeff_plot,
  er_coeff_plot,
  ncol = 2, nrow = 2,
  common.legend = TRUE, 
  labels=c("a", "b", "c", "d"),
  legend = "bottom")
# 
# 
# coeff_grid <- ggarrange(
#   Biomass_coeff_plot + theme(legend.position = "bottom") + 
#     guides(color = guide_legend(nrow = 2), shape = guide_legend(nrow = 3)),
#   chla_coeff_plot + theme(legend.position = "bottom") + 
#     guides(color = guide_legend(nrow = 2), shape = guide_legend(nrow = 3)),
#   nep_coeff_plot + theme(legend.position = "bottom") + 
#     guides(color = guide_legend(nrow = 2), shape = guide_legend(nrow = 3)),
#   er_coeff_plot + theme(legend.position = "bottom") + 
#     guides(color = guide_legend(nrow = 3), shape = guide_legend(nrow = 4)),
#   labels=c("a", "b", "c", "d"),
#   ncol = 1, nrow = 4,
#   common.legend = TRUE,
#   legend = "bottom"
# )

coeff_grid
```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Fig4_coeff_ecol_CH1_grid.png", plot = coeff_grid, width = 5.5, height = 5.25, units = "in")

```

In general GPP may be more a function of physical conditions but is
partially associated with NH4.

# Part2/ Question 2

### Nitrogen demand and supply dynamics

#### Calculate nitrogen supply and demand:

```{r, warning=F, size = 'small', echo=T, include=T,fig.width=6, fig.height=4}
# Constants
ra <- 0.5  # Autotrophic respiration coefficient (Hall & Tank 2003)
C_Nauto <- 16  # Autotrophic C:N ratio (Stelzer & Lamberti 2001)
C_Nhetero <- 20  # Heterotrophic C:N ratio (Hall & Tank 2003)
HGE <- 0.05  # Heterotrophic Growth Efficiency (Hall & Tank 2003)

# Calculate components of nitrogen demand
covariat_nitrogen2 <- covariat_datq %>%
  filter(substrate=="sw")%>% # select just surface water samples
  group_by(site) %>% 
  arrange(date) %>%  # Ensure chronological order
  mutate( ## 17 NAs
    v_mi = ifelse(is.na(v_m), 
                  rollapplyr(v_m, width = 3, FUN = function(x) mean(x, na.rm = TRUE), fill = NA, partial = TRUE), 
                  v_m),
    w_mi = ifelse(is.na(w_m), 
                  rollapplyr(w_m, width = 3, FUN = function(x) mean(x, na.rm = TRUE), fill = NA, partial = TRUE), 
                  w_m)
  ) %>%
  # Carry forward any remaining NAs
  mutate(
    v_mi = zoo::na.locf(v_mi, na.rm = FALSE),
    v_mi = zoo::na.locf(v_mi, fromLast = TRUE, na.rm = FALSE),
    w_mi = zoo::na.locf(w_mi, na.rm = FALSE),
    w_mi = zoo::na.locf(w_mi, fromLast = TRUE, na.rm = FALSE)
  ) %>%
  # If there are still missing values, replace them with the site mean
  mutate(
    v_mi = ifelse(is.na(v_mi), mean(v_m, na.rm = TRUE), v_mi),
    w_mi = ifelse(is.na(w_mi), mean(w_m, na.rm = TRUE), w_mi)
  ) %>%
  ungroup()%>%
  ## should already be at detection limits
  # filter(water_year < 2024) %>%
  # mutate(NO3_mgL_dl = if_else(NO3_mgL_dl < 0.0015, 0.0015, NO3_mgL_dl))%>%
  #   mutate(NH4_mgL_dl=if_else(NH4_mgL_dl < 0.001, 0.001, NH4_mgL_dl))%>%
  #   mutate(PO4_ugL_dl=if_else(PO4_ugL_dl < 0.201, 0.201, PO4_ugL_dl))%>%
  mutate(
    
    ## ** Pause here to double check Q units
    Q_Ls = Q_m * 1000, # flow from csm to Ls
    # Autotrophic respiration (raGPP)
    raGPP = GPP_mean * ra,
    # Autotrophic assimilation of N
    Auto_N_assim = GPP_mean / C_Nauto,
    # Heterotrophic respiration (Rh)
    Rh = ER_mean - raGPP,
    # Heterotrophic assimilation of N
    Hetero_N_assim = (Rh * HGE) / C_Nhetero,
    # Total nitrogen demand
    Ndemand = Auto_N_assim + Hetero_N_assim, # unit should be g N m-2 d-1
    # calculate reach length in m
    reachL = c(((v_mi*10)*w_mi*86.4)/K600_daily_mean),
    Ndemand = if_else(Ndemand < 0, 0.0001, Ndemand), # have demand be essentially zero 
   # Calculate no3 supply 
   NO3_supply = c(((86400*Q_Ls*NO3_mgL_dl)/(w_mi*reachL))/1000),
   # Calculate nh3 supply 
   NH4_supply = c(((86400*Q_Ls*NH4_mgL_dl)/(w_mi*reachL))/1000), ## unit should be g N m-2 d-1
   PO4_supply = c(((86400*Q_Ls*(PO4_ugL_dl/1000))/(w_mi*reachL))/1000) ## unit should be g N m-2 d-1
   )


```

### Plots of Ratios of NH4+- N supply to demand, ratios NO3-- N supply to demand

```{r, warning=F, size = 'small', echo=T, include=F}
covariat_NS_ND <- covariat_nitrogen2%>%
  mutate(jday = yday(date))%>%
  dplyr:: select(date, jday, site, catch, water_year, Ndemand, NO3_supply, NH4_supply) %>%
  mutate(NO3_SupDem = (NO3_supply/Ndemand),
         NH4_SupDem = (NH4_supply/Ndemand))

N_ratio_plots <- ggplot(covariat_NS_ND, aes(x = log(NO3_supply+1), y = Ndemand, color = site, shape=site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
    geom_point( aes(x = log(NH4_supply+1), y = Ndemand, color = site),
                size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
  scale_color_manual(values = siteC_colors) +
      scale_shape_manual(values = c(15,0,17,2)) +
  xlim(0,1) +
   ylab(expression(Nitrogen~demand~(g~N~m^-2~d^-1))) +
     xlab(expression(log(Nitrogen~supply+1)~(g~N~m^-2~d^-1))) +
  theme_classic()


NO3_supp_plots <- ggplot(covariat_NS_ND%>%filter(NO3_supply<60), aes(y = log(NO3_supply+1), x = jday, color = site, shape=site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
    geom_point( aes(y = log(NH4_supply+1), x = jday, color = site, shape=site), 
                size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = siteC_colors) +
  xlim(15,360) +
  #  ylim(0,5) +
   xlab(NULL) +
     ylab(expression(log(Supply+1)~(g~N~m^-2~d^-1))) +
  theme_classic() +
  scale_shape_manual(values = c(15,0,17,2)) +
    theme(legend.position = "none")  # Remove legend

N_demand_plot1 <- ggplot(covariat_NS_ND, aes(y = (Ndemand), x = jday, color = site,  shape=site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.8)) +
  scale_color_manual(values = siteC_colors) +
   xlab("Day of year") +
    xlim(15,360) +
    scale_shape_manual(values = c(15,0,17,2)) +
   ylab(expression(Demand~~(g~N~m^-2~d^-1))) +
  theme_classic() +
    theme(legend.position = "none")  # Remove legend
```

##### Summary of reach based surface water supply

```{r, warning=F, size = 'small', echo=F, include=T}
## Summary stats for days with N supply and demand

covariat_NS_check <- covariat_NS_ND%>%
  filter(NO3_SupDem<=0.9)
length(unique(covariat_NS_check$date))

covariat_NH4_check <- covariat_NS_ND%>%
  filter(NH4_SupDem<=0.9)
length(unique(covariat_NH4_check$date))


covariat_NS_check2 <- covariat_NS_ND%>%
  filter(NO3_SupDem>=0.99)

length(unique(covariat_NS_check2$date))


covariat_NS_ND_sum <- covariat_nitrogen2%>%
  group_by(catch)%>%
  summarise(
    N_supplym =mean(NO3_supply+NH4_supply, na.rm=T),
    NO3_supplym =mean(NO3_supply, na.rm=T),
            NO3_supplymin =min(NO3_supply, na.rm=T),
           NO3_supplymax =max(NO3_supply, na.rm=T),
            NH4_supplym =mean(NH4_supply, na.rm=T),
           NH4_supplymin =min(NH4_supply, na.rm=T),
            NH4_supplymax =max(NH4_supply, na.rm=T),
          PO4_supplym =mean(PO4_supply, na.rm=T),
           PO4_supplymin =min(PO4_supply, na.rm=T),
            PO4_supplymax =max(PO4_supply, na.rm=T)
          )
covariat_NS_ND_sum
```

## Figure 4: Nitrogen supply and demand seasonally at each reach

### (Q2) - Is variance in nitrogen demand and instream uptake (either as ammonium or nitrate) more related to biological (GPP, ER, biomass or chlorophyll-a), physical processes (flow and water temperature), or ambient nutrient and organic matter availability? 

```{r, warning=F, size = 'small', echo=T, fig.width=8, fig.height=4}

# n_s_grid <- ggarrange(
#   NO3_supp_plots,
#   N_demand_plot1,
#   labels = c("b","c"),
#   ncol = 1, nrow = 2)


n_s_grid <- ggarrange(
  NO3_supp_plots,
  N_demand_plot1,
  labels = c("b", "c"),
  ncol = 1, nrow = 2,
  label.x = 0.95,  # Move label to the right
  label.y = 1,     # Keep label at the top
  hjust = 1,       # Right-align the label
  vjust = 1        # Top-align the label
)

# 
# # Create the top row with extra spacing on both sides
# #left_col <- ggdraw() + draw_plot(N_ratio_plots, x = 0.15, height = 0.85)  # Centered with 25% narrower width
# left_col <- ggdraw() + 
#   draw_plot(N_ratio_plots, x = 0.15, y = 0.075, height = 0.85) 

### big grid 
Ndyn_grid <- ggarrange(
  N_ratio_plots,
  n_s_grid,
  ncol = 2, nrow = 1,
    labels = c("a", ""),
  common.legend = TRUE, 
   widths = c(1.75, 2.25),
  legend = "bottom")

Ndyn_grid

```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Nsupply_grid_CH1.png", plot = Ndyn_grid, width = 9.25, height = 4.75, units = "in")

```




### Plots of Ratios of NH4+- N supply to demand, ratios NO3-- N supply to demand colored by DOY

```{r, warning=F, size = 'small', echo=T, include=F}
covariat_NS_ND <- covariat_nitrogen2%>%
  mutate(jday = yday(date))%>%
  dplyr:: select(date, jday, site, catch, water_year, Ndemand, NO3_supply, NH4_supply) %>%
  mutate(NO3_SupDem = (NO3_supply/Ndemand),
         NH4_SupDem = (NH4_supply/Ndemand))


## adjust the demand y axis to be from 0 to 1 

N_ratio_plots <- ggplot(covariat_NS_ND, aes(x = log(NO3_supply+1), y = Ndemand, color = jday, shape=site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
    geom_point( aes(x = log(NH4_supply+1), y = Ndemand, color = jday),
                size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
  geom_abline(slope = 1, intercept = 0, color = "black") +  # 1:1 line
    scale_color_viridis_c(option = "magma",  name = "Day of year") +
      scale_shape_manual(values = c(15,0,17,2)) +
  xlim(0,1) +
  ylim(0, 1) +
   ylab(expression(Nitrogen~demand~(g~N~m^-2~d^-1))) +
     xlab(expression(log(Nitrogen~supply+1)~(g~N~m^-2~d^-1))) +
  theme_classic()


NO3_supp_plots <- ggplot(covariat_NS_ND%>%filter(NO3_supply<60), aes(y = log(NO3_supply+1), x = jday, color = jday, shape=site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
    geom_point( aes(y = log(NH4_supply+1), x = jday, color = jday, shape=site), 
                size = 3, alpha = 0.85, position = position_dodge(width = 0.3)) +
    scale_color_viridis_c(option = "viridis", name = "Day of year") +  # Use _c for continuous data
  xlim(15,360) +
  #  ylim(0,5) +
   xlab(NULL) +
     ylab(expression(log(Supply+1)~(g~N~m^-2~d^-1))) +
  theme_classic() +
  scale_shape_manual(values = c(15,0,17,2)) +
    theme(legend.position = "none")  # Remove legend


N_demand_plot1 <- ggplot(covariat_NS_ND, aes(y = (Ndemand), x = jday, color = jday, shape = site)) +
  geom_point(size = 3, alpha = 0.85, position = position_dodge(width = 0.8)) +
  scale_color_viridis_c(option = "viridis", name = "Day of year") +  # Use _c for continuous data
  xlab("Day of year") +
  xlim(15, 360) +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
  ylab(expression(Demand~~(g~N~m^-2~d^-1))) +
  theme_classic() +
  theme(legend.position = "none")  # Remove legend

N_demand_plot1

```


```{r, warning=F, size = 'small', echo=T, fig.width=8, fig.height=4}

n_s_grid <- ggarrange(
  NO3_supp_plots,
  N_demand_plot1,
  labels = c("b", "c"),
  ncol = 1, nrow = 2,
  label.x = 0.95,  # Move label to the right
  label.y = 1,     # Keep label at the top
  hjust = 1,       # Right-align the label
  vjust = 1        # Top-align the label
)


Ndyn_grid <- ggarrange(
  N_ratio_plots,
  n_s_grid,
  ncol = 2, nrow = 1,
    labels = c("a", ""),
  common.legend = TRUE, 
   widths = c(1.75, 2.25),
  legend = "bottom")

Ndyn_grid

```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Nsupply_grid_CH1_v2.png", plot = Ndyn_grid, width = 9.25, height = 4.75, units = "in")

```



##### Calculations of flow normalized NO3 and NH4 average daily loads by water year:

```{r, warning=F, size = 'small', echo=T, include=FALSE,fig.width=6, fig.height=4}
WY_nloads <- covariat_nitrogen2 %>%
  mutate(mon = month(date)) %>%
  filter(mon > 6 & mon < 11) %>%
  filter(water_year < 2024) %>%
  group_by(site, water_year) %>%
  mutate(Ls = Q_m * 1000,  # Convert cubic meters per second to liters per second
         NO3_N_sec = NO3_mgL_dl * Ls,  # mg/L * L/s = mg/s
         NH4_N_sec = NH4_mgL_dl * Ls,  
         NO3_N_mg = NO3_N_sec * 86.4,  # / 1e6 if want kg Convert mg/s to kg/day (1 kg = 1e6 mg)
         NH4_N_mg = NH4_N_sec * 86.4) %>%
  summarise(NO3_Q = mean(NO3_N_mg, na.rm = TRUE),
            NO3_Qsd = sd(NO3_N_mg, na.rm = TRUE),
            NH4_Q = mean(NH4_N_mg, na.rm = TRUE),
            NH4_Qsd = sd(NH4_N_mg, na.rm = TRUE))

WY_nloads
```

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
n_up_sum <-n_up%>%
  filter(success=="yes") %>%
  dplyr::group_by(method, site) %>%
  dplyr::summarise(
    Uadd_ug_L = mean(Uadd_ug_L_min, na.rm=T),
    Uadd_ug_L_MIN = min(Uadd_ug_L_min, na.rm=T),
    Uadd_ug_L_MAX = max(Uadd_ug_L_min, na.rm=T),
    sw = mean(sw_m, na.rm=T),
    sw_MIN = min(sw_m, na.rm=T),
    sw_MAX = max(sw_m, na.rm=T),
    Vf_m = mean(Vf_m_min, na.rm=T),
    Vf_m_MIN = min(Vf_m_min, na.rm=T),
    Vf_m_MAX = max(Vf_m_min, na.rm=T))

nup_sum_plot <-ggplot(n_up_sum, aes(x = site, y = Uadd_ug_L, color = site, shape = method)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = Uadd_ug_L_MIN, ymax = Uadd_ug_L_MAX),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic() + ylab(expression(U[t]~(µg~m^-2~min^-1)))+
  # ylab(expression(U[t]~(µg~L^-1~min^-1)))+
  xlab(NULL) +
  #scale_shape_manual(values = c(4, 19)) +
  scale_color_manual(values = siteC_colors) #+ theme(axis.text.x = element_text(angle = 45, hjust = 1))


nvf_sum_plot <-ggplot(n_up_sum, aes(x = site, y = Vf_m, color = site, shape = method)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = Vf_m_MIN, ymax = Vf_m_MAX),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic()  + ylab(expression(V[f]~(m~min^-1)))+
 # ylab(expression(V[f]~(µg~m^-1~min^-1)))+
  xlab(NULL) +
  #scale_shape_manual(values = c(4, 19)) +
  scale_color_manual(values = siteC_colors) #+ theme(axis.text.x = element_text(angle = 45, hjust = 1))


nsw_sum_plot <-ggplot(n_up_sum, aes(x = site, y = sw, color = site, shape = method)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = sw_MIN, ymax = sw_MAX),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic()  + ylab(expression(S[w]~(m)))+
  xlab(NULL) +
  #scale_shape_manual(values = c(4, 19)) +
  scale_color_manual(values = siteC_colors) #+ theme(axis.text.x = element_text(angle = 45, hjust = 1))



```

##### Plot for nitrogen cycling by reach location

Figure 5 a-c

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=5, fig.height=3}
# Combine plots with a shared legend
Nup_grid <- ggarrange(
  nup_sum_plot,
  nvf_sum_plot,
  nsw_sum_plot,
  ncol = 3, nrow = 1,
  labels=c("a", "b", "c"), 
  common.legend = TRUE,
  legend = "right"
)

Nup_grid <- Nup_grid + 
  theme(legend.box = "vertical",        # Arrange legends vertically
        legend.text = element_text(size = 10),  # Adjust legend text size if needed
        legend.title = element_text(size = 12)) +
  guides(
    color = guide_legend(nrow = 1),    # Put colors on one row
    shape = guide_legend(nrow = 1)    # Put shapes on another row
  )

Nup_grid
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Nuptake_CH1_gridv2.png", plot = Nup_grid, width = 7, height = 2.5, units = "in")
```

#### Correlations between N uptake and ...

-   

    (d) biomass

-   

    (e) chl-a

-   

    (f) GPP

-   

    (g) ER

-   

    (h) Q

-   

    (i) temp

###### Dataframe for successfull N uptatke

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3.5}
covariat_N <- covariat_datq %>%
  filter(Uadd_ug_L_min < 121) %>%
  filter(success=="yes")%>%
  dplyr::select(site, catch, date, water_year, Chla_ugL_Q, method, Uadd_ug_L_min, 
         Uadd_min_sd, sw_m, sw_sd, Vf_m_min, vf_min_sd, GPP_mean, ER_mean,
         AFDM_ugcm2, Q_m, wtr_m, AFDM_mgg) %>%
    drop_na(Uadd_ug_L_min) 

covariat_NU <- covariat_N %>% distinct()


#hist(covariat_NU$Uadd_ug_L_min,  main = paste(NULL))
#hist(log(covariat_NU$Uadd_ug_L_min+1),  main = paste(NULL))

covariat_NU_B <- covariat_NU%>%
  filter(catch=="BW")

covariat_NU_G <- covariat_NU%>%
  filter(catch=="GB")

```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3.5}
U_mod_OM <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(AFDM_mgg) + (1|site), data=covariat_NU_B)
summary(U_mod_OM)
#hist(residuals(U_mod_OM),main = paste(NULL))

U_mod_bio_r2_vals <- r.squaredGLMM(U_mod_OM)
U_mod_bio_r2_vals
```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3.5}
U_mod_OM <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(AFDM_mgg) + (1|site), data=covariat_NU_G)
summary(U_mod_OM)
#hist(residuals(U_mod_OM),main = paste(NULL))

U_mod_bio_r2_vals <- r.squaredGLMM(U_mod_OM)
U_mod_bio_r2_vals
```

#### d) Uptake and epilithic biomass:

##### BW:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3.5}
U_mod_bio <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(AFDM_ugcm2) + (1|site), data=covariat_NU_B)
summary(U_mod_bio)
#hist(residuals(U_mod_bio),main = paste(NULL))

U_mod_bio_r2_vals <- r.squaredGLMM(U_mod_bio)
U_mod_bio_conditional_r2 <- round(U_mod_bio_r2_vals[2], 2)

```

##### GB:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3.5}
U_mod_biog <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(AFDM_ugcm2) + (1|site), data=covariat_NU_G)
summary(U_mod_biog)
#hist(residuals(U_mod_bio),main = paste(NULL))
U_mod_bio_r2_valsg <- r.squaredGLMM(U_mod_bio)
U_mod_bio_conditional_r2g <- round(U_mod_bio_r2_vals[2], 2)

```

#### e) Uptake and chl-a:

##### BW:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_chla <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(Chla_ugL_Q) + (1|site), data=covariat_NU_B)

summary(U_mod_chla)
#hist(residuals(U_mod_chla),main = paste(NULL))
r.squaredGLMM(U_mod_chla)

U_mod_chla_r2_vals <- r.squaredGLMM(U_mod_chla)
U_mod_chla_conditional_r2 <- round(U_mod_chla_r2_vals[2], 2)
```

##### GB:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_chlag <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale((Chla_ugL_Q)) + (1|site), data=covariat_NU_G)

summary(U_mod_chlag)
#hist(residuals(U_mod_chlag),main = paste(NULL))
r.squaredGLMM(U_mod_chlag)

U_mod_chla_r2_vals <- r.squaredGLMM(U_mod_chlag)
U_mod_chla_conditional_r2 <- round(U_mod_chla_r2_vals[2], 2)
```

#### f) Uptake and GPP:

##### BW:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_GPP <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(log(GPP_mean+1)) + (1|site), data=covariat_NU_B)

summary(U_mod_GPP)
#hist(residuals(U_mod_GPP), main = paste(NULL))

U_mod_GPP_r2_vals <- r.squaredGLMM(U_mod_GPP)
U_mod_GPP_conditional_r2 <- round(U_mod_GPP_r2_vals[2], 2)
```

##### GB:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}

U_mod_GPPg <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(log(GPP_mean+1)) + (1|site), data=covariat_NU_G)

summary(U_mod_GPPg)
#hist(residuals(U_mod_GPP), main = paste(NULL))
U_mod_GPP_r2_vals <- r.squaredGLMM(U_mod_GPPg)
U_mod_GPP_conditional_r2 <- round(U_mod_GPP_r2_vals[2], 2)
```

#### g) Uptake and \|ER\|:

##### BW:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_ER <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale((ER_mean*-1)) + (1|site), data=covariat_NU_B)

summary(U_mod_ER)
#hist(residuals(U_mod_ER), main = paste(NULL))
U_mod_ER_r2_vals <- r.squaredGLMM(U_mod_ER)
U_mod_ER_conditional_r2 <- round(U_mod_ER_r2_vals[2], 2)
```

##### GB:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_ER <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale((ER_mean*-1)) + (1|site), data=covariat_NU_G)

summary(U_mod_ER)
#hist(residuals(U_mod_ER), main = paste(NULL))
U_mod_ER_r2_vals <- r.squaredGLMM(U_mod_ER)
U_mod_ER_conditional_r2 <- round(U_mod_ER_r2_vals[2], 2)

```

#### h) Uptake and Q:

##### BW:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_Q <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(log(Q_m+1)) + (1|site), data=covariat_NU_B)

summary(U_mod_Q)
#hist(residuals(U_mod_Q), main = paste(NULL))
U_mod_Q_r2_vals <- r.squaredGLMM(U_mod_Q)
U_mod_Q_conditional_r2 <- round(U_mod_Q_r2_vals[2], 2)
```

##### GB:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_Qg <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(log(Q_m)+1) + (1|site), data=covariat_NU_B)

summary(U_mod_Qg)
#hist(residuals(U_mod_Qg), main = paste(NULL))
U_mod_Q_r2_vals <- r.squaredGLMM(U_mod_Qg)
U_mod_Q_conditional_r2 <- round(U_mod_Q_r2_vals[2], 2)
```

#### i) Uptake and temp:

##### BW:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_temp <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(wtr_m) + (1|site), data=covariat_NU_B)

summary(U_mod_temp)
#hist(residuals(U_mod_temp), main = paste(NULL))
r.squaredGLMM(U_mod_temp)
```

##### GB:

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}

U_mod_tempg <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(wtr_m) + (1|site), data=covariat_NU_G)

summary(U_mod_tempg)
#hist(residuals(U_mod_temp), main = paste(NULL))
r.squaredGLMM(U_mod_tempg)
```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_NO3 <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(NO3_mgL_dl) + (1|site), data=covariat_datq_BW)

summary(U_mod_NO3)
#hist(residuals(U_mod_NO3), main = paste(NULL))
r.squaredGLMM(U_mod_NO3)
```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_NO3 <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(NO3_mgL_dl) + (1|site), data=covariat_datq_GB%>%filter(NO3_mgL_dl<0.7780))

summary(U_mod_NO3)
#hist(residuals(U_mod_NO3), main = paste(NULL))
r.squaredGLMM(U_mod_NO3)
```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_NH4 <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(NH4_mgL_dl) + (1|site), data=covariat_datq_BW%>%filter(substrate=="pw"))

summary(U_mod_NH4)
#hist(residuals(U_mod_NH4), main = paste(NULL))
r.squaredGLMM(U_mod_NH4)
```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
U_mod_NH4 <- lmer(log(Uadd_ug_L_min+1) ~ 
                      scale(NH4_mgL_dl) + (1|site), data=covariat_datq_GB%>%filter(substrate=="pw"))

summary(U_mod_NH4)
#hist(residuals(U_mod_NH4), main = paste(NULL))
r.squaredGLMM(U_mod_NH4)
```

#### Plots of Ut and all linear model covariates by stream

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
U_OM_plt<- ggplot(covariat_datq, aes(x=AFDM_mgg, y = Uadd_ug_L_min, color =catch, shape=method)) + 
  geom_point(size=2, alpha=0.75) + theme_classic() + 
   ylab(expression(U[t]~(µg~L^-1~min^-1)))+
  xlab(expression(OM~(mg~g^-1)))+
  scale_color_manual(values = catch_colors)

U_biomass_plt <- ggplot(covariat_NU, aes(x = AFDM_ugcm2, y = log(Uadd_ug_L_min + 1))) + 
  geom_point(aes(color = catch, shape = method), size = 2, alpha = 0.75) + 
  theme_classic() +
 # geom_smooth(method = "lm", aes(color = catch), se = FALSE, alpha=0.5, lty="dashed") + 
  #ylab(expression(log(U[t] + 1) ~ (µg~L^-1~min^-1))) +
  ylab(" ") +
  xlab(expression(Biomass~(µg~cm^2))) +
  scale_color_manual(values = catch_colors)

U_Chla_plt <- ggplot(covariat_NU, aes(x = log(Chla_ugL_Q+1), y = log(Uadd_ug_L_min + 1))) + 
  geom_point(aes(color = catch, shape = method), size = 2, alpha = 0.75) + 
  theme_classic() + 
  geom_smooth(data = subset(covariat_NU), 
              aes(color = catch), method = "lm", se = FALSE, alpha = 0.5) + 
  ylab(expression(log(U[t] + 1) ~ (µg~L^-1~min^-1))) +
  xlab(expression(log(Chla+1)~(µg~L^-1))) +
  scale_color_manual(values = catch_colors)


U_GPP_plt<-ggplot(covariat_NU, aes(x=log(GPP_mean+1),  y = log(Uadd_ug_L_min+1))) + 
    geom_point(aes(color = catch, shape = method), size = 2, alpha = 0.75) + 
  theme_classic() + 
    geom_smooth(data = subset(covariat_NU, catch == "GB"), 
              aes(color = catch), method = "lm", se = FALSE, alpha = 0.5) + 
    ylab(expression(log(U[t] + 1) ~ (µg~L^-1~min^-1))) +
    xlab(expression(log(GPP+1)~(g~O[2]~m^-2~d^-1))) +
  scale_color_manual(values = catch_colors)

U_ER_plt<-ggplot(covariat_NU, aes(x=(ER_mean*-1),  y = log(Uadd_ug_L_min+1))) + 
    geom_point(aes(color = catch, shape = method), size = 2, alpha = 0.75) + 
  theme_classic() + 
      geom_smooth(data = subset(covariat_NU, catch == "GB"), 
              aes(color = catch), method = "lm", se = FALSE, alpha = 0.5, lty="dashed") +
        geom_smooth(data = subset(covariat_NU, catch == "BW"), 
              aes(color = catch), method = "lm", se = FALSE, alpha = 0.5) +
  geom_smooth(method = "lm", aes(color = catch), se = FALSE, alpha=0.5) + 
   #  ylab(expression(log(U[t]+1)~(µg~L^-1~min^-1)))+
  ylab(" ") +
          xlab(expression(abs(ER)~(g~O[2]~m^-2~d^-1))) +
  scale_color_manual(values = catch_colors)

U_temp_plt<-ggplot(covariat_NU, aes(x=wtr_m,  y = log(Uadd_ug_L_min+1), color =catch, shape=method)) + 
  geom_point(size=2, alpha=0.75) + theme_classic() + 
    ylab(expression(log(U[t] + 1) ~ (µg~L^-1~min^-1))) +
  #ylab(" ") +
        xlab(expression(Temp~(degree*C))) +
  scale_color_manual(values = catch_colors)

U_Q_plt<-ggplot(covariat_NU, aes(x=log(Q_m+1), y = log(Uadd_ug_L_min+1))) + 
      geom_point(aes(color = catch, shape = method), size = 2, alpha = 0.75) + 
  theme_classic() + 
  geom_smooth( aes(color = catch), method = "lm", se = FALSE, alpha = 0.5) +
    #ylab(expression(log(U[t] + 1) ~ (µg~L^-1~min^-1))) +
  ylab(" ") +
     xlab(expression(log(Q+1)~(m^3~s^-1))) +
  scale_color_manual(values = catch_colors)



U_NO3_plt<-ggplot(covariat_datq%>%filter(NO3_mgL_dl < 0.7780, !is.na(method), substrate=="pw"), 
                  aes(x=NO3_mgL_dl*1000, y = log(Uadd_ug_L_min+1))) + 
      geom_point(aes(color = catch, shape = method), size = 2, alpha = 0.75) + 
  theme_classic() + 
    xlim(0,290) +
 # geom_smooth(data = subset(covariat_datq, catch == "GB"), 
  #            aes(color = catch), method = "lm", se = FALSE, alpha = 0.5) +
    ylab(expression(log(U[t] + 1) ~ (µg~L^-1~min^-1))) +
  #ylab(" ") +
  xlab(expression(Ambient~NO[3]^-1~(µg~L^-1))) +
  scale_color_manual(values = catch_colors)

U_NH4_plt<-ggplot(covariat_datq%>%filter(!is.na(method) & substrate=="pw", NH4_mgL_dl < 0.15), aes(x=NH4_mgL_dl*1000, y = log(Uadd_ug_L_min+1))) + 
      geom_point(aes(color = catch, shape = method), size = 2, alpha = 0.75) + 
  theme_classic() + 
 # xlim(0,300) +
  geom_smooth(aes(color = catch), method = "lm", se = FALSE, alpha = 0.5) +
    #ylab(expression(log(U[t] + 1) ~ (µg~L^-1~min^-1))) +
  ylab(" ") +
  xlab(expression(Ambient~NH[4]^+1~(µg~L^-1))) +
  scale_color_manual(values = catch_colors)

```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=5}

Nup_grid2 <- ggarrange(
  U_biomass_plt,
  U_Chla_plt,
  U_GPP_plt,
  U_ER_plt,
  U_temp_plt,
  U_Q_plt,
  ncol = 3, nrow = 2,
  common.legend = TRUE,
  legend = "right"
)

```

### Figure 5: General drivers of either NO3 or NH4 uptake rates (Ut)

### (Q2) - Is variance in nitrogen demand and instream uptake (either as ammonium or nitrate) more related to biological (GPP, ER, biomass or chlorophyll-a), physical processes (flow and water temperature), or ambient nutrient and organic matter availability? 

Point color represents site, point shape by N uptake method triangles
are no3 and circles are nh4

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=8, fig.height=7}
#Nup_grid3 <- ggarrange(
  #Nup_grid,
  # nup_sum_plot, # a
  # nvf_sum_plot, # b
  # nsw_sum_plot, # c
#   U_biomass_plt, # d
#   U_GPP_plt, # g
#   U_temp_plt, # i
#   U_NO3_plt, # k
#   U_Chla_plt, # f
#   U_ER_plt, # h
#   U_Q_plt, # j
#   U_NH4_plt, # l
#   labels = c(#"a", "b", "c",
#              "d", "f", "h", "j", 
#              "e", "g", "i", "k"),
#   ncol = 3, nrow = 3,
#   common.legend = TRUE,
#   legend = "right"
# )
# 
# Nup_grid3
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=4.5, fig.height=12}
Nup_grid3 <- ggarrange(
  U_Chla_plt,
  U_biomass_plt,
  U_GPP_plt,
  U_ER_plt,
  U_temp_plt, # i
  U_Q_plt, # j
  U_NO3_plt, # k
  U_NH4_plt, # l
  labels = c("a", "b", "c", "d", 
             "e", "f", "g", "h"),
  ncol = 2, nrow = 4,
  common.legend = TRUE,
  legend = "right",
  label.x = 0.85,  
  label.y = 0.95   
)

Nup_grid3
```


```{r, warning=F, size = 'small', echo=F, include=F, fig.width=4.75, fig.height=7}
 
# # Create the top row with extra spacing on both sides
# #top_row <- ggdraw() + draw_plot(Nup_grid, x = 0.05, width = 0.95)  # Centered with 25% narrower width
# 
# # Arrange the plots
# Nup_grid4 <- plot_grid(
#   Nup_grid, Nup_grid3,
#   ncol = 1, rel_heights = c(1.1, 3.90)  # Keeps the bottom row proportionally larger
# )
# 
# # Display the plot
# print(Nup_grid4)
# # 
# # 
# # 
# # 
# # Nup_grid4 <- ggarrange(
# #   Nup_grid,
# #   Nup_grid3,
# #   ncol = 1, nrow = 2,
# #   common.legend = TRUE,
# #   legend = "right"
# #   ##
# # )
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/Nuptake_supp_CH1_grid.png", plot = Nup_grid3, width = 5.15, height = 8.5, units = "in")

```

### Metabolism by water year:

###### Dataframes:

For metabolism by water year March - October (2021-2024)

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
metab_dat<- water_year(metab_dat)

metab_plots_WY <- metab_dat %>%
  mutate(mon= month(date))%>%
  filter(mon>2 & mon<11) %>%
  filter(water_year<2025)%>%
  group_by(site, water_year) %>%
  summarise(GPP = mean(GPP_mean, na.rm=T),
            GPP_sd = sd(GPP_mean, na.rm=T),
            ER = mean(ER_mean, na.rm=T),
            ER_sd = sd(ER_mean, na.rm=T),
            GPP_se = sd(GPP_mean, na.rm = TRUE) / sqrt(length(GPP_mean)),
            ER_se = sd(ER_mean, na.rm = TRUE) / sqrt(length(ER_mean))
            ) %>%
  ungroup() %>%  # Remove grouping to calculate overall means
    mutate(
        GPP_se = if_else(is.na(GPP_se), mean(GPP_se, na.rm = TRUE), GPP_se), 
        ER_se = if_else(is.na(ER_se), mean(ER_se, na.rm = TRUE), ER_se)
        )
  
```

Metabolimsm regression analysis :

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}

metab_WY_lmdf <- metab_dat %>%
  mutate(mon= month(date))%>%
  filter(mon>2 & mon<11) %>%
  filter(water_year<2025)%>%
  mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  ))
```

For nitrogen dynamics by water year March - October (2021-2023)

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
nuts_plots_WY <- covariat_nitrogen2 %>%
  mutate(mon= month(date))%>%
  filter(mon>3 & mon<10) %>%
    filter(NO3_supply<200) %>%
  filter(water_year<2024) %>%
  group_by(site, water_year) %>%
  summarise(
            NO3_supplym = mean(NO3_supply, na.rm=T),
            NO3_supply_sd = sd(NO3_supply, na.rm=T),
            NH4_supplym = mean(NH4_supply, na.rm=T),
            NH4_supply_sd = sd(NH4_supply, na.rm=T),
            PO4_supplym = mean(PO4_supply, na.rm=T),
            PO4_supply_sd = sd(PO4_supply, na.rm=T),
            Ndemandm = mean(Ndemand, na.rm=T),
            Ndemand_sd = sd(Ndemand, na.rm=T),
            NH4_supply_se = sd(NH4_supply, na.rm = TRUE) / sqrt(length(NH4_supply)),
            NO3_supply_se = sd(NO3_supply, na.rm = TRUE) / sqrt(length(NO3_supply)),
            Ndemand_se = sd(Ndemand, na.rm = TRUE) / sqrt(length(Ndemand))
            ) %>%
  ungroup() %>%  # Remove grouping to calculate overall means
    mutate(
        NH4_supply_se = if_else(is.na(NH4_supply_se), mean(NH4_supply_se, na.rm = TRUE), NH4_supply_se), 
        NO3_supply_se = if_else(is.na(NO3_supply_se), mean(NO3_supply_se, na.rm = TRUE), NO3_supply_se),
        Ndemand_se = if_else(is.na(Ndemand_se), mean(Ndemand_se, na.rm = TRUE), Ndemand_se)
        )
```

```{r, warning=F, size = 'small', echo=F, include=FALSE}
covariat_WY <- covariat_nitrogen2 %>% # was covariat_datq
    mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",
    TRUE ~ NA_character_  
  )) %>%
  mutate(mon= month(date))%>%
  filter(mon>2 & mon<11) %>%
  filter(water_year<2025) 

covariat_WY<- covariat_WY%>%
  dplyr::select(site, catch, date, water_year, Chla_ugL_Q, method, Uadd_ug_L_min, 
         Ndemand, NO3_supply, NH4_supply, PO4_supply, WY_lab, GPP_mean, ER_mean,
         AFDM_ugcm2, Q_m, wtr_m) 

covariat_WY <- covariat_WY %>% distinct()

covariat_WY_sum <- covariat_WY %>%
  group_by(catch, WY_lab) %>%
  summarise(
    Ndemandtm = mean(Ndemand, na.rm=T),
    NH4_supplym = mean(NH4_supply, na.rm=T), 
    NO3_supplym = mean(NO3_supply, na.rm=T)
    )

metab_WY_sum <- metab_WY_lmdf %>%
  group_by(catch, WY_lab) %>%
  summarise(
    GPP_wym = mean(GPP_mean, na.rm=T),
    ER_wym = mean(ER_mean, na.rm=T)
    )
# pull out streams 
covariat_WY_B <- covariat_WY %>%
  filter(catch=="BW") 

covariat_WY_G <- covariat_WY %>%
  filter(catch=="GB") 

```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
(3.23-0.79)/3.23

(13.680257-10.864423)/13.680257

(0.20-0.08)/0.20

(6.211836-3.511)/6.211836


```

##### Linear models for metabolism across dry or wet years

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3}
lmm_WY_GPP <- lmer(GPP_mean ~ WY_lab + (1|site) + (1|catch), data = metab_WY_lmdf)
summary(lmm_WY_GPP)
#hist(residuals(lmm_WY_GPP), main = paste(NULL))
r.squaredGLMM(lmm_WY_GPP)

lmm_WY_GPP_BW <- lmer(GPP_mean ~ WY_lab + (1|site), data = metab_WY_lmdf%>%filter(catch=="BW"))
summary(lmm_WY_GPP_BW)
#hist(residuals(lmm_WY_GPP_BW), main = paste(NULL))
r.squaredGLMM(lmm_WY_GPP_BW)

lmm_WY_GPP_GB <- lmer(GPP_mean ~ WY_lab + (1|site), data = metab_WY_lmdf%>%filter(catch=="GB"))
summary(lmm_WY_GPP_GB)
#hist(residuals(lmm_WY_GPP_GB), main = paste(NULL))
r.squaredGLMM(lmm_WY_GPP_GB)

lmm_WY_ER <- lmer((ER_mean*-1) ~ WY_lab + (1|site) + (1|catch), data = metab_WY_lmdf)
summary(lmm_WY_ER)
#hist(residuals(lmm_WY_ER), main = paste(NULL))
r.squaredGLMM(lmm_WY_ER)

lmm_WY_ER_BW <- lmer((ER_mean*-1) ~ WY_lab + (1|site), data = metab_WY_lmdf%>%filter(catch=="BW"))
summary(lmm_WY_ER_BW)
#hist(residuals(lmm_WY_ER_BW), main = paste(NULL))
r.squaredGLMM(lmm_WY_ER_BW)

lmm_WY_ER_GB <- lmer((ER_mean*-1) ~ WY_lab + (1|site), data =  metab_WY_lmdf%>%filter(catch=="GB"))
summary(lmm_WY_ER_GB)
#hist(residuals(lmm_WY_ER_GB), main = paste(NULL))
r.squaredGLMM(lmm_WY_ER_GB)
```

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=3, fig.height=3.5}

lmm_WY_NO3_Q <- lmer(NO3_supply ~ WY_lab + (1|site) + (1|catch),, data = covariat_WY)
summary(lmm_WY_NO3_Q)
#hist(residuals(lmm_WY_NO3_Q), main = paste(NULL))
r.squaredGLMM(lmm_WY_NO3_Q)


lmm_WY_NH4_Q <- lmer(NH4_supply ~ WY_lab + (1|site) + (1|catch), data = covariat_WY)
summary(lmm_WY_NH4_Q)
#hist(residuals(lmm_WY_NH4_Q), main = paste(NULL))
r.squaredGLMM(lmm_WY_NH4_Q)

lmm_WY_demand_Q <- lmer(Ndemand ~ WY_lab + (1|site) + (1|catch), data = covariat_WY)
summary(lmm_WY_demand_Q)
#hist(residuals(lmm_WY_demand_Q),main = paste(NULL))
r.squaredGLMM(lmm_WY_demand_Q)

```

##### plots

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
GPP_plots <- ggplot(metab_plots_WY%>%filter(water_year<2024), aes(x = water_year, y = GPP, color = site, shape=site)) +
  geom_point(size = 4, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_line(position = position_dodge(width = 0.3))+
  geom_errorbar(aes(ymin =GPP-GPP_se, ymax = GPP+GPP_se),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic() + ylab(expression(GPP~(g~O[2]~m^-2~d^-1))) +
  xlab(NULL) + scale_color_manual(values = siteC_colors) +
  theme(legend.position =  "none") +
    scale_shape_manual(values = c(15,0,17,2)) +
    scale_x_continuous(breaks = seq(floor(min(nuts_plots_WY$water_year)), ceiling(max(nuts_plots_WY$water_year)), by = 1), labels = function(x) as.character(round(x)))

GPP_plots  

ER_plots <- ggplot(metab_plots_WY%>%filter(water_year<2024), aes(x = water_year, y = ER, color = site, shape=site)) +
  geom_point(size = 4, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_line(position = position_dodge(width = 0.3))+
  geom_errorbar(aes(ymin =ER-ER_se, ymax = ER+ER_se),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic() + ylab(expression(ER~(g~O[2]~m^-2~d^-1))) +
  xlab(NULL) + scale_color_manual(values = siteC_colors) +
    theme(legend.position =  "none") +
      scale_shape_manual(values = c(15,0,17,2)) +
    scale_x_continuous(breaks = seq(floor(min(nuts_plots_WY$water_year)), ceiling(max(nuts_plots_WY$water_year)), by = 1), labels = function(x) as.character(round(x)))

ER_plots  

```

```{r, warning=F, size = 'small', echo=F, include=FALSE,fig.width=6, fig.height=4}
# 
NO3_plots <- ggplot(nuts_plots_WY, aes(x = (water_year), y = NO3_supplym, color = site, shape=site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_line(position = position_dodge(width = 0.3))+
  geom_errorbar(aes(ymin=NO3_supplym-(NO3_supply_se), ymax = NO3_supplym+(NO3_supply_se)),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic() + ylab(expression(NO[3]~supply~(g~N~m^-2~d^-1))) +
  #ylim(0,50)+
  xlab(NULL) + scale_color_manual(values = siteC_colors) +
      scale_shape_manual(values = c(15,0,17,2)) +
      scale_x_continuous(breaks = seq(floor(min(nuts_plots_WY$water_year)), ceiling(max(nuts_plots_WY$water_year)), by = 1), labels = function(x) as.character(round(x)))


NH4_plots <- ggplot(nuts_plots_WY, aes(x = (water_year), y = NH4_supplym, color = site, shape=site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.1)) +
  geom_line(position = position_dodge(width = 0.1))+
  geom_errorbar(aes(ymin=NH4_supplym-NH4_supply_se, ymax = NH4_supplym+NH4_supply_se),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.1)) +
   # ylim(0,50)+
  theme_classic() + ylab(expression(NH[4]~supply~(g~N~m^-2~d^-1))) + # mg N m-2 day -1
  xlab(NULL) + scale_color_manual(values = siteC_colors) +
        scale_shape_manual(values = c(15,0,17,2)) +
        scale_x_continuous(breaks = seq(floor(min(nuts_plots_WY$water_year)), ceiling(max(nuts_plots_WY$water_year)), by = 1), labels = function(x) as.character(round(x)))
NH4_plots  

N_demand_plots <- ggplot(nuts_plots_WY, aes(x = (water_year), y = Ndemandm, color = site, shape=site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_line(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin =(Ndemandm-Ndemand_se), ymax = (Ndemandm+Ndemand_se)),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic() +   
  ylab(expression(Nitrogen~demand~(g~N~m^-2~d^-1))) +
 #ylim(0,300)+
          scale_shape_manual(values = c(15,0,17,2)) +
  xlab(NULL) + scale_color_manual(values = siteC_colors)  +
        scale_x_continuous(breaks = seq(floor(min(nuts_plots_WY$water_year)), ceiling(max(nuts_plots_WY$water_year)), by = 1), labels = function(x) as.character(round(x)))
N_demand_plots

```

### Figure 6: Average annual differences in GPP, ER, N-demand and N-supply by water year

Values averaged across March to October observations

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=8, fig.height=6}

WY_n_grid <- ggarrange(
  N_demand_plots,
  NO3_plots,
  NH4_plots,
  labels = c("c","d", "e"),
  ncol = 3, nrow = 1,
  common.legend = TRUE, 
  legend = "bottom")


### big grid 
WY_n_grid2 <- ggarrange(
  GPP_plots,
  ER_plots,
  ncol = 2, nrow = 1,
    labels = c("a","b"))


### big grid 
WY_n_grid3 <- ggarrange(
  WY_n_grid2,
  WY_n_grid,
  ncol = 1, nrow = 2,
  common.legend = TRUE, 
  legend = "bottom")

WY_n_grid3

```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/WY_n_grid_CH1.png", plot = WY_n_grid3, width = 8, height = 6.25, units = "in")

```

### Extra?

Relationship between Ut and n-demand? not really there.

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
names(covariat_nitrogen2)

plot(covariat_nitrogen2$Uadd_ug_L_min,covariat_nitrogen2$Ndemand)
cor.test(covariat_nitrogen2$Uadd_ug_L_min,covariat_nitrogen2$Ndemand)


U_temp_plt<-ggplot(covariat_nitrogen2, aes(x=Ndemand,  y = log(Uadd_ug_L_min+1), color =catch, shape=method)) + 
  geom_point(size=2, alpha=0.75) + 
  theme_classic() + 
  geom_smooth(method="lm")


covariat_WY <- covariat_datq %>%
    mutate(WY_lab = case_when(
    water_year %in% c(2021, 2022) ~ "dry",
    water_year %in% c(2023) ~ "wet",
    water_year %in% c(2024) ~ "normal",

    TRUE ~ NA_character_  
  )) %>%
  filter(Uadd_ug_L_min<120)


lmm_WY_Ut <- lmer(Uadd_ug_L_min ~ WY_lab + (1|site) + (1|catch), data = covariat_WY)
summary(lmm_WY_Ut)
#hist(residuals(lmm_WY_ER))
r.squaredGLMM(lmm_WY_Ut)

lmm_WY_Ut <- lmer(Uadd_ug_L_min ~ WY_lab + method + (1|site) + (1|catch), data = covariat_WY)
summary(lmm_WY_Ut)
#hist(residuals(lmm_WY_ER))
r.squaredGLMM(lmm_WY_Ut)

lmm_WY_Ut <- lmer(Uadd_ug_L_min ~ WY_lab + (1|site) + (1|catch), data = covariat_WY%>%filter(method=="NO3"))
summary(lmm_WY_Ut)
#hist(residuals(lmm_WY_ER))
r.squaredGLMM(lmm_WY_Ut)


lmm_WY_Ut <- lmer(Uadd_ug_L_min ~ WY_lab + (1|site) + (1|catch), data = covariat_WY%>%filter(method=="NH3"))
summary(lmm_WY_Ut)
#hist(residuals(lmm_WY_ER))
r.squaredGLMM(lmm_WY_Ut)



lmm_WY_sw <- lmer(sw_m ~ WY_lab + method + (1|site) + (1|catch), data = covariat_WY)
summary(lmm_WY_sw)
#hist(residuals(lmm_WY_sw))
r.squaredGLMM(lmm_WY_sw)

uptake_yr <- covariat_WY %>%
  group_by(site, method) %>%
  dplyr::summarise(
    Uadd_ug_L_min = mean(Uadd_ug_L_min, na.rm=T),
    sw_m = mean(sw_m, na.rm=T),
    vf = mean(vf, na.rm=T))
  

uptake_yr <- covariat_WY %>%
  group_by(method) %>%
  dplyr::summarise(
    Uadd_ug_L_min = mean(Uadd_ug_L_min, na.rm=T),
    sw_m = mean(sw_m, na.rm=T),
    vf = mean(vf, na.rm=T))

```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
(17.93211-10.89327)/17.93211

(0.001728073-0.001147727)/0.001728073

(34.78636-23.26239)/34.78636
```

### Correlations btwn GPP and other standing stock estiamtes of productivity

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

mod1 <- lmer(log(GPP_mean+1) ~ scale(AFDM_ugcm2) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)


mod1 <- lmer(log(GPP_mean+1) ~ scale(Chla_ugL_Q) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)

mod1 <- lmer(log(Chla_ugL_Q+1) ~ scale(AFDM_ugcm2) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)

mod1 <- lmer(log((ER_mean*-1)+1) ~ scale(AFDM_ugcm2) + (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)


mod1 <- lmer(log((ER_mean*-1)+1)  ~ scale(AFDM_mgg) + (1|site)+ (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)

mod1 <- lmer(log((ER_mean*-1)+1)  ~ scale(Chla_ugL_Q) +  (1|site) + (1|catch), data = covariat_datq)
summary(mod1)
#hist(residuals(mod1))
r.squaredGLMM(mod1)
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

BM_cor_plt <- ggplot(covariat_datq, aes(x = log(AFDM_ugcm2+1), y = log(GPP_mean+1))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
      geom_smooth(data = covariat_datq%>%filter(catch=="BW") , aes(color = "grey50"), method = "lm", se = FALSE, alpha = 0.5) + 
   ylab(expression(log(GPP+1)~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Biomass+1)~(µg~cm^-2))) +
  scale_color_manual(values = catch_colors)

BM_cor_plt1 <- ggplot(covariat_datq, aes(x = log(Chla_ugL_Q+1), y = log(GPP_mean+1))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
      geom_smooth(aes(color = "grey50"), method = "lm", se = FALSE, alpha = 0.5) + 
  ylab(expression(log(GPP+1)~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Chla+1)~(µg~L^-1))) +
  scale_color_manual(values = catch_colors)

BM_cor_plt2 <- ggplot(covariat_datq, aes(y = log(Chla_ugL_Q+1), x = log(AFDM_ugcm2+1))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
      geom_smooth(aes(color = "grey50"), method = "lm", se = FALSE, alpha = 0.5) + 
  theme_classic() + 
  xlab(expression(log(Biomass+1)~(µg~cm^-2))) +
  ylab(expression(log(Chla+1)~(µg~L^-1))) +
  scale_color_manual(values = catch_colors)


BM_cor_plt3 <- ggplot(covariat_datq, aes(x = log(AFDM_ugcm2+1), y = log((ER_mean*-1)+1))) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
  ylab(expression(log(abs(ER)+1)~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Biomass+1)~(µg~cm^-2))) +
  scale_color_manual(values = catch_colors)


BM_cor_plt4 <- ggplot(covariat_datq, aes(x = log(Chla_ugL_Q+1), y = log((ER_mean*-1))+1)) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
   # geom_smooth(aes(color = catch), method = "lm", se = FALSE, alpha = 0.5, lty="dashed") + 
    ylab(expression(log(abs(ER)+1)~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(Chla+1)~(µg~L^-1))) +
  scale_color_manual(values = catch_colors)


BM_cor_plt5 <- ggplot(covariat_datq, aes(x = log(AFDM_mgg+1), y = log((ER_mean*-1))+1)) + 
  geom_point(aes(color = catch), size = 2, alpha = 0.55) + 
  theme_classic() + 
    ylab(expression(log(abs(ER)+1)~(g~O[2]~m^-2~d^-1))) +
  xlab(expression(log(OM+1)~(mg~g^-1))) +
  scale_color_manual(values = catch_colors)

```

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=8, fig.height=7}
BP_grid <- ggarrange(
  BM_cor_plt,
  BM_cor_plt1,
  BM_cor_plt2,
  BM_cor_plt3,
  BM_cor_plt4,
  BM_cor_plt5,
  labels = c("a", "b", "c",
             "d", "e", "f"),
  ncol = 3, nrow = 2,
  common.legend = TRUE,
  legend = "right"
)

BP_grid
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/BP_grid_CH1.png", plot = BP_grid, width = 8.5, height = 4.75, units = "in")

```

### Looking at stoichiometeric ratios of N:P overtime?

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}

#summary(covariat_NS_ND)
#
# Stoich_df <- covariat_nitrogen2 %>%
#   mutate(
#     NO3_ugL = c(NO3_mgL_dl*1000),
#     NH4_ugL = c(NH4_mgL_dl*1000),
#     Tot_N_ugL = c(NO3_ugL+ NH4_ugL),
#     N_P_ugL = (Tot_N_ugL/PO4_ugL_dl))


Stoich_df <- covariat_nitrogen2 %>%
  mutate(
    jday= yday(date),
    NO3_uM = (NO3_mgL_dl * 1000) / 62.0049,  # Convert NO3 to µmol/L
    NH4_uM = (NH4_mgL_dl * 1000) / 18.0385,  # Convert NH4 to µmol/L
    PO4_uM = PO4_ugL_dl / 30.9738,  # Convert PO4 to µmol/L
    Tot_N_uM = NO3_uM + NH4_uM,  # Total nitrogen in µmol/L
    N_P_ratio = if_else(PO4_uM > 0, Tot_N_uM / PO4_uM, NA_real_)  # Avoid division by zero
  )
```

### N:P

Looks like N:P \<16 across all observations

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=9, fig.height=4}

N_P_ratio_plots <- ggplot(Stoich_df %>%filter(water_year<2024), aes(x = jday, y = N_P_ratio, color = site)) +
  geom_point(size = 2, alpha = 0.75, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = site_colors) +
   ylab(expression(N:P~(umol~L^-1))) +
     xlab("Day of year") +
  facet_grid(.~water_year) +
  theme_classic()

N_P_ratio_plots
```

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=5, fig.height=4}
N_P_ratio_plots <- ggplot(Stoich_df %>%filter(water_year<2024), aes(y = GPP_mean, x = N_P_ratio, color = site)) +
  geom_point(size = 2, alpha = 0.75, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = site_colors) +
   xlab(expression(N:P~(umol~L^-1))) +
  #facet_grid(.~water_year) +
  theme_classic()

N_P_ratio_plots
```

#### Statisical relationship?

Maybe? GPP and N:P are slightly negatively related. But falls apart when
both catchments are modeled independently

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=5, fig.height=4}

mod <- lmer((GPP_mean) ~ scale(N_P_ratio) + (1|catch), data = Stoich_df %>%filter(water_year<2024))
summary(mod)
#hist(residuals(mod), main = paste(NULL))
r.squaredGLMM(mod)

modb <- lmer((GPP_mean) ~ scale(N_P_ratio) + (1|site), data = Stoich_df %>%filter(water_year<2024 & catch=="BW"))
summary(modb)
#hist(residuals(modb), main = paste(NULL))
r.squaredGLMM(modb)


modg <- lmer((GPP_mean) ~ scale(N_P_ratio) + (1|site), data = Stoich_df %>%filter(water_year<2024 & catch=="GB"))
summary(modg)
#hist(residuals(modg), main = paste(NULL))
r.squaredGLMM(modg)
```

```{r, warning=F, size = 'small', echo=F, include=T, fig.width=5, fig.height=4}

N_P_ratio_plots <- ggplot(Stoich_df %>%filter(water_year<2024), aes(y = ER_mean, x = N_P_ratio, color = site)) +
  geom_point(size = 2, alpha = 0.75, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = site_colors) +
   xlab(expression(N:P~(umol~L^-1))) +
  #facet_grid(.~water_year) +
  theme_classic()

N_P_ratio_plots
```

#### Statisical relationship?

No

```{r, warning=F, size = 'small', echo=T, include=T, fig.width=5, fig.height=4}

mod1 <- lmer((ER_mean*-1) ~ scale(N_P_ratio) + (1|catch), data = Stoich_df %>%filter(water_year<2024))
summary(mod1)
#hist(residuals(mod1), main = paste(NULL))
r.squaredGLMM(mod1)
```

#### Table of mean N:P ratios by site

```{r, warning=F, size = 'small', echo=F, fig.width=5, fig.height=12}

Stoich_table <- Stoich_df %>%
  group_by(site)  %>%
  summarise(
    Tot_N_uMm = round(mean(Tot_N_uM, na.rm=T),3),
    N_P_ratiom = round(mean(N_P_ratio, na.rm=T),4),
    N_P_ratiomin = round(min(N_P_ratio, na.rm=T),4),
    N_P_ratiomax = round(max(N_P_ratio, na.rm=T),3),
    rangeNP = c(N_P_ratiomax-N_P_ratiomin)
)

Stoich_table
```

```{r, warning=F, size = 'small', echo=F, fig.width=5, include=FALSE,fig.height=4}

Stoich_plot <- Stoich_df %>%
  filter(water_year<2024) %>%
  group_by(site, water_year) %>%
  dplyr::summarise(
    Tot_N_uMm = round(mean(Tot_N_uM, na.rm = TRUE), 3),
    N_P_ratiom = round(mean(N_P_ratio, na.rm = TRUE), 4),
    N_P_sd = round(sd(N_P_ratio, na.rm = TRUE), 4),
    N_P_se = round(sd(N_P_ratio, na.rm = TRUE) / sqrt(sum(!is.na(N_P_ratio))), 4)  # Standard Error
  ) %>%
  mutate(
    N_P_sd = if_else(is.na(N_P_sd), N_P_ratiom, N_P_sd),  # Replace NA SD with mean
    N_P_se = if_else(is.na(N_P_se), 0, N_P_se)  # Replace NA SE with 0
  )


N_P_plots <- ggplot(Stoich_plot, aes(x = (water_year), y = N_P_ratiom, color = site, shape=site)) +
  geom_point(size = 3, alpha = 0.95, position = position_dodge(width = 0.3)) +
  geom_line(position = position_dodge(width = 0.3))+
  geom_errorbar(aes(ymin =N_P_ratiom-N_P_se, ymax = N_P_ratiom+N_P_se),  width = 0.05, height = 0, alpha = 0.75, position = position_dodge(width = 0.3)) +
  theme_classic() + ylab(expression(N:P~(µM~L^-1))) +
 #ylim(0,300)+
 scale_shape_manual(values = c(15,0,17,2)) +
  xlab(NULL) + scale_color_manual(values = siteC_colors)  +
        scale_x_continuous(breaks = seq(floor(min(nuts_plots_WY$water_year)), ceiling(max(nuts_plots_WY$water_year)), by = 1), labels = function(x) as.character(round(x)))
N_P_plots

```

## Moddified figure 6?

#### (3) How does in-stream productivity and nitrogen supply and demand dynamics change within stream catchments and across dry (2021 and 2022) and wet water years (2023)?


```{r, warning=F, size = 'small', echo=F, fig.width=7, fig.height=5}

WY_n_grid <- ggarrange(
  N_demand_plots,
  N_P_plots,
  NO3_plots,
  NH4_plots,
  labels = c("c","d","e", "f"),
  ncol = 4, nrow = 1,
  common.legend = TRUE, 
  legend = "bottom")


### big grid 
WY_n_grid2 <- ggarrange(
  GPP_plots,
  ER_plots,
  ncol = 2, nrow = 1,
    labels = c("a","b"))


# ### big grid 
# WY_n_grid3 <- ggarrange(
#   WY_n_grid2,
#   WY_n_grid,
#   ncol = 1, nrow = 2,
#   common.legend = TRUE, 
#   legend = "bottom")
# 
# WY_n_grid3



library(ggpubr)
library(cowplot)

# Create the top row with extra spacing on both sides
top_row <- ggdraw() + draw_plot(WY_n_grid2, x = 0.05, width = 0.95)  # Centered with 25% narrower width

# Arrange the plots
WY_n_grid3 <- plot_grid(
  top_row, WY_n_grid,
  ncol = 1, rel_heights = c(4, 5)  # Keeps the bottom row proportionally larger
)

# Display the plot
print(WY_n_grid3)


```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Figs/WY_n_grid_CH1_v2.png", plot = WY_n_grid3, width = 8.5, height = 5.25, units = "in")

```









### sand box:
Goals to get new window of productivity threholds to identify DOY of peak SWE (?), or peak melt (?) to day of baseflow 
Maybe get the number of days between peak incoming par and baseflow onset or peak par at surface across year 


#### Data resolution for DO obs and GPP

```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=1}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWL") %>%
  filter(!is.na(do.obs_m)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
      filter(site=="BWL") %>%
  filter(!is.na(GPP_mean)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Lower")
```




```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=1}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="BWU") %>%
  filter(!is.na(do.obs_m)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
      filter(site=="BWU") %>%
  filter(!is.na(GPP_mean)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt_BWU <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "BW Upper")
```




```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=1}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBL") %>%
  filter(!is.na(do.obs_m)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
      filter(site=="GBL") %>%
  filter(!is.na(GPP_mean)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt_GBL <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Lower")
```

```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=1}
# Filter the dataset to only include rows where do.obs_m or GPP_mean are not NA
plot_data_date <- covariat_datq %>%
  filter(!is.na(do.obs_m))

plot_data_DO <- covariat_datq %>%
    filter(site=="GBU") %>%
  filter(!is.na(do.obs_m)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

plot_data_GPP <- covariat_datq %>%
      filter(site=="GBU") %>%
  filter(!is.na(GPP_mean)) %>%
  select(date, do.obs_m, GPP_mean) %>%
  mutate(has_do = !is.na(do.obs_m), has_GPP = !is.na(GPP_mean))

# Determine the date range
date_range <- range(plot_data_date$date, na.rm = TRUE)

# Create the number line plot
templt_GBU <- ggplot(covariat_datq, aes(x = date)) +
  #geom_segment(aes(x = date_range[1], xend = date_range[2], y = 0, yend = 0), linewidth = 0.2) + # Main line
  geom_point(data = filter(plot_data_DO, has_do), aes(y = 0.095), alpha=0.3, color = "black", size = 1) + # DO presence tick marks
  geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.090), alpha= 0.3, color = "#579467", size = 1) + # GPP presence tick marks
    geom_point(data = filter(plot_data_GPP, has_GPP), aes(y = 0.085), alpha= 0.02, color = "#fffcfd", size = 1) + # GPP presence tick marks

  scale_x_date(date_breaks = "3 months", date_labels = "%b-%y",  limits = date_range) +  # Labels every 2 months
  scale_y_continuous(name = "", breaks = NULL) +
  theme_classic() + xlab(NULL) +
    labs(title = "GB Upper",
       caption = "Black: DO Observed | Green: GPP Mean")
```


```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=4.5}
### big grid 
WY_n_grid2 <- ggarrange(
  templt,
  templt_BWU,
  templt_GBL,
  templt_GBU,
  ncol = 1, nrow = 4)
```

```{r, warning=F, size = 'small', echo=F, include=F, fig.width=6, fig.height=4}
# ggsave("/Users/kellyloria/Documents/Publications/CH1\ biogeochem\ linkages/Sup_Figures/metab_dat_resolution.png", plot = WY_n_grid2, width = 8.25, height = 4.25, units = "in")

```




```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=8}

TS_plot <- ggplot(covariat_datq%>%mutate(DOY=yday(date))%>%filter(site=="BWL")%>%filter(water_year<2024), aes(x = DOY, y = PAR_surface, color =as.factor(water_year), shape = site)) +
  geom_point(size = 2, alpha = 0.5, position = position_dodge(width = 0.3)) +
 # geom_line(aes(x = DOY, y=PAR_inc )) +
    geom_line(aes(x = DOY, y=(Q_m*100))) +
 scale_color_viridis_d(option = "viridis") +
  geom_point(size = 2, alpha = 0.7) +
  #scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
  ylab(expression(PAR~at~stream~surface~(mu~mol~m^-2~s^-1))) +
  theme_classic() + facet_grid(site~.)

TS_plot



TS_plot <- ggplot(covariat_datq%>%filter(water_year<2024), aes(x = Q_m, y = GPP_mean, color =as.factor(water_year), shape = site)) +
  geom_point(size = 2, alpha = 0.5, position = position_dodge(width = 0.3)) +
 # geom_line(aes(x = DOY, y=PAR_inc )) +
 #scale_color_viridis_d(option = "viridis") +
  geom_point(size = 2, alpha = 0.7) +
  #scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
  #ylab(expression(PAR~at~stream~surface~(mu~mol~m^-2~s^-1))) +
  theme_classic() + facet_grid(site~.)

TS_plot
```

```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=8}

covariat_datq_BWL_na <- covariat_datq %>%
  filter(site=="BWL") %>%
  drop_na(GPP_mean)
# max flow: 2.76302
# 3rd q: 0.18728
# mean q: 0.23213

covariat_datq_BWU_na <- covariat_datq %>%
    filter(site=="BWU") %>%
  drop_na(GPP_mean)

# max flow: 5.989955
# 3rd q: 0.278157
# mean q: 0.665920



covariat_datq_GBL_na <- covariat_datq %>%
    filter(site=="GBL") %>%
  drop_na(GPP_mean)

# max flow: 0.62202
# 3rd q: 0.03807
# mean q: 0.04228


covariat_datq_GBU_na <- covariat_datq %>%
    filter(site=="GBU") %>%
  drop_na(GPP_mean)

# max flow: 0.298702
# 3rd q: 0.037678
# mean q: 0.029493

summary(covariat_datq_GBU_na)

```











```{r, warning=F, size = 'small', echo=T, fig.width=10, fig.height=8}

## return DOY
sandbox <- covariat_datq %>%
  group_by(site, water_year) %>%
  summarise(
    max_surf_par = max(PAR_surface, na.rm = T),
    max_Q_m = max(Q_m, na.rm = T))



# summarize_peak_SWE_date <- function(data) {
#   data %>%
#     filter(lubridate::month(date) >= 1 & lubridate::month(date) <= 6) %>%
#     arrange(site, date) %>%
#     group_by(site, WaterYear = lubridate::year(date) + if_else(lubridate::month(date) < 10, 0, 1)) %>%
#     summarize(
#       peak_SWE_date = date[which.max(snow_water_equivalent)],
#       peak_SWE_day_of_year = lubridate::yday(date[which.max(snow_water_equivalent)]),
#       max_SWE = max(snow_water_equivalent)
#     ) %>%
#     ungroup()
# }
# 
# summarize_transition_to_zero <- function(data) {
#   data %>%
#     filter(lubridate::month(date) >= 4 & lubridate::month(date) <= 7) %>%
#     arrange(site, date) %>%
#     group_by(site, WaterYear = lubridate::year(date) + if_else(lubridate::month(date) < 10, 0, 1)) %>%
#     summarize(
#       transition_to_zero = date[which.max(
#         (daily_delta_SWE == 0 & lead(daily_delta_SWE == 0, default = FALSE) &
#          lead(daily_delta_SWE == 0, n = 8, default = FALSE) &
#          lag(daily_delta_SWE, default = 0) == 0) &
#          (lead(daily_delta_SWE == 0, n = 8) & lag(daily_delta_SWE == 0, n = 5))
#       )],
#       .groups = 'drop',
#       trans_day_of_year = lubridate::yday(transition_to_zero),
#     ) %>%
#     filter(!is.na(transition_to_zero))
# }
# 
# summarize_peak_SPflow_date <- function(data) {
#   data %>%
#     filter(lubridate::month(date) >= 2 & lubridate::month(date) <= 8) %>%
#     dplyr::group_by(site, WaterYear = lubridate::year(date) + if_else(lubridate::month(date) < 10, 0, 1)) %>%
#     dplyr::summarize(
#       peak_SPFlow_date = date[which.max(scale_Q)],  # Date of the highest scale_Q
#       peak_flow_day_of_year = lubridate::yday(date[which.max(scale_Q)]),  # DOY of the highest scale_Q
#       max_SPFlow = max(scale_Q)  # Maximum scale_Q for the given year
#     ) %>%
#     ungroup()
# }


sum_peak_Q <- function(data) {
  data %>%
    arrange(site, date) %>%
    group_by(site, water_year) %>%
    ## filter for spring runoff
    mutate(mon = month(date))%>%
    filter(mon >1 & mon <8) %>%
    summarize(
      peak_Q_date = date[which.max(Q_m)],
      peak_Q_day_of_year = lubridate::yday(date[which.max(Q_m)]),
      max_Q = max(Q_m, na.rm=T)
    ) %>%
    ungroup()
}


summarize_peak_SWE_date <- function(data) {
  data %>%
    filter(lubridate::month(date) >= 1 & lubridate::month(date) <= 6) %>%
    arrange(site, date) %>%
    group_by(site, WaterYear = lubridate::year(date) + if_else(lubridate::month(date) < 10, 0, 1)) %>%
    summarize(
      peak_SWE_date = date[which.max(snow_water_equivalent)],
      peak_SWE_day_of_year = lubridate::yday(date[which.max(snow_water_equivalent)]),
      max_SWE = max(snow_water_equivalent)
    ) %>%
    ungroup()
}

sum_par <- sum_peak_SUR_PAR(covariat_datq)

sum_Q_df <- sum_peak_Q(covariat_datq)

joint_WY<- sum_Q_df %>%
left_join(sum_par, by=c("site", "water_year"))


TS_plot <- ggplot(joint_WY%>%filter(water_year<2024), aes(y = peak_Q_day_of_year, x = max_PAR, color =as.factor(water_year), shape = site)) +
  geom_point(size = 2, alpha = 0.5, position = position_dodge(width = 0.3)) +
 # geom_line(aes(x = DOY, y=PAR_inc )) +
 scale_color_viridis_d(option = "viridis") +
  geom_point(size = 2, alpha = 0.7) +
  #scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
  theme_classic() + facet_grid(site~.)

TS_plot




TS_plot <- ggplot(joint_WY%>%filter(water_year<2024), aes(y = peak_Q_day_of_year, x = max_PAR, color =as.factor(water_year), shape = site)) +
  geom_point(size = 2, alpha = 0.5, position = position_dodge(width = 0.3)) +
 # geom_line(aes(x = DOY, y=PAR_inc )) +
 scale_color_viridis_d(option = "viridis") +
  geom_point(size = 2, alpha = 0.7) +
  #scale_color_manual(values = siteC_colors) +
  scale_shape_manual(values = c(15, 0, 17, 2)) +
  theme_classic() + facet_grid(site~.)

TS_plot



plot()

```
